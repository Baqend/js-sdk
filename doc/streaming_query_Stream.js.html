<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Baqend JavaScript SDK 2.4.0 - Source: streaming/query/Stream.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap-baqend.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="/"><img src="img/baqend_logo.svg"></a>
        </div>

        <!-- Expanded navigation -->
        <div id="nav" class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
                <li>
                    <a href="http://www.baqend.com/guide/index.html">Guide</a>
                </li>
                <li class="active">
                    <a href="baqend.html">JS API</a>
                </li>
                <li>
                    <a href="http://www.baqend.com/#tutorial">Tutorial</a>
                </li>
                <li>
                    <a href="http://dashboard.baqend.com/">Dashboard</a>
                </li>
                <li>
                    <a href="https://community.baqend.com/">Community <span class="visible-lg-inline">Forum</span></a>
                </li>
            </ul>
        </div>
    </div>
</nav>


<div class="container">
  <div class="row">
    <div class="col-md-3">
        <div class="bs-sidebar hidden-print fixed affix" role="complementary">
            <input class="filter form-control input-sm" type="text" placeholder="FILTER"/>

            <ul class="nav bs-sidenav">
            
            
                
                    
                        <li class=""><a href="Acl.html" class="nav-name">Acl</a></li>
                    
                        <li class=""><a href="EntityManager.html" class="nav-name">EntityManager</a></li>
                    
                        <li class=""><a href="EntityManagerFactory.html" class="nav-name">EntityManagerFactory</a></li>
                    
                        <li class=""><a href="EntityTransaction.html" class="nav-name">EntityTransaction</a></li>
                    
                        <li class=""><a href="GeoPoint.html" class="nav-name">GeoPoint</a></li>
                    
                        <li class=""><a href="StreamingEvent.html" class="nav-name">StreamingEvent</a></li>
                    
                        <li class=""><a href="baqend.html" class="nav-name">baqend</a></li>
                    
                
            
                
                    <li class="">
                        <a href="binding.html" class="nav-name">binding</a>
                        <ul class="nav">
                          
                            <li class=""><a href="binding.Accessor.html" class="nav-name">Accessor</a></li>
                          
                            <li class=""><a href="binding.DeviceFactory.html" class="nav-name">DeviceFactory</a></li>
                          
                            <li class=""><a href="binding.Enhancer.html" class="nav-name">Enhancer</a></li>
                          
                            <li class=""><a href="binding.Entity.html" class="nav-name">Entity</a></li>
                          
                            <li class=""><a href="binding.EntityFactory.html" class="nav-name">EntityFactory</a></li>
                          
                            <li class=""><a href="binding.Factory.html" class="nav-name">Factory</a></li>
                          
                            <li class=""><a href="binding.File.html" class="nav-name">File</a></li>
                          
                            <li class=""><a href="binding.FileFactory.html" class="nav-name">FileFactory</a></li>
                          
                            <li class=""><a href="binding.Managed.html" class="nav-name">Managed</a></li>
                          
                            <li class=""><a href="binding.ManagedFactory.html" class="nav-name">ManagedFactory</a></li>
                          
                            <li class=""><a href="binding.Role.html" class="nav-name">Role</a></li>
                          
                            <li class=""><a href="binding.User.html" class="nav-name">User</a></li>
                          
                            <li class=""><a href="binding.UserFactory.html" class="nav-name">UserFactory</a></li>
                          
                        </ul>
                    </li>
                
            
                
                    <li class="">
                        <a href="caching.html" class="nav-name">caching</a>
                        <ul class="nav">
                          
                            <li class=""><a href="caching.BloomFilter.html" class="nav-name">BloomFilter</a></li>
                          
                        </ul>
                    </li>
                
            
                
                    <li class="">
                        <a href="connector.html" class="nav-name">connector</a>
                        <ul class="nav">
                          
                            <li class=""><a href="connector.Connector.html" class="nav-name">Connector</a></li>
                          
                            <li class=""><a href="connector.IFrameConnector.html" class="nav-name">IFrameConnector</a></li>
                          
                            <li class=""><a href="connector.Message.html" class="nav-name">Message</a></li>
                          
                            <li class=""><a href="connector.NodeConnector.html" class="nav-name">NodeConnector</a></li>
                          
                            <li class=""><a href="connector.WebSocketConnector.html" class="nav-name">WebSocketConnector</a></li>
                          
                            <li class=""><a href="connector.XMLHttpConnector.html" class="nav-name">XMLHttpConnector</a></li>
                          
                        </ul>
                    </li>
                
            
                
                    <li class="">
                        <a href="error.html" class="nav-name">error</a>
                        <ul class="nav">
                          
                            <li class=""><a href="error.CommunicationError.html" class="nav-name">CommunicationError</a></li>
                          
                            <li class=""><a href="error.EntityExistsError.html" class="nav-name">EntityExistsError</a></li>
                          
                            <li class=""><a href="error.IllegalEntityError.html" class="nav-name">IllegalEntityError</a></li>
                          
                            <li class=""><a href="error.PersistentError.html" class="nav-name">PersistentError</a></li>
                          
                            <li class=""><a href="error.RollbackError.html" class="nav-name">RollbackError</a></li>
                          
                        </ul>
                    </li>
                
            
                
                    <li class="">
                        <a href="metamodel.html" class="nav-name">metamodel</a>
                        <ul class="nav">
                          
                            <li class=""><a href="metamodel.Attribute.html" class="nav-name">Attribute</a></li>
                          
                            <li class=""><a href="metamodel.BasicType.html" class="nav-name">BasicType</a></li>
                          
                            <li class=""><a href="metamodel.CollectionAttribute.html" class="nav-name">CollectionAttribute</a></li>
                          
                            <li class=""><a href="metamodel.DbIndex.html" class="nav-name">DbIndex</a></li>
                          
                            <li class=""><a href="metamodel.EmbeddableType.html" class="nav-name">EmbeddableType</a></li>
                          
                            <li class=""><a href="metamodel.EntityType.html" class="nav-name">EntityType</a></li>
                          
                            <li class=""><a href="metamodel.ListAttribute.html" class="nav-name">ListAttribute</a></li>
                          
                            <li class=""><a href="metamodel.ManagedType.html" class="nav-name">ManagedType</a></li>
                          
                            <li class=""><a href="metamodel.MapAttribute.html" class="nav-name">MapAttribute</a></li>
                          
                            <li class=""><a href="metamodel.Metamodel.html" class="nav-name">Metamodel</a></li>
                          
                            <li class=""><a href="metamodel.ModelBuilder.html" class="nav-name">ModelBuilder</a></li>
                          
                            <li class=""><a href="metamodel.PluralAttribute.html" class="nav-name">PluralAttribute</a></li>
                          
                            <li class=""><a href="metamodel.SetAttribute.html" class="nav-name">SetAttribute</a></li>
                          
                            <li class=""><a href="metamodel.SingularAttribute.html" class="nav-name">SingularAttribute</a></li>
                          
                            <li class=""><a href="metamodel.Type.html" class="nav-name">Type</a></li>
                          
                        </ul>
                    </li>
                
            
                
                    <li class="">
                        <a href="model.html" class="nav-name">model</a>
                        <ul class="nav">
                          
                            <li class=""><a href="model.Device.html" class="nav-name">Device</a></li>
                          
                            <li class=""><a href="model.Role.html" class="nav-name">Role</a></li>
                          
                            <li class=""><a href="model.User.html" class="nav-name">User</a></li>
                          
                        </ul>
                    </li>
                
            
                
                    <li class="">
                        <a href="query.html" class="nav-name">query</a>
                        <ul class="nav">
                          
                            <li class=""><a href="query.Builder.html" class="nav-name">Builder</a></li>
                          
                            <li class=""><a href="query.Condition.html" class="nav-name">Condition</a></li>
                          
                            <li class=""><a href="query.Filter.html" class="nav-name">Filter</a></li>
                          
                            <li class=""><a href="query.Node.html" class="nav-name">Node</a></li>
                          
                            <li class=""><a href="query.Operator.html" class="nav-name">Operator</a></li>
                          
                            <li class=""><a href="query.Query.html" class="nav-name">Query</a></li>
                          
                            <li class=""><a href="query.Stream.html#.parseOptions" class="nav-name">Stream</a></li>
                          
                        </ul>
                    </li>
                
            
                
                    <li class="">
                        <a href="util.html" class="nav-name">util</a>
                        <ul class="nav">
                          
                            <li class=""><a href="util.Code.html" class="nav-name">Code</a></li>
                          
                            <li class=""><a href="util.Lockable.html" class="nav-name">Lockable</a></li>
                          
                            <li class=""><a href="util.Logger.html" class="nav-name">Logger</a></li>
                          
                            <li class=""><a href="util.Metadata.html" class="nav-name">Metadata</a></li>
                          
                            <li class=""><a href="util.Modules.html" class="nav-name">Modules</a></li>
                          
                            <li class=""><a href="util.Permission.html" class="nav-name">Permission</a></li>
                          
                            <li class=""><a href="util.PushMessage.html" class="nav-name">PushMessage</a></li>
                          
                            <li class=""><a href="util.TokenStorage.html" class="nav-name">TokenStorage</a></li>
                          
                            <li class=""><a href="util.ValidationResult.html" class="nav-name">ValidationResult</a></li>
                          
                            <li class=""><a href="util.Validator.html" class="nav-name">Validator</a></li>
                          
                            <li class=""><a href="util.TokenStorageFactory.html" class="nav-name">TokenStorageFactory</a></li>
                          
                        </ul>
                    </li>
                
            
            </ul>
        </div>
    </div>
    <div class="col-md-9" id="main">
      <h1 class="page-title">Source: streaming/query/Stream.js</h1>

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
var Metadata = require('../../lib/util/Metadata');
var WebSocketConnector = require('../connector/WebSocketConnector');
var Observable;

try {
  Observable = require('rxjs/Observable').Observable;
} catch (e) {
  if (typeof Rx !== 'undefined') {
    Observable = Rx.Observable;
  } else {
    throw e;
  }
}

/**
 * @alias query.Stream&lt;T>
 */
class Stream {

  /**
   * Returns an RxJS observable.
   *
   * @returns {Observable&lt;T>} an RxJS observable
   */
  observable() {
    return Observable.create(observer => {
      var callback = (e) => {
        if (e.matchType === 'error') {
          observer.error(e);
        } else {
          observer.next(e);
        }
      };

      this.on(this.query.matchTypes, callback);
      return () => {
        this.off(this.query.matchTypes, callback);
      };
    });
  }

  /**
   * @param {EntityManager} entityManager The owning entity manager of this query
   * @param {string} bucket The Bucket on which the streaming query is performed
   * @param {string} query The serialized query
   * @param {Object} options an object containing parameters
   * @param {string} sort the sort string
   * @param {number} limit the count, i.e. the number of items in the result
   * @param {number} offset offset, i.e. the number of items to skip
   * @param {query.Node&lt;T>} target the target of the stream
   */
  constructor(entityManager, bucket, query, options, sort, limit, offset, target) {
    var verifiedOptions = Stream.parseOptions(options);
    this.entityManager = entityManager;
    this.query = {
      bucket: bucket,
      matchTypes: verifiedOptions.matchTypes,
      operations: verifiedOptions.operations,
      initial: verifiedOptions.initial,
      query: query,
      sort: sort,
      start: offset,
      count: limit
    };
    this.callbacks = [];
    this.topic = Stream.getTopic(this.query.bucket, this.query.query, this.query.start, this.query.count, this.query.sort, this.query.matchTypes, this.query.operations);
    this.target = target;
    this.socket = WebSocketConnector.create(entityManager._connector);
  }


  on(matchTypes, callback) {
    var wrappedCallback = this._wrapQueryCallback(callback);
    this.socket.subscribe(this.topic, wrappedCallback);

    var queryMessage = {
      register: true,
      topic: this.topic,
      query: this.query
    };

    if (this.query.initial === true) {
      queryMessage.fromstart = true;
    }

    this.socket.sendOverSocket(queryMessage);

    this.callbacks.push({
      matchTypes: matchTypes,
      callback: callback,
      topic: this.topic,
      wrappedCallback: wrappedCallback,
      queryMessage: queryMessage
    });
  }

  static getCachableQueryString(query, start, count, sort) {
    var queryID = query;
    if (Stream.isEmptyJSONString(query)) {
      queryID = "{}";
    }
    if (start > 0) {
      queryID += "&amp;start=" + start;
    }
    if (count > 0) {
      queryID += "&amp;count=" + count;
    }
    if (!Stream.isEmptyJSONString(sort)) {
      queryID += "&amp;sort=" + sort;
    }
    return queryID;
  }

  static getTopic(bucket, query, start, count, sort, matchTypes, operations) {
    return [bucket, Stream.getCachableQueryString(query, start, count, sort), Stream.normalizeMatchTypes(matchTypes).join("_"), Stream.normalizeOperations(operations).join("_")].join("/");
  }

  static isEmptyJSONString(string) {
    return string === undefined || string === null || /^\s*(\{\s*\})?\s*$/.test(string);
  }

  /**
   * Valid options are:
   &lt;ul>
   &lt;li>initial: a Boolean indicating whether or not the initial result set should be delivered on creating the subscription&lt;/li>
   &lt;li>matchTypes: a list of match types&lt;/li>
   &lt;li>operations: a list of operations&lt;/li>
   &lt;li>&lt;/li>
   &lt;/ul>
   *
   *
   * @param {Object} provided object containing options
   * @returns {Object} an object containing VALID options
   */
  static parseOptions(provided) {
    var verified = {
      matchTypes: ['all'],
      operations: ['any']
    };

    if (provided) {
      if (provided.initial !== null &amp;&amp; provided.initial !== undefined) {
        if (typeof(provided.initial) === "boolean") {
          verified.initial = provided.initial;
        } else {
          throw new Error('Option "initial" only permits Boolean values!');
        }
      }

      if (provided.matchTypes) {
        if (Array.isArray(provided.matchTypes)) {
          verified.matchTypes = provided.matchTypes;
        } else {
          verified.matchTypes = [provided.matchTypes];
        }

        verified.matchTypes = Stream.normalizeMatchTypes(verified.matchTypes);
      }

      if (provided.operations) {
        if (Array.isArray(provided.operations)) {
          verified.operations = provided.operations;
        } else {
          verified.operations = [provided.operations];
        }

        verified.operations = Stream.normalizeOperations(verified.operations);
      }

      if (verified.matchTypes.indexOf('all') == -1 &amp;&amp; verified.operations.indexOf('any') == -1) {
        throw new Error('Only subscriptions for either operations or matchTypes are allowed. You cannot subscribe to a query using matchTypes and operations at the same time!');
      }
    }

    // Apply default values if missing
    if (verified.initial === null || verified.initial === undefined) {
      verified.initial = true;
    }

    if (!verified.matchTypes) {
      verified.matchTypes = ['all'];
    }

    if (!verified.operations) {
      verified.operations = ['any'];
    }

    return verified;
  }

  static normalizeMatchTypes(list) {
    return Stream.normalizeSortedSet(list, 'all', "match types", ['add', 'change', 'changeIndex', 'match', 'remove']);
  }

  static normalizeOperations(list) {
    return Stream.normalizeSortedSet(list, 'any', "operations", ['delete', 'insert', 'none', 'update']);
  }

  static normalizeSortedSet(list, wildcard, itemType, allowedItems) {
    if (!list || list.length == 0) {//undefined or empty list --> default value
      return undefined;
    }

    // sort, remove duplicates and check whether all values are allowed
    list.sort();
    var item;
    var lastItem = undefined;
    for (var i = list.length - 1; i >= 0; i--) {
      item = list[i];
      if (!item) {//undefined and null item in the list --> invalid!
        throw new Error('undefined and null not allowed!');
      }
      if (item === lastItem) {//remove duplicates
        list.splice(i, 1);
      }
      if (item === wildcard) {
        return [wildcard];
      }
      if (allowedItems.indexOf(item) == -1) {//raise error on invalid elements
        throw new Error(item + ' not allowed for ' + itemType + '! (permitted: ' + allowedItems + '.)');
      }
      lastItem = item;
    }

    return list;
  }

  off(matchTypes, callback) {
    this.callbacks = this.callbacks.reduce((keep, el) => {
      if ((!callback || el.callback == callback) &amp;&amp; (!matchTypes || el.matchTypes == matchTypes)) {
        this.socket.unsubscribe(el.topic, el.wrappedCallback);
        el.queryMessage.register = false;
        this.socket.sendOverSocket(el.queryMessage);
      } else {
        keep.push(el);
      }
      return keep;
    }, []);
  }

  _wrapQueryCallback(cb) {
    return function(msg) {
      msg.query = this.query;

      if (msg.result) { //Initial result received
        var basicMatch = {matchType: "add", operation: 'none'};
        var index = 0;
        msg.result.forEach((obj)=> {
          var entity = this._createObject(obj, false);
          if (msg.ordered) {
            basicMatch.index = index++;
          }
          var callback = this.createCallback(msg, basicMatch, entity, true);
          cb(callback);
        }, this);
      }
      if (msg.match) {
        //Single Match received, hollow object for deletes
        var obj = msg.match.object;
        var entity = this._createObject(obj, msg.match.operation === "delete");
        //Call wrapped callback
        var callback = this.createCallback(msg, msg.match, entity, false);
        cb(callback);
      }
    }.bind(this);
  }

  createCallback(msg, match, entity, init) {
    var matchEvent = {
      matchType: match.matchType,
      operation: match.operation,
      data: entity,
      date: new Date(msg.date),
      target: this.target,
      initial: init
    };
    if (match.index !== undefined) {
      matchEvent.index = match.index;
    }
    return matchEvent;
  }

  _createObject(object, objectWasDeleted) {
    var entity;
    if (object) {
      entity = this.entityManager.getReference(object.id);
      if (entity.version &lt; object.version || objectWasDeleted) {
        var metadata = Metadata.get(entity);
        if (objectWasDeleted) {
          metadata.setRemoved();
        } else {
          metadata.setJson(object);
          metadata.setPersistent();
        }
      }
    }
    return entity;
  }
}

module.exports = Stream;</code></pre>
        </article>
    </section>





      <footer>
        Baqend JavaScript SDK 2.4.0 &copy 2015 Baqend GmbH<br>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Tue, 08 Nov 2016 18:26:33 GMT
      </footer>
    </div>
  </div>
</div>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
<script src="scripts/filter.js"> </script>
</body>
</html>
