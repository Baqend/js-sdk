/*! baqend 0.10.4 | Copyright (c) 2015 Baqend GmbH | MIT */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.DB=a()}}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return e(c?c:b)},k,k.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){var c=a("./message"),d=a("./error"),e=(a("./binding"),a("./util")),f=a("./EntityTransaction"),g=a("./Query"),h=a("./util/Metadata"),i=a("./connector/Message"),j=i.StatusCode,k=Object.inherit(e.Lockable,{List:a("./collection").List,Set:a("./collection").Set,Map:a("./collection").Map,GeoPoint:a("./GeoPoint"),entityManagerFactory:null,metamodel:null,code:null,modules:null,log:null,_connector:null,_entities:null,get isOpen(){return!!this._connector},token:null,me:null,isDeviceRegistered:!1,isGlobal:!1,constructor:function(a,b){this.entityManagerFactory=a,this.metamodel=a.metamodel,this.code=a.code,this.isGlobal=!!b,this.log=e.Logger.create(this)},connected:function(a){if(this._connector=a,this._entities={},this._createObjectFactory(this.metamodel.embeddables),this._createObjectFactory(this.metamodel.entities),this.transaction=new f(this),this.modules=new e.Modules(this,a),this.isGlobal){var b=new c.Me;return b.withAuthorizationToken(),Promise.all([this.checkDeviceRegistration(),this._userRequest(b,!0)])}},_createObjectFactory:function(a){Object.keys(a).forEach(function(a){var b=this.metamodel.managedType(a),c=b.name;this[c]?(b.typeConstructor=this[c],Object.defineProperty(this,c,{value:b.createObjectFactory(this)})):Object.defineProperty(this,c,{get:function(){return Object.defineProperty(this,c,{value:b.createObjectFactory(this)}),this[c]},set:function(a){b.typeConstructor=a},configurable:!0})},this)},_sendOverSocket:function(a){a.token=this.token,this._connector.sendOverSocket(a)},_subscribe:function(a,b){this._connector.subscribe(a,b)},_unsubscribe:function(a,b){this._connector.unsubscribe(a,b)},_send:function(a){return a.withAuthorizationToken(this.isGlobal?null:this.token),this._connector.send(a).then(function(){var b=a.getAuthorizationToken();return b&&(this.token=b),a}.bind(this))},getReference:function(a,b){var c,d;b?(d=this.metamodel.entity(a),c=0==b.indexOf("/db/")?b:d.ref+"/"+encodeURIComponent(b)):(c=a,d=this.metamodel.entity(c.substring(0,c.indexOf("/",4))));var e=this._entities[c];if(!e){e=d.create();var f=h.get(e);f.id=c,f.setUnavailable(),this._attach(e)}return e},createQueryBuilder:function(a){return new g.Builder(this,a)},clear:function(){this._entities={}},close:function(){return this._connector=null,this.clear()},contains:function(a){return!!a&&this._entities[a.id]===a},containsById:function(a){return!(!a||!this._entities[a.id])},detach:function(a){var b=h.get(a);return b.withLock(function(){return this.removeReference(a),Promise.resolve(a)}.bind(this))},resolveDepth:function(a,b){if(!b||!b.depth)return Promise.resolve(a);b.resolved=b.resolved||[];var c=[],d=Object.extend({},b);return d.depth=b.depth===!0?!0:b.depth-1,this.getSubEntities(a,1).forEach(function(a){null==a||~b.resolved.indexOf(a)||(b.resolved.push(a),c.push(this.load(a.id,null,d)))}.bind(this)),Promise.all(c).then(function(){return a})},load:function(a,b,d){d=d||{};var e=this.getReference(a,b),f=h.get(e),g=new c.GetObject(f.bucket,f.key);return(f.version||d.refresh)&&g.setIfNoneMatch(d.refresh?"":f.version),this._send(g).then(function(a){return a.response.status!=j.NOT_MODIFIED&&f.setJson(a.response.entity),f.setPersistent(),this.resolveDepth(e,d)}.bind(this),function(a){if(a.status==j.OBJECT_NOT_FOUND)return this.removeReference(e),f.setRemoved(),null;throw a}.bind(this))},insert:function(a,b){b=b||{};var e;return this._save(a,b,function(a){if(a.version)throw new d.PersistentError("Existing objects can't be inserted.");return e=!a.id,new c.CreateObject(a.bucket,a.getJson())}).then(function(b){return e&&this._attach(a),b}.bind(this))},update:function(a,b){return b=b||{},this._save(a,b,function(a){if(!a.version)throw new d.PersistentError("New objects can't be inserted.");if(b.force){var e=new c.ReplaceObject(a.bucket,a.key,a.getJson(!0));return e.setIfMatch("*"),e}return e=new c.ReplaceObject(a.bucket,a.key,a.getJson(!1)),e.setIfMatch(a.version),e})},save:function(a,b){return b=b||{},this._save(a,b,function(a){if(b.force){if(!a.id)throw new d.PersistentError("New special objects can't be forcedly saved.");return new c.ReplaceObject(a.bucket,a.key,a.getJson(!0))}if(a.version){var e=new c.ReplaceObject(a.bucket,a.key,a.getJson(!1));return e.setIfMatch(a.version),e}return new c.CreateObject(a.bucket,a.getJson())})},optimisticSave:function(a,b){var c=!1,d=function(){c=!0},e=Promise.resolve(b(a,d));return c?Promise.resolve(a):e.then(function(){return a.save()["catch"](function(c){if(412==c.status)return this.refresh(a).then(function(){return this.optimisticSave(a,b)}.bind(this));throw c}.bind(this))}.bind(this))},_save:function(a,b,c){this.attach(a);var d=h.get(a);return d.withLock(function(){var e;if(d.isDirty){b.refresh||d.setPersistent();var f=this._send(c(d)).then(function(c){return b.refresh?(d.setJson(c.response.entity),d.setPersistent()):d.setJsonMetadata(c.response.entity),a}.bind(this),function(b){if(b.status==j.OBJECT_NOT_FOUND)return this.removeReference(a),d.setRemoved(),null;throw d.setDirty(),b}.bind(this));e=[f]}else e=[Promise.resolve(a)];var g=Object.extend({},b);return g.depth=0,this.getSubEntities(a,b.depth).forEach(function(a){e.push(this._save(a,g,c))}.bind(this)),Promise.all(e).then(function(){return a})}.bind(this))},getSubEntities:function(a,b,c,d){if(c=c||[],!b)return c;d=d||a;for(var e=h.get(a),f=e.type.references(),g=f.next();!g.done;g=f.next())this.getSubEntitiesByPath(a,g.value.path).forEach(function(a){~c.indexOf(a)||a==d||(c.push(a),c=this.getSubEntities(a,b===!0?b:b-1,c,d))}.bind(this));return c},getSubEntitiesByPath:function(a,b){var c=[a];return b.forEach(function(a){var b=[];c.forEach(function(c){var d=c[a];if(d){var e=this.metamodel.managedType(c.constructor).getAttribute(a);if(e.isCollection)for(var f,g=d.entries();!(f=g.next()).done;)b.push(f.value[1]),e.keyType&&e.keyType.isEntity&&b.push(f.value[0]);else b.push(d)}}.bind(this)),c=b}.bind(this)),c},"delete":function(a,b){b=b||{},this.attach(a);var e=h.get(a);return e.withLock(function(){if(!e.version&&!b.force)throw new d.IllegalEntityError(a);var f=new c.DeleteObject(e.bucket,e.key);b.force||f.setIfMatch(e.version);var g=[this._send(f).then(function(){return this.removeReference(a),e.setRemoved(),a}.bind(this))],h=Object.extend({},b);return h.depth=0,this.getSubEntities(a,b.depth).forEach(function(a){g.push(this["delete"](a,h))}.bind(this)),Promise.all(g).then(function(){return a})}.bind(this))},flush:function(){},persist:function(a){a.attach(this)},refresh:function(a,b){return b=b||{},b.refresh=!0,this.load(a.id,null,b)},attach:function(a){if(!this.contains(a)){var b=this.metamodel.entity(classOf(a));if(!b)throw new d.IllegalEntityError(a);if(this.containsById(a))throw new d.EntityExistsError(a);this._attach(a)}},_attach:function(a){var b=h.get(a);if(b.isAttached){if(b.db!=this)throw new d.EntityExistsError(a)}else b.db=this;b.id||"User"!=b.type.name&&"Role"!=b.type.name&&"logs.AppLog"!=b.type.name&&(b.id="/db/"+b.type.name+"/"+e.uuid()),b.id&&(this._entities[b.id]=a)},removeReference:function(a){var b=h.get(a);if(!b)throw new d.IllegalEntityError(a);delete this._entities[b.id]},register:function(a,b,e){if(this.me&&e)throw new d.PersistentError("User is already logged in.");return this.withLock(function(){var d=new c.Register({user:a,password:b,global:this.isGlobal,login:e});return this._userRequest(d,e)}.bind(this))},login:function(a,b){if(this.me)throw new d.PersistentError("User is already logged in.");return this.withLock(function(){var d=new c.Login({username:a,password:b,global:this.isGlobal});return this._userRequest(d,!0)}.bind(this))},logout:function(){return this.withLock(function(){var a=function(){this.me=null,this.token=null}.bind(this);return this.isGlobal?this._send(new c.Logout).then(a):Promise.resolve(a())}.bind(this))},loginWithOAuth:function(a,b,c){c=Object.extend({title:"Login with "+a,timeout:3e5,state:{}},c);var e,f=Object.extend(c.state,{isGlobal:this.isGlobal});if(!i[a+"OAuth"])throw new Error("Provider not supported.");e=new i[a+"OAuth"](b,c.scope,JSON.stringify(f));{var g=this._userRequest(e,!0);open(e.request.path,c.title,"width="+c.width+",height="+c.height)}return new Promise(function(a,b){var e=setTimeout(function(){b(new d.PersistentError("OAuth login timeout."))},c.timeout);g.then(function(b){clearTimeout(e),a(b)},function(a){clearTimeout(e),b(a)})}.bind(this))},renew:function(){return this.withLock(function(){var a=new c.Me;return a.withAuthorizationToken(this.isGlobal?!1:this.token),this._userRequest(a,!0)}.bind(this))},newPassword:function(a,b,d){return this.withLock(function(){var e=new c.NewPassword({username:a,password:b,newPassword:d,global:this.isGlobal});return this._send(e).then(function(){var a=this.getReference(e.response.entity.id),b=h.get(a);b.setJson(e.response.entity),b.setPersistent()}.bind(this))}.bind(this))},_userRequest:function(a,b){return this._send(a).then(function(){var c=this.getReference(a.response.entity.id),d=h.get(c);return d.setJson(a.response.entity),d.setPersistent(),b&&(this.me=c),c}.bind(this),function(a){if(a.status==j.OBJECT_NOT_FOUND)return null;throw a})},registerDevice:function(a,b,d){var e=new c.DeviceRegister({token:b,devicetype:a,device:d});return this._send(e)},checkDeviceRegistration:function(){return this._send(new c.DeviceRegistered).then(function(){return this.isDeviceRegistered=!0}.bind(this),function(a){if(a.status==j.OBJECT_NOT_FOUND)return this.isDeviceRegistered=!1;throw a}.bind(this))},pushDevice:function(a){return this._send(new c.DevicePush(a))},validate:function(a){for(var b,c=h.get(a).type,d=new e.ValidationResult,f=c.attributes();!(b=f.next()).done;){var g=new e.Validator(b.value.name,a);d.fields[g.key]=g}var i=c.validationCode;return i&&i(d.fields),d},User:null,Device:null});b.exports=k},{"./EntityTransaction":3,"./GeoPoint":4,"./Query":5,"./binding":16,"./collection":17,"./connector/Message":20,"./error":30,"./message":32,"./util":60,"./util/Metadata":54}],2:[function(a,b){var c=(a("./message"),a("./metamodel")),d=a("./util/Lockable"),e=a("./util/Code"),f=a("./connector/Connector"),g=a("./EntityManager"),h=Object.inherit(d,{_connector:null,metamodel:null,code:null,_connected:function(){},constructor:function(a){a=String.isInstance(a)?{host:a}:a||{},a.host?this.connect(a.host,a.port,a.secure):this.withLock(function(){return new Promise(function(a){this._connected=a}.bind(this))}.bind(this),!0),this.metamodel=this.createMetamodel(a.global),this.code=this.createCode(),a.schema&&this.metamodel.init(a.schema)},connect:function(a,b,c){if(this._connector)throw new Error("The EntityManagerFactory is already connected.");this._connector=f.create(a,b,c),this._connected()},createMetamodel:function(a){var b=a?c:new c.Metamodel;return this.isReady?b.connected(this._connector):b.withLock(function(){return this.ready().then(function(){b.connected(this._connector)}.bind(this))}.bind(this),!0),b},createCode:function(){var a=new e(this.metamodel);return this.isReady?a.connected(this._connector):this.ready().then(function(b){a.connected(b._connector)}),a},createEntityManager:function(a){var b,c=new g(this,a);return b=this.metamodel.isReady&&this.metamodel.isInitialized?c.connected(this._connector):this.metamodel.ready().then(function(){return this.metamodel.init()}.bind(this)).then(function(){return c.connected(this._connector)}.bind(this)),b&&c.withLock(function(){return b},!0),c}});b.exports=h},{"./EntityManager":1,"./connector/Connector":18,"./message":32,"./metamodel":48,"./util/Code":51,"./util/Lockable":52}],3:[function(a,b){var c=a("./message"),d=a("./error"),e=Object.inherit({get isActive(){return Boolean(this.tid)},constructor:function(a){this._connector=a.connector,this.entityManager=a,this.tid=null,this.rollbackOnly=!1,this.readSet=null,this.changeSet=null},begin:function(a,b){return this["yield"]().then(function(){var a=this.send(new c.PostTransaction).done(function(a){this.tid=a.tid,this.rollbackOnly=!1,this.readSet={},this.changeSet={}});return this.wait(a)}).then(a,b)},commit:function(a,b){return this["yield"]().then(function(){return this.getRollbackOnly()?this.rollback().then(function(){throw new d.RollbackError}):this.wait(this.entityManager.flush()).then(function(){var a=[];for(var b in this.readSet)a.push({oid:b,version:this.readSet[b]});var d=this.send(new c.PutTransactionCommitted(this.tid,a));return this.wait(d).then(function(a){this.tid=null,this.readSet=null,this.changeSet=null;var b=a.oids;for(var c in b){var d=b[c],e=this.entityManager.entities[c];if(e){var f=util.Metadata.get(e);"DELETED"==d||f.isDeleted?this.entityManager.removeReference(e):f.setJsonValue(f.type.version,d)}}})})}).then(a,b)},getRollbackOnly:function(){return this.rollbackOnly},rollback:function(a,b){return this["yield"]().then(function(){var a=this.send(new c.PutTransactionAborted(this.tid));this.wait(a).then(function(){return this.tid=null,this.readSet=null,this.changeSet=null,this.entityManager.clear()},function(){return this.entityManager.clear()})}).then(a,b)},setRollbackOnly:function(){return this["yield"]().done(function(){this.rollbackOnly=!0})},isRead:function(a){return this.isActive&&a in this.readSet},setRead:function(a,b){this.isActive&&!this.isChanged(a)&&(this.readSet[a]=b)},isChanged:function(a){return this.isActive&&a in this.changeSet},setChanged:function(a){this.isActive&&(delete this.readSet[a],this.changeSet[a]=!0)}});b.exports=e},{"./error":30,"./message":32}],4:[function(a,b){var c=(a("./collection"),Object.inherit({extend:{DEG_TO_RAD:Math.PI/180,EARTH_RADIUS_IN_KILOMETERS:6371,EARTH_RADIUS_IN_MILES:3956,current:function(){return new Promise(function(a,b){navigator.geolocation.getCurrentPosition(function(b){a(new c(b.coords.latitude,b.coords.longitude))},function(a){b(a)})})},conv:function(a){return new this(a)}},latitude:0,longitude:0,constructor:function(a,b){if(String.isInstance(a)){var c=a.indexOf(";");this.latitude=a.substring(0,c),this.longitude=a.substring(c+1)}else Number.isInstance(a)?(this.latitude=a,this.longitude=b):Array.isInstance(a)?(this.latitude=a[0],this.longitude=a[1]):Object.isInstance(a)&&(this.latitude=a.latitude,this.longitude=a.longitude);if(this.latitude<-90||this.latitude>90)throw new Error("Latitude "+this.latitude+" is not in bound of -90 <= latitude <= 90");if(this.longitude<-180||this.longitude>180)throw new Error("Longitude "+this.longitude+" is not in bound of -180 <= longitude <= 180")},kilometersTo:function(a){return Number((c.EARTH_RADIUS_IN_KILOMETERS*this.radiansTo(a)).toFixed(3))},milesTo:function(a){return Number((c.EARTH_RADIUS_IN_MILES*this.radiansTo(a)).toFixed(3))},radiansTo:function(a){var b=this,d=a,e=b.latitude*c.DEG_TO_RAD,f=d.latitude*c.DEG_TO_RAD,g=(d.longitude-b.longitude)*c.DEG_TO_RAD;return Math.acos(Math.sin(e)*Math.sin(f)+Math.cos(e)*Math.cos(f)*Math.cos(g))},toString:function(){return this.latitude+";"+this.longitude},toJSON:function(){return{latitude:this.latitude,longitude:this.longitude}}}));b.exports=c},{"./collection":17}],5:[function(a,b){var c=a("./message"),d=a("./util/Metadata"),e=a("./binding/Entity"),f=Trait.inherit({extend:{MAX_URI_SIZE:2e3},entityManager:null,resultClass:null,ascending:function(a){return this._addOrder(a,1)},descending:function(a){return this._addOrder(a,-1)},sort:function(a){if(classOf(a)!=Object)throw new Error("sort must be an object.");return this._addOrder(a)},offset:function(a){if(0>a)throw new Error("The offset can't be nagative.");return this._addOffset(a)},limit:function(a){if(0>a)throw new Error("The limit can't be nagative.");return this._addLimit(a)},resultList:function(){},singleResult:function(){},stream:function(){},count:function(){}});f.Condition=f.inherit({where:function(a){return this._addFilter(null,null,a)},equal:function(a,b){return this._addFilter(a,null,b)},notEqual:function(a,b){return this._addFilter(a,"$ne",b)},greaterThan:function(a,b){return this._addFilter(a,"$gt",b)},greaterThanOrEqualTo:function(a,b){return this._addFilter(a,"$gte",b)},lessThan:function(a,b){return this._addFilter(a,"$lt",b)},lessThanOrEqualTo:function(a,b){return this._addFilter(a,"$lte",b)},between:function(a,b,c){return this._addFilter(a,"$gt",b)._addFilter(a,"$lt",c)},"in":function(a,b){return this._addFilter(a,"$in",classOf(b)==Array?b:Array.prototype.slice.call(arguments,1))},notIn:function(a,b){return this._addFilter(a,"$nin",classOf(b)==Array?b:Array.prototype.slice.call(arguments,1))},isNull:function(a){return this.equal(a,null)},isNotNull:function(a){return this._addFilter(a,"$exists",!0)._addFilter(a,"$ne",null)},containsAll:function(a,b){return this._addFilter(a,"$all",classOf(b)==Array?b:Array.prototype.slice.call(arguments,1))},mod:function(a,b,c){return this._addFilter(a,"$mod",[b,c])},matches:function(a,b){if(RegExp.isInstance(b)||(b=new RegExp(b)),b.ignoreCase)throw new Error("RegExp.ignoreCase flag is not supported.");if(b.global)throw new Error("RegExp.global flag is not supported.");if(0!=b.source.indexOf("^"))throw new Error("regExp must be an anchored expression, i.e. it must be started with a ^.");var c=this._addFilter(a,"$regex",b.source);return b.multiline&&c._addFilter(a,"$options","m"),c},size:function(a,b){return this._addFilter(a,"$size",b)},near:function(a,b,c){return this._addFilter(a,"$nearSphere",{$geometry:{type:"Point",coordinates:[b.longitude,b.latitude]},$maxDistance:c})},withinPolygon:function(a,b){return b=classOf(b)==Array?b:Array.prototype.slice.call(arguments,1),this._addFilter(a,"$geoWithin",{$geometry:{type:"Polygon",coordinates:[b.map(function(a){return[a.longitude,a.latitude]})]}})}});var g=f.Condition.prototype;Object.extend(g,{lt:g.lessThan,le:g.lessThanOrEqualTo,gt:g.greaterThan,ge:g.greaterThanOrEqualTo,containsAny:g["in"]}),f.Node=Object.inherit(f,{firstResult:0,maxResults:-1,initialize:function(a,b){this.entityManager=a,this.resultClass=b,this._sort={}},stream:function(a){var b=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!b)throw new Error("Only typed queries can be executed.");void 0===a&&(a=!0);var c=this._serializeSort();return new f.Stream(this.entityManager,b.name,this._serializeQuery(),a,c,this.maxResults)},resultList:function(a,b,d){Function.isInstance(a)&&(d=b,b=a,a={});var e=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!e)throw new Error("Only typed queries can be executed.");var g,h=this._serializeQuery(),i=this._serializeSort(),j=this.entityManager._connector.host.length+h.length;return g=j>f.MAX_URI_SIZE?new c.AdhocQueryPOST(e.name,this.firstResult,this.maxResults,i,h):new c.AdhocQuery(e.name,h,this.firstResult,this.maxResults,i),this.entityManager._send(g).then(function(){return this._createResultList(g.response.entity,a)}.bind(this)).then(b,d)},singleResult:function(a,b,d){Function.isInstance(a)&&(d=b,b=a,a={});var e=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!e)throw new Error("Only typed queries can be executed.");var g,h=this._serializeQuery(),i=this._serializeSort(),j=this.entityManager._connector.host.length+h.length;return g=j>f.MAX_URI_SIZE?new c.AdhocQueryPOST(e.name,h,this.firstResult,1,i,h):new c.AdhocQuery(e.name,h,this.firstResult,1,i),this.entityManager._send(g).then(function(){return this._createResultList(g.response.entity,a)}.bind(this)).then(function(a){return a.length?a[0]:null}).then(b,d)},count:function(a,b){var d=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!d)throw new Error("Only typed queries can be executed.");var e,g=this._serializeQuery(),h=this.entityManager._connector.host.length+g.length;return e=h>f.MAX_URI_SIZE?new c.AdhocCountQueryPOST(d.name,g):new c.AdhocCountQuery(d.name,g),this.entityManager._send(e).then(function(){return e.response.entity.count}).then(a,b)},_serializeQuery:function(){return JSON.stringify(this,function(a,b){var c=this[a];return Date.isInstance(c)?{$date:b}:e.isInstance(c)?c.id:b})},_serializeSort:function(){return JSON.stringify(this._sort)},_createResultList:function(a,b){return a.length?Promise.all(a.map(function(a){if(a.id){var c=this.entityManager.getReference(this.resultClass,a.id),e=d.get(c);return e.setJson(a),e.setPersistent(),this.entityManager.resolveDepth(c,b)}return this.entityManager.load(Object.keys(a)[0])},this)).then(function(a){return a.filter(function(a){return!!a})}):Promise.resolve([])},_addOrder:function(a,b){return b?this._sort[a]=b:this._sort=a,this},_addOffset:function(a){return this.firstResult=a,this},_addLimit:function(a){return this.maxResults=a,this}}),f.Builder=Object.inherit(f.Condition,{initialize:function(a,b){this.entityManager=a,this.resultClass=b},and:function(a){return this._addOperator("$and",classOf(a)==Array?a:Array.prototype.slice.call(arguments))},or:function(a){return this._addOperator("$or",classOf(a)==Array?a:Array.prototype.slice.call(arguments))},nor:function(a){return this._addOperator("$nor",classOf(a)==Array?a:Array.prototype.slice.call(arguments))},stream:function(a){return this.where({}).stream(a)},resultList:function(a,b,c){return this.where({}).resultList(a,b,c)},singleResult:function(a,b,c){return this.where({}).singleResult(a,b,c)},count:function(a,b){return this.where({}).count(a,b)},_addOperator:function(a,b){if(b.length<2)throw new Error("Only two or more queries can be joined with an "+a+" operator.");return b.forEach(function(a,b){if(!f.isInstance(a))throw new Error("Argument at index "+b+" is not a Query.")}),new f.Operator(this.entityManager,this.resultClass,a,b)},_addOrder:function(a,b){return new f.Filter(this.entityManager,this.resultClass)._addOrder(a,b)},_addFilter:function(a,b,c){return new f.Filter(this.entityManager,this.resultClass)._addFilter(a,b,c)},_addOffset:function(a){return new f.Filter(this.entityManager,this.resultClass)._addOffset(a)},_addLimit:function(a){return new f.Filter(this.entityManager,this.resultClass)._addLimit(a)}}),f.Filter=f.Node.inherit(f.Condition,{_filter:null,initialize:function(a,b){this.superCall(a,b),this._filter={}},_addFilter:function(a,b,c){if(null!==a){if(!String.isInstance(a))throw new Error("Field must be a string.");if(b){var d=this._filter[a];classOf(d)!=Object&&(this._filter[a]=d={}),d[b]=c}else this._filter[a]=c}else Object.extend(this._filter,c);return this},toJSON:function(){return this._filter}}),f.Operator=f.Node.inherit({_operator:null,_childs:null,initialize:function(a,b,c,d){this.superCall(a,b),this._operator=c,this._childs=d},toJSON:function(){var a={};return a[this._operator]=this._childs,a}}),f.Stream=Object.inherit({initialize:function(a,b,c,d,e,f){this.entityManager=a,this.bucket=b,this.fetchQuery=d,this.sort=e,this.limit=f,this.query=c,this.callbacks=[]},on:function(a,b){var c=[this.bucket,this.query,a,"any"].join("/"),d=this._wrapQueryCallback(b);this.entityManager._subscribe(c,d);var e={register:!0,topic:c,query:{bucket:this.bucket,matchTypes:[a],operations:["any"],query:this.query}};this.fetchQuery&&(e.fromstart=!0,e.limit=this.limit,e.sort=this.sort),this.entityManager._sendOverSocket(e),this.callbacks.push({matchType:a,callback:b,topic:c,wrappedCallback:d,queryMessage:e})},off:function(a,b){this.callbacks=this.callbacks.reduce(function(c,d){return b&&d.callback!=b||a&&d.matchType!=a?c.push(d):(this.entityManager._unsubscribe(d.topic,d.wrappedCallback),d.queryMessage.register=!1,this.entityManager._sendOverSocket(d.queryMessage)),c}.bind(this),[])},once:function(a,b){var c=function(d,e,f){this.off(a,c),b(d,e,f)}.bind(this);this.on(a,c)},_wrapQueryCallback:function(a){var b=!1;return function(c){var d=c.query.bucket;if(c.match){var e=c.match.update.operation,f=c.match.update.object?c.match.update.object:{id:c.match.update.id},g=this._createObject(d,e,f);a({type:c.match.matchtype,data:g,operation:e,date:new Date(c.date),target:this,initial:!1,query:this.query})}else b||(c.result.forEach(function(b){var e="insert",f=this._createObject(d,e,b,b.id);a({type:"match",data:f,operation:e,date:new Date(c.date),target:this,initial:!0,query:this.query})},this),b=!0)}.bind(this)},_createObject:function(a,b,c){var e=this.entityManager.getReference(a,c.id),f=d.get(e);return f.setJson(c),f.setPersistent(),e}}),b.exports=f},{"./binding/Entity":9,"./message":32,"./util/Metadata":54}],6:[function(a,b){var c=Object.inherit({getValue:function(a,b){return a[b.name]},setValue:function(a,b,c){a[b.name]=c}});b.exports=c},{}],7:[function(a,b){var c=a("./EntityFactory"),d={};Object.cloneOwnProperties(d,c),Object.defineProperty(d,"isRegistered",{get:function(){return this._db.isDeviceRegistered}}),Object.extend(d,{PushMessage:a("../util/PushMessage"),register:function(a,b,c,d,e){return Function.isInstance(c)&&(e=d,d=c,c=null),this._db.registerDevice(a,b,c).then(d,e)},push:function(a,b,c){return this._db.pushDevice(a).then(b,c)}}),b.exports=d},{"../util/PushMessage":57,"./EntityFactory":10}],8:[function(a,b){var c=a("../util/Metadata"),d=(a("../util/Lockable"),Object.inherit({createProxy:function(a){function b(){a.apply(this,arguments)}return b.prototype=Object.create(a.prototype,{constructor:{value:b,enumerable:!1,configurable:!0}}),b},getIdentifier:function(a){return a.__baqendId__},setIdentifier:function(a,b){a.__baqendId__=b},enhance:function(a,b){this.setIdentifier(b,a.ref),this.enhancePrototype(b,a)},enhancePrototype:function(a,b){if(a.prototype.toString===Object.prototype.toString&&Object.defineProperty(a.prototype,"toString",{value:function(){return this._metadata.id||this._metadata.bucket},enumerable:!1}),b.superType&&"Object"==b.superType.name)for(var c,d=0;c=b.superType.declaredAttributes[d];++d)c.isMetadata||this.enhanceProperty(a,c);for(var c,d=0;c=b.declaredAttributes[d];++d)this.enhanceProperty(a,c)},enhanceProperty:function(a,b){var d="$"+b.name;Object.defineProperty(a.prototype,b.name,{get:function(){return c.readAccess(this),this._metadata[d]},set:function(a){c.writeAccess(this),this._metadata[d]=a},configurable:!0,enumerable:!0})}}));b.exports=d},{"../util/Lockable":52,"../util/Metadata":54}],9:[function(a,b){var c=a("./Managed"),d=(a("../util/Lockable"),c.inherit({extend:{extend:c.extend},constructor:function(){c.apply(this,arguments)},get id(){return this._metadata.id},set id(a){if(this._metadata.id)throw new Error("Id can't be set twice.");0!=a.indexOf("/db/")&&(a="/db/"+this._metadata.bucket+"/"+encodeURIComponent(a)),this._metadata.id=a},get version(){return this._metadata.version},set version(a){this._metadata.version=a},get acl(){return this._metadata.acl},ready:function(a){return this._metadata.ready(a)},attach:function(a){a.attach(this)},save:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db.save(this,a).then(b,c)},insert:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db.insert(this,a).then(b,c)},update:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db.update(this,a).then(b,c)},load:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={depth:1}),this._metadata.db.load(this.id,null,a).then(b,c)},"delete":function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db["delete"](this,a).then(b,c)},optimisticSave:function(a,b,c){return this._metadata.db.optimisticSave(this,a).then(b,c)},attr:function(){throw new Error("Attr is not yet implemented.")},validate:function(){return this._metadata.db.validate(this)},toJSON:function(a){return this._metadata.getJson(a,a)}}));b.exports=d},{"../util/Lockable":52,"./Managed":11}],10:[function(a,b){var c=a("./ManagedFactory"),d={};Object.cloneOwnProperties(d,c),Object.extend(d,{load:function(a,b,c,d){return Function.isInstance(b)&&(d=c,c=b,b={}),this._db.load(this._managedType.typeConstructor,a,b).then(c,d)},fromJSON:function(a){var b=a.id?this._db.getReference(this._managedType.typeConstructor,a.id):this.newInstance(),c=b._metadata;return c.setJson(a),c.setDirty(),b},find:function(){return this._db.createQueryBuilder(this._managedType.typeConstructor)},partialUpdate:function(){throw new Error("partialUpdate is not yet implemented.")}}),b.exports=d},{"./ManagedFactory":12}],11:[function(a,b){var c=(a("../util"),Object.inherit({extend:{extend:function(a){return a.prototype=Object.create(this.prototype,{constructor:{value:a,enumerable:!1,configurable:!0,writable:!0}}),a.extend=c.extend,a}},constructor:function(a){a&&Object.extend(this,a)}}));b.exports=c},{"../util":60}],12:[function(a,b){var c={};Object.defineProperty(c,"methods",{get:function(){return this.prototype}}),Object.extend(c,{create:function(a,b){var c=this,d=function(){return d.newInstance.apply(d,arguments)};return Object.cloneOwnProperties(d,c),d.prototype=a.typeConstructor.prototype,d._managedType=a,d._db=b,d},newInstance:function(){var a=this._managedType.create();return this.prototype.constructor.apply(a,arguments),a._metadata.db=this._db,a},addMethods:function(a){Object.extend(this.methods,a)},addMethod:function(a,b){this.methods[a]=b}}),b.exports=c},{}],13:[function(a,b){var c=a("./Entity"),d=a("./User"),e=a("../collection").Set,f=c.inherit({extend:{extend:c.extend},users:null,name:null,constructor:function(){c.apply(this,arguments)},hasUser:function(a){return this.users&&this.users.has(a)},addUser:function(a){if(!(a instanceof d))throw new Error("Only user instances can be added to a role.");this.users||(this.users=new e),this.users.add(a)},removeUser:function(a){if(!(a instanceof d))throw new Error("Only user instances can be removed from a role.");this.users&&this.users["delete"](a)}});b.exports=f},{"../collection":17,"./Entity":9,"./User":14}],14:[function(a,b){var c=a("./Entity"),d=c.inherit({extend:{extend:c.extend},constructor:function(){c.apply(this,arguments)},username:null,newPassword:function(a,b,c,d){return this._metadata.db.newPassword(this.username,a,b).then(c,d)}});b.exports=d},{"./Entity":9}],15:[function(a,b){var c=a("./EntityFactory"),d={};Object.cloneOwnProperties(d,c),Object.defineProperty(d,"me",{get:function(){return this._db.me}}),Object.extend(d,{defaultOptions:{google:{width:585,height:545,scope:"email"},facebook:{width:1140,height:640,scope:"email"},github:{width:1040,height:580,scope:"user:email"},twitter:{width:740,height:730},linkedin:{width:630,height:530,scope:""}},register:function(a,b,c,d,e){return Boolean.isInstance(c)||(e=d,d=c,c=!0),a=String.isInstance(a)?this.fromJSON({username:a}):a,this._db.register(a,b,c).then(d,e)},login:function(a,b,c,d){return this._db.login(a,b).then(c,d)},logout:function(a,b){return this._db.logout().then(a,b)},newPassword:function(a,b,c,d,e){return this._db.newPassword(a,b,c).then(d,e)}}),["Google","Facebook","GitHub","Twitter","LinkedIn"].forEach(function(a){d["loginWith"+a]=function(b,c,e,f){return Function.isInstance(c)&&(f=e,e=c,c={}),c=Object.extend(Object.extend({},d.defaultOptions[a.toLowerCase()]),c||{}),this._db.loginWithOAuth(a,b,c).then(e,f)}}),b.exports=d},{"./EntityFactory":10}],16:[function(a,b,c){c.Accessor=a("./Accessor"),c.Enhancer=a("./Enhancer"),c.ManagedFactory=a("./ManagedFactory"),c.EntityFactory=a("./EntityFactory"),c.UserFactory=a("./UserFactory"),c.DeviceFactory=a("./DeviceFactory"),c.Managed=a("./Managed"),c.Entity=a("./Entity"),c.Role=a("./Role"),c.User=a("./User")},{"./Accessor":6,"./DeviceFactory":7,"./Enhancer":8,"./Entity":9,"./EntityFactory":10,"./Managed":11,"./ManagedFactory":12,"./Role":13,"./User":14,"./UserFactory":15
}],17:[function(a,b,c){var d,e,f,g,h,i,j,k,l=a("./util/Metadata"),m="@@iterator";c.Iterator=d=Trait.inherit({extend:{DONE:{done:!0}},constructor:function(a){return a?a[m]&&Function.isInstance(a[m])?a[m]():Array.isInstance(a)?new e(a.length,function(b){return a[b]}):new f(a):void 0},next:function(){return d.DONE}}),c.IndexIterator=e=Object.inherit(d,{length:0,index:0,constructor:function(a,b){this.length=a,b&&(this.accessor=b)},accessor:function(a){return a},next:function(){if(this.index<this.length){var a={done:!1,value:this.accessor(this.index)};return this.index++,a}return d.DONE}}),c.PropertyIterator=f=d.inherit({index:0,constructor:function(a){this.object=a,this.names=Object.getOwnPropertyNames(a)},next:function(){if(this.names.length<this.index){var a=this.names[this.index++];return{done:!1,value:[a,this.object[a]]}}return d.DONE}}),c.Iterable=g=Trait.inherit({entries:function(){return null},forEach:function(a,b){if(!a||!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=this.entries();!(c=d.next()).done;)a.call(b,c.value[1],c.value[0],this)},every:function(a,b){if(!a||!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=this.entries();!(c=d.next()).done;)if(!a.call(b,c.value[1],c.value[0],this))return!1;return!0},some:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=this.entries();!(c=d.next()).done;)if(a.call(b,c.value[1],c.value[0],this))return!0;return!1},filter:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=new this.constructor,e=this.entries();!(c=e.next()).done;)a.call(b,c.value[1],c.value[0],this)&&(d.set?d.set(c.value[0],c.value[1]):d.add(c.value[1]));return d},map:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=new this.constructor,e=this.entries();!(c=e.next()).done;){var f=a.call(b,c.value[1],c.value[0],this);d.set?d.set(c.value[0],f):d.add(f)}return d},reduce:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");var c=this.entries();1==arguments.length&&(b=c.next().value);for(var d;!(d=c.next()).done;)b=a.call(null,b,d.value[1],d.value[0],this);return b}}),c.Collection=h=Object.inherit(g,{array:null,get size(){return this.array.length},constructor:function(a){this.array=[];var b=d(a);if(b)for(var c;!(c=b.next()).done;)this.add(c.value)},has:function(a){return-1!=this.array.indexOf(a)},clear:function(){l.writeAccess(this),this.array=[]},add:function(a){l.writeAccess(this),this.array.push(a)},"delete":function(a){l.writeAccess(this);var b=this.array.indexOf(a);b>-1&&this.array.splice(b,1)},entries:function(){var a=this.array;return new e(this.size,function(b){return[b,a[b]]})},keys:function(){return new e(this.size)},values:function(){var a=this.array;return new e(this.size,function(b){return a[b]})},toString:function(){return this.array.toString()},toJSON:function(){return this.array}});var n=Array.prototype;c.List=i=h.inherit({constructor:function(a){h.call(this,a)},get:function(a){return 0>a&&(a=this.size+a),a>=0&&a<this.size?this.array[a]:void 0},add:function(a){l.writeAccess(this),this.array.push(a)},set:function(a,b){l.writeAccess(this),0>a&&(a=this.size+a),0>a?this.array.unshift(b):a>=this.size?this.array.push(b):this.array[a]=b},concat:function(){var a=n.map.call(arguments,function(a){return i.isInstance(a)?a.array:a});return new i(n.concat.apply(this.array,a))},indexOf:function(a){return this.seq.indexOf(a)},lastIndexOf:function(a){return this.seq.lastIndexOf(a)},join:function(a){return this.array.join(a)},pop:function(){return l.writeAccess(this),this.array.pop()},push:function(){return l.writeAccess(this),n.push.apply(this.array,arguments)},reverse:function(){l.writeAccess(this),this.array.reverse()},shift:function(){return l.writeAccess(this),this.array.shift()},slice:function(a,b){return new i(this.array.slice(a,b))},sort:function(a){l.writeAccess(this),this.array.sort(a)},splice:function(){return l.writeAccess(this),n.splice.apply(this.array,arguments)},unshift:function(){return l.writeAccess(this),n.unshift.apply(this.array,arguments)}}),i.prototype[m]=i.prototype.values,c.Set=j=h.inherit({constructor:function(a){h.call(this,a)},add:function(a){var b=this.array.indexOf(a);0>b&&(this.array.push(a),l.writeAccess(this))},entries:function(){var a=this.array;return new e(this.size,function(b){return[a[b],a[b]]})}}),j.prototype.keys=j.prototype.values,j.prototype[m]=j.prototype.values,c.Map=k=h.inherit({constructor:function(a){this.array=[],this.vals=[];var b=d(a);if(b)for(var c;!(c=b.next()).done;){if(!Array.isInstance(c.value)||2!=c.value.length)throw new Error("No key value pair in entry "+c.value);this.set(c.value[0],c.value[1])}},clear:function(){l.writeAccess(this),this.array=[],this.vals=[]},get:function(a){var b=this.array.indexOf(a);return b>-1?this.vals[b]:void 0},add:function(a){l.writeAccess(this),this.set(a,a)},set:function(a,b){l.writeAccess(this);var c=this.array.indexOf(a);-1==c&&(c=this.array.length,this.array[c]=a),this.vals[c]=b},remove:function(a){l.writeAccess(this);var b=this.array.indexOf(a);b>-1&&(this.array.splice(b,1),this.vals.splice(b,1))},entries:function(){var a=this.array,b=this.vals;return new e(this.size,function(c){return[a[c],b[c]]})},keys:function(){var a=this.array;return new e(this.size,function(b){return a[b]})},values:function(){var a=this.vals;return new e(this.size,function(b){return a[b]})},toString:function(){for(var a="",b=0,c=this.size;c>b;++b)""!=a&&(a+=", "),a+=this.array[b],a+=": ",a+=this.vals[b];return"["+a+"]"},toJSON:function(){for(var a=[],b=0,c=this.size;c>b;++b)a.push({key:this.array[b],value:this.vals[b]});return a}}),k.prototype[m]=k.prototype.entries},{"./util/Metadata":54}],18:[function(a,b){var c=a("../error/PersistentError"),d=Object.inherit({extend:{RESPONSE_HEADERS:["Baqend-Authorization-Token","Content-Type"],connectors:[],connections:{},create:function(a,b,c){if(a||"undefined"==typeof window||(a=window.location.hostname,b=Number(window.location.port),c="https:"==window.location.protocol),-1!=a.indexOf("/")){var e=/^(https?):\/\/([^\/:]+|\[[^\]]+])(:(\d*))?\/?$/.exec(a);if(!e)throw new Error("The connection uri host "+a+" seems not to be valid");c="https"==e[1],a=e[2].replace(/(\[|])/g,""),b=e[4]}b||(b=c?443:80);var f=d.toUri(a,b,c),g=this.connections[f];if(!g){for(var h in this.connectors){var i=this.connectors[h];if(i.isUsable&&i.isUsable(a,b,c)){g=new i(a,b,c);break}}if(!g)throw new Error("No connector is usable for the requested connection.");this.connections[f]=g}return g},toUri:function(a,b,c){var d=(c?"https://":"http://")+(-1!=a.indexOf(":")?"["+a+"]":a);return d+=c&&443!=b||!c&&80!=b?":"+b:""}},constructor:function e(a,b,c){this.host=a,this.port=b,this.secure=c,this.socket=null,this.listeners={},this.origin=e.toUri(a,b,c)},send:function(a){return"OAUTH"==a.request.method&&a.addRedirectOrigin(this.origin),new Promise(function(b,c){this.prepareRequestEntity(a),this.doSend(a.request,this.receive.bind(this,a,b,c))}.bind(this))["catch"](function(a){throw c.of(a)})},receive:function(a,b,d,e){a.response=e;try{a.response.status=1223==a.response.status?204:a.response.status,this.prepareResponseEntity(a),a.doReceive(),b(a)}catch(f){f=c.of(f),a.response.entity=null,d(f)}},doSend:function(){},subscribe:function(a,b){a=String.isInstance(a)?a:JSON.stringify(a),this.listeners[a]?-1==this.listeners[a].indexOf(b)&&this.listeners[a].push(b):this.listeners[a]=[b]},unsubscribe:function(a,b){if(a=String.isInstance(a)?a:JSON.stringify(a),this.listeners[a]){var c=this.listeners[a].indexOf(b);-1!=c&&this.listeners[a].splice(c,1)}},socketListener:function(a){var b=JSON.parse(a.data),c=b.topic;c=String.isInstance(c)?c:JSON.stringify(c),this.listeners[c]&&this.listeners[c].forEach(function(a){a(b)})},socketOpen:null,sendOverSocket:function(a){null===this.socket&&(this.socket=this.createSocket(),this.socket.onmessage=this.socketListener.bind(this),this.socketOpen=new Promise(function(a,b){this.socket.onopen=a,this.socket.onerror=b}.bind(this)),this.socket.onclose=function(){this.socket=null,this.socketOpen=null}.bind(this));var b=JSON.stringify(a);this.socketOpen.then(function(){this.socket.send(b)}.bind(this))},createSocket:function(){},prepareRequestEntity:function(a){a.request.entity&&(String.isInstance(a.request.entity)?a.request.headers["Content-Type"]="text/plain;charset=utf-8":(a.request.headers["Content-Type"]="application/json;charset=utf-8",a.request.entity=JSON.stringify(a.request.entity)))},prepareResponseEntity:function(a){var b=a.response.entity;if(b&&b.length>0){var c=a.response.headers["Content-Type"]||a.response.headers["content-type"];c&&c.indexOf("application/json")>-1&&(b=JSON.parse(b))}else b=null;a.response.entity=b}});b.exports=d},{"../error/PersistentError":28}],19:[function(a,b){var c=a("./Connector"),d=c.inherit({extend:{loadedAttr:"data-loaded",style:"width:1px;height:1px;position:absolute;top:-10px;left:-10px;",initialize:function(){c.connectors.push(this)},isUsable:function(a,b){return"undefined"!=typeof window&&(window.location.hostname!=a||window.location.port!=b)}},queue:null,origin:null,iframe:null,messages:null,mid:0,constructor:function e(a,b,d){c.call(this,a,b,d),this.messages={};var f=this.origin+"/connect";this.iframe=document.querySelector('iframe[src="'+f+'"]'),this.iframe&&this.iframe.src==f||(this.iframe=document.createElement("iframe"),this.iframe.src=f,this.iframe.setAttribute("style",e.style),document.body.appendChild(this.iframe)),this.isLoaded()||(this.queue=[],this.iframe.addEventListener("load",this.onLoad.bind(this),!1)),window.addEventListener("message",this.doReceive.bind(this),!1)},onLoad:function(){for(var a=this.queue,b=0;b<a.length;++b)this.iframe.contentWindow.postMessage(a[b],this.origin);this.queue=null,this.setLoaded()},setLoaded:function(){this.iframe.setAttribute(d.loadedAttr,!0)},isLoaded:function(){return!!this.iframe.getAttribute(d.loadedAttr)},doSend:function(a,b){var d={mid:++this.mid,method:a.method,path:a.path,headers:a.headers,entity:a.entity,responseHeaders:c.RESPONSE_HEADERS};this.messages[d.mid]={request:a,receive:b},d=JSON.stringify(d),this.queue?this.queue.push(d):this.iframe.contentWindow.postMessage(d,this.origin)},createSocket:function(){return new WebSocket((this.secure?"wss://":"ws://")+this.host+":"+this.port+"/events/")},doReceive:function(a){if(a.origin===this.origin&&"{"==a.data[0]){var b=JSON.parse(a.data),c=this.messages[b.mid];delete this.messages[b.mid],c.receive({status:b.status,headers:b.headers,entity:b.entity})}}});b.exports=d},{"./Connector":18}],20:[function(a,b){var c=a("../error/CommunicationError"),d=Object.inherit({extend:{StatusCode:{NOT_MODIFIED:304,BAD_CREDENTIALS:460,BUCKET_NOT_FOUND:461,INVALID_PERMISSION_MODIFICATION:462,INVALID_TYPE_VALUE:463,OBJECT_NOT_FOUND:404,OBJECT_OUT_OF_DATE:412,PERMISSION_DENIED:466,QUERY_DISPOSED:467,QUERY_NOT_SUPPORTED:468,SCHEMA_NOT_COMPATIBLE:469,SCHEMA_STILL_EXISTS:470,SYNTAX_ERROR:471,TRANSACTION_INACTIVE:472,TYPE_ALREADY_EXISTS:473,TYPE_STILL_REFERENCED:474,SCRIPT_ABORTION:475},create:function(a){var b=a.path.split("?"),c=b[0].split(/:\w*/),e=[];return b[1]&&b[1].split("&").forEach(function(a){var b=a.split("=");e.push(b[0])}),a.path=c,a.query=e,d.inherit({spec:a})},createExternal:function(a){return a.path=[a.path],d.inherit({spec:a})}},spec:null,withCredentials:!1,initialize:function(){var a=arguments,b=0,c=this.spec.path;if(!String.isInstance(c)){c=this.spec.path[0];for(var d=1;d<this.spec.path.length;++d)c+=encodeURIComponent(a[b++])+this.spec.path[d]}for(var e="",d=0;d<this.spec.query.length;++d){var f=a[b++];void 0!==f&&null!==f&&(e+=e||~c.indexOf("?")?"&":"?",e+=this.spec.query[d]+"="+encodeURIComponent(f))}this.request={method:this.spec.method,path:c+e,headers:{accept:"application/json, text/*;q=0.1"},entity:a[b]||null},this.response={status:0,headers:{},entity:null}},setIfMatch:function(a){"*"!=a&&(a='"'+a+'"'),this.request.headers["If-Match"]=a},setIfNoneMatch:function(a){"*"!=a&&(a='"'+a+'"'),this.request.headers["If-None-Match"]=a},setCacheControl:function(a){this.request.headers["Cache-Control"]=a},getAuthorizationToken:function(){return this.response.headers["Baqend-Authorization-Token"]||this.response.headers["baqend-authorization-token"]},setAuthorizationToken:function(a){this.request.headers.Authorization="BAT "+a},withAuthorizationToken:function(a){a?this.setAuthorizationToken(a):this.request.withCredentials=!0},addQueryString:function(a){if(String.isInstance(a))this.request.path+=a;else if(a){var b=~this.request.path.indexOf("?")?"&":"?";Object.keys(a).forEach(function(c,d){this.request.path+=b+c+"="+encodeURIComponent(a[c]),0==d&&(b="&")}.bind(this))}},doReceive:function(){if(-1==this.spec.status.indexOf(this.response.status))throw new c(this)}});d.GoogleOAuth=d.createExternal({method:"OAUTH",path:"https://accounts.google.com/o/oauth2/auth?response_type=code&access_type=online",query:["client_id","scope","state"],status:[200]}),d.GoogleOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/google"})},d.FacebookOAuth=d.createExternal({method:"OAUTH",path:"https://www.facebook.com/dialog/oauth?response_type=code",query:["client_id","scope","state"],status:[200]}),d.FacebookOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/facebook"})},d.GitHubOAuth=d.createExternal({method:"OAUTH",path:"https://github.com/login/oauth/authorize?response_type=code&access_type=online",query:["client_id","scope","state"],status:[200]}),d.GitHubOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/github"})},d.LinkedInOAuth=d.createExternal({method:"OAUTH",path:"https://www.linkedin.com/uas/oauth2/authorization?response_type=code&access_type=online",query:["client_id","scope","state"],status:[200]}),d.LinkedInOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/linkedin"})},d.TwitterOAuth=d.createExternal({method:"OAUTH",path:"",query:[],status:[200]}),d.TwitterOAuth.prototype.addRedirectOrigin=function(a){this.request.path=a+"/db/User/OAuth1/twitter"},b.exports=d},{"../error/CommunicationError":24}],21:[function(a,b){var c=a("./Connector"),d=c.inherit({extend:{initialize:function(){c.connectors.push(this)},isUsable:function(b,c,d){if(!this.prototype.http)try{var e;e=a(d?"https":"http"),e.request&&e.Server&&(this.prototype.http=e)}catch(f){}return Boolean(this.prototype.http)}},constructor:function(){c.apply(this,arguments)},cookie:null,doSend:function(a,b){a.host=this.host,a.port=this.port;var c=this,d=a.entity;this.cookie&&this.secure&&a.withCredentials&&(a.headers.Cookie=this.cookie);var e=this.http.request(a,function(a){var d="";a.setEncoding("utf-8"),a.on("data",function(a){d+=a}),a.on("end",function(){var e=a.headers["set-cookie"];e&&(c.cookie=c.parseCookie(e+"")),b({status:a.statusCode,headers:a.headers,entity:d})})});e.on("error",function(a){b({status:0,error:a})}),d?e.end(d,"utf8"):e.end()},createSocket:function(){var b=a("websocket").w3cwebsocket;return new b((this.secure?"wss://":"ws://")+this.host+":"+this.port+"/events/")},parseCookie:function(a){for(var b,c=a.split(";"),d=0;b=c[d];++d)if(0==b.indexOf("Expires=")){var e=Date.parse(b.substring(8));if(e<Date.now())return null}return c[0]}});b.exports=d},{"./Connector":18,http:void 0,https:void 0,websocket:65}],22:[function(a,b){var c=a("./Connector"),d=c.inherit({extend:{initialize:function(){c.connectors.push(this)},isUsable:function(a,b,c){return"undefined"!=window&&window.location.hostname==a&&window.location.port==b&&window.location.protocol==(c?"https:":"http:")&&"undefined"!=typeof XMLHttpRequest}},constructor:function(){c.apply(this,arguments)},doSend:function(a,b){if("OAUTH"==a.method)return void addEventListener("storage",function i(a){"oauth-response"==a.key&&(b(JSON.parse(a.newValue)),localStorage.removeItem("oauth-response"),removeEventListener("storage",i,!1))},!1);var d=new XMLHttpRequest,e=this.origin+a.path;d.onreadystatechange=function(){if(4==d.readyState){var a={headers:{},status:d.status,entity:d.response||d.responseText};c.RESPONSE_HEADERS.forEach(function(b){a.headers[b]=d.getResponseHeader(b)}),b(a)}},d.open(a.method,e,!0);var f=a.entity,g=a.headers;for(var h in g)d.setRequestHeader(h,g[h]);d.withCredentials=a.withCredentials,d.send(f)},createSocket:function(){return new WebSocket((this.secure?"wss://":"ws://")+this.host+":"+this.port+"/events/")}});b.exports=d},{"./Connector":18}],23:[function(a,b,c){c.Message=a("./Message"),c.Connector=a("./Connector"),c.NodeConnector=a("./NodeConnector"),c.XMLHttpConnector=a("./XMLHttpConnector"),c.IFrameConnector=a("./IFrameConnector")},{"./Connector":18,"./IFrameConnector":19,"./Message":20,"./NodeConnector":21,"./XMLHttpConnector":22}],24:[function(a,b){var c=a("./PersistentError"),d=c.inherit({status:0,constructor:function(a){var b=a.response.entity||{},d=0==a.response.status?"Request":"Response",e=b.message||"Handling the "+d+" for "+a.request.method+" "+a.request.path;c.call(this,e,b),this.name=b.className||"CommunicationError",this.reason=b.reason||"Communication failed",this.status=a.response.status,b.data&&(this.data=b.data);for(var f=b;f&&f.stackTrace;){this.stack+="\nServerside Caused by: "+f.className+" "+f.message;for(var g=f.stackTrace,h=0;h<g.length;++h){var i=g[h];this.stack+="\n    at "+i.className+"."+i.methodName,this.stack+=" ("+i.fileName+":"+i.lineNumber+")"}f=f.cause}}});b.exports=d},{"./PersistentError":28}],25:[function(a,b){var c=a("./PersistentError"),d=c.inherit({constructor:function(a){c.call(this,"The entity "+a+" is managed by a different db."),this.entity=a}});b.exports=d},{"./PersistentError":28}],26:[function(a,b){var c=a("./PersistentError"),d=c.inherit({constructor:function(a){c.call(this,"Entity "+a+" is not found"),this.identity=a}});b.exports=d},{"./PersistentError":28}],27:[function(a,b){var c=a("./PersistentError"),d=c.inherit({constructor:function(a){c.call(this,"Entity "+a+" is not a valid entity"),this.entity=a}});b.exports=d},{"./PersistentError":28}],28:[function(a,b){var c=Error.inherit({cause:null,extend:{of:function(a){return a instanceof c?a:new c(null,a)}},constructor:function(a,b){a=a?a:"An unexpected persistent error occured.",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=a,this.name=this.constructor.name,b&&(this.cause=b,b.stack&&(this.stack+="\nCaused By: "+b.stack))}});b.exports=c},{}],29:[function(a,b){var c=a("./PersistentError"),d=c.inherit({constructor:function(a){c.call(this,"The transaction has been rollbacked",a)}});b.exports=d},{"./PersistentError":28}],30:[function(a,b,c){c.CommunicationError=a("./CommunicationError"),c.EntityExistsError=a("./EntityExistsError"),c.EntityNotFoundError=a("./EntityNotFoundError"),c.IllegalEntityError=a("./IllegalEntityError"),c.PersistentError=a("./PersistentError"),c.RollbackError=a("./RollbackError")},{"./CommunicationError":24,"./EntityExistsError":25,"./EntityNotFoundError":26,"./IllegalEntityError":27,"./PersistentError":28,"./RollbackError":29}],31:[function(a,b,c){a("jahcode"),a("lie/dist/lie.polyfill"),a("./polyfills");var d=a("./EntityManagerFactory"),e=a("./EntityManager"),f=new d({global:!0});c=b.exports=f.createEntityManager(!0),e.prototype.collection=a("./collection"),e.prototype.binding=a("./binding"),e.prototype.connector=a("./connector"),e.prototype.error=a("./error"),e.prototype.message=a("./message"),e.prototype.metamodel=a("./metamodel"),e.prototype.util=a("./util"),e.prototype.EntityManager=a("./EntityManager"),e.prototype.EntityManagerFactory=a("./EntityManagerFactory"),e.prototype.EntityTransaction=a("./EntityTransaction"),e.prototype.Query=a("./Query"),c.connect=function(a,b){return f.connect(a),this.ready(b)}},{"./EntityManager":1,"./EntityManagerFactory":2,"./EntityTransaction":3,"./Query":5,"./binding":16,"./collection":17,"./connector":23,"./error":30,"./message":32,"./metamodel":48,"./polyfills":49,"./util":60,jahcode:61,"lie/dist/lie.polyfill":62}],32:[function(a,b,c){var d=a("./connector/Message");c.ListAllResources=d.create({method:"GET",path:"/",status:[200]}),c.ApiVersion=d.create({method:"GET",path:"/version",status:[200]}),c.Specification=d.create({method:"GET",path:"/spec",status:[200]}),c.GetBloomFilter=d.create({method:"GET",path:"/replication",status:[200]}),c.GetOrestesConfig=d.create({method:"GET",path:"/config",status:[200]}),c.UpdateOrestesConfig=d.create({method:"PUT",path:"/config",status:[200,202]}),c.Create=d.create({method:"POST",path:"/create",status:[201]}),c.Connect=d.create({method:"GET",path:"/connect",status:[200]}),c.GetBucketNames=d.create({method:"GET",path:"/db",status:[200]}),c.GetBucketIds=d.create({method:"GET",path:"/db/:bucket/ids?start=0&count=-1",status:[200]}),c.ExportBucket=d.create({method:"GET",path:"/db/:bucket?bat=",status:[200]}),c.ImportBucket=d.create({method:"PUT",path:"/db/:bucket?bat=",status:[200]}),c.TruncateBucket=d.create({method:"DELETE",path:"/db/:bucket?bat=",status:[200]}),c.CreateObject=d.create({method:"POST",path:"/db/:bucket",status:[201,202]}),c.GetObject=d.create({method:"GET",path:"/db/:bucket/:oid",status:[200,304]}),c.ReplaceObject=d.create({method:"PUT",path:"/db/:bucket/:oid",status:[200,202]}),c.DeleteObject=d.create({method:"DELETE",path:"/db/:bucket/:oid",status:[202,204]}),c.GetAllSchemas=d.create({method:"GET",path:"/schema",status:[200]}),c.UpdateAllSchemas=d.create({method:"POST",path:"/schema",status:[200]}),c.ReplaceAllSchemas=d.create({method:"PUT",path:"/schema",status:[200]}),c.GetSchema=d.create({method:"GET",path:"/schema/:bucket",status:[200]}),c.UpdateSchema=d.create({method:"POST",path:"/schema/:bucket",status:[200]}),c.ReplaceSchema=d.create({method:"PUT",path:"/schema/:bucket",status:[200]}),c.DeleteSchema=d.create({method:"DELETE",path:"/schema/:bucket",status:[204]}),c.AdhocQuery=d.create({method:"GET",path:"/db/:bucket/query?q&start=0&count=-1&sort=&eager=",status:[200]}),c.AdhocQueryPOST=d.create({method:"POST",path:"/db/:bucket/query?start=0&count=-1&sort=",status:[200]}),c.AdhocCountQuery=d.create({method:"GET",path:"/db/:bucket/count?q",status:[200]}),c.AdhocCountQueryPOST=d.create({method:"POST",path:"/db/:bucket/count",status:[200]}),c.ListQueryResources=d.create({method:"GET",path:"/query",status:[200]}),c.CreateQuery=d.create({method:"POST",path:"/query",status:[201]}),c.ListThisQueryResources=d.create({method:"GET",path:"/query/:qid",status:[200]}),c.GetQueryCode=d.create({method:"GET",path:"/query/:qid/source",status:[200]}),c.RunQuery=d.create({method:"GET",path:"/query/:qid/result?start=0&count=-1",status:[200]}),c.GetQueryParameters=d.create({method:"GET",path:"/query/:qid/parameters",status:[200]}),c.GetActiveTransactions=d.create({method:"GET",path:"/transaction",status:[200]}),c.NewTransaction=d.create({method:"POST",path:"/transaction",status:[201]}),c.ListTransactionalSubresurces=d.create({method:"GET",path:"/transaction/:tid",status:[200]}),c.AbortTransaction=d.create({method:"PUT",path:"/transaction/:tid/aborted",status:[204]}),c.GetTransactionChangeset=d.create({method:"GET",path:"/transaction/:tid/changeset",status:[200]}),c.CommitTransaction=d.create({method:"PUT",path:"/transaction/:tid/committed",status:[200]}),c.ListTransactionResources=d.create({method:"GET",path:"/transaction/:tid/dbview",status:[200]}),c.ListTransactionBucketResources=d.create({method:"GET",path:"/transaction/:tid/dbview/:bucket",status:[200]}),c.GetTransactionStateObject=d.create({method:"GET",path:"/transaction/:tid/dbview/:bucket/:oid",status:[200]}),c.QueryTransactional=d.create({method:"GET",path:"/transaction/:tid/dbview/:bucket?query&start=0&count=-1",status:[200]}),c.RunQueryTransactional=d.create({method:"GET",path:"/transaction/:tid/queryview/:qid/result?start=0&count=-1",status:[200]}),c.UpdatePartially=d.create({method:"POST",path:"/db/:bucket/:oid",status:[204]}),c.UpdateField=d.create({method:"POST",path:"/db/:bucket/:oid/:field",status:[204]}),c.Login=d.create({method:"POST",path:"/db/User/login",status:[200]}),c.Register=d.create({method:"POST",path:"/db/User/register",status:[200]}),c.Me=d.create({method:"GET",path:"/db/User/me",status:[200]}),c.ValidateUser=d.create({method:"GET",path:"/db/User/validate",status:[200]}),c.Logout=d.create({method:"GET",path:"/db/User/logout",status:[204]}),c.NewPassword=d.create({method:"POST",path:"/db/User/password",status:[200]}),c.OAuth2=d.create({method:"GET",path:"/db/User/OAuth/:provider?state=&code=&oauth_verifier=&oauth_token=",status:[200]}),c.OAuth1=d.create({method:"GET",path:"/db/User/OAuth1/:provider",status:[200]}),c.GetBaqendCode=d.create({method:"GET",path:"/code/:bucket/:type",status:[200]}),c.SetBaqendCode=d.create({method:"PUT",path:"/code/:bucket/:type",status:[200]}),c.DeleteBaqendCode=d.create({method:"DELETE",path:"/code/:bucket/:type",status:[204]}),c.PostBaqendModule=d.create({method:"POST",path:"/code/:bucket",status:[200,204]}),c.GetBaqendModule=d.create({method:"GET",path:"/code/:bucket",status:[200,204]}),c.GetAllModules=d.create({method:"GET",path:"/code",status:[200]}),c.ListFiles=d.create({method:"GET",path:"/file/:bucket/ids?start=&count=-1",status:[200]}),c.GetFileBucketAcls=d.create({method:"GET",path:"/file/:bucket",status:[200]}),c.SetFileBucketAcls=d.create({method:"PUT",path:"/file/:bucket",status:[204]}),c.DeleteFileBucket=d.create({method:"DELETE",path:"/file/:bucket",status:[204]}),c.CreateFile=d.create({method:"POST",path:"/file/:bucket",status:[200]}),c.GetFile=d.create({method:"GET",path:"/file/:bucket/:oid",status:[200,304]}),c.SetFileAcl=d.create({method:"POST",path:"/file/:bucket/:oid",status:[204]}),c.ReplaceFile=d.create({method:"PUT",path:"/file/:bucket/:oid",status:[200]}),c.DeleteFile=d.create({method:"DELETE",path:"/file/:bucket/:oid",status:[203]}),c.ListIndexes=d.create({method:"GET",path:"/index/:bucket",status:[200]}),c.CreateDropIndex=d.create({method:"POST",path:"/index/:bucket",status:[202]}),c.DropAllIndexes=d.create({method:"DELETE",path:"/index/:bucket",status:[202]}),c.DeviceRegister=d.create({method:"POST",path:"/db/Device/register",status:[204]}),c.DevicePush=d.create({method:"POST",path:"/db/Device/push",status:[204]}),c.DeviceRegistered=d.create({method:"GET",path:"/db/Device/registered",status:[200]}),c.UploadAPNSCertificate=d.create({method:"POST",path:"/config/APNSCert",status:[204]}),c.GCMAKey=d.create({method:"POST",path:"/config/GCMKey",status:[204]})},{"./connector/Message":20}],33:[function(a,b){var c=a("../binding/Accessor"),d=Object.inherit({extend:{PersistentAttributeType:{BASIC:0,ELEMENT_COLLECTION:1,EMBEDDED:2,MANY_TO_MANY:3,MANY_TO_ONE:4,ONE_TO_MANY:5,ONE_TO_ONE:6}},get isAssociation(){return this.persistentAttributeType>d.PersistentAttributeType.EMBEDDED},get isCollection(){return this.persistentAttributeType==d.PersistentAttributeType.ELEMENT_COLLECTION},isId:!1,isVersion:!1,isAcl:!1,isMetadata:!1,accessor:null,persistentAttributeType:-1,declaringType:null,name:null,order:null,constructor:function(a,b){this.name=a,this.isMetadata=!!b},init:function(a,b){if(this.declaringType)throw new Error("The attribute is already initialized.");this.order=b,this.accessor=new c,this.declaringType=a},getValue:function(a){return this.accessor.getValue(a,this)},setValue:function(a,b){this.accessor.setValue(a,this,b)},getJsonValue:function(){},setJsonValue:function(){},toJSON:function(){}});b.exports=d},{"../binding/Accessor":6}],34:[function(a,b){var c=a("./Type"),d=a("../GeoPoint"),e=c.inherit({persistenceType:c.PersistenceType.BASIC,noResolving:!1,constructor:function(a,b,d){0!=a.indexOf("/db/")&&(a="/db/"+a),c.call(this,a,b),this.noResolving=d},toJsonValue:function(a,b){return null===b||void 0===b?null:this.typeConstructor.asInstance(b)},fromJsonValue:function(a,b){return null===b||void 0===b?null:this.typeConstructor.asInstance(b)},toString:function(){return"BasicType("+this.ref+")"}});e.extend({Boolean:new e("Boolean",Boolean),Double:new e("Double",Number),Integer:new e("Integer",Number),String:new e("String",String),DateTime:new(e.inherit({constructor:function(){e.call(this,"DateTime",Date)},toJsonValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString()),c}})),Date:new(e.inherit({constructor:function(){e.call(this,"Date",Date)},toJsonValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString(),c=c.substring(0,c.indexOf("T"))),c},fromJsonValue:function(a,b){return this.superCall(a,String.isInstance(b)?b+"T00:00Z":b)}})),Time:new(e.inherit({constructor:function(){e.call(this,"Time",Date)},toJsonValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString(),c=c.substring(c.indexOf("T")+1)),c},fromJsonValue:function(a,b){return this.superCall(a,String.isInstance(b)?"1970-01-01T"+b:b)}})),GeoPoint:new e("GeoPoint",d),JsonArray:new(e.inherit({constructor:function(){e.call(this,"JsonArray",Array)},init:function(a){this._enhancer=a},toJsonValue:function(a,b){return b&&b.constructor==Array?b:null}})),JsonObject:new(e.inherit({constructor:function(){e.call(this,"JsonObject",Object)},init:function(a){this._enhancer=a},toJsonValue:function(a,b){return b&&b.constructor==Object?b:null}}))}),b.exports=e},{"../GeoPoint":4,"./Type":47}],35:[function(a,b){var c=a("./PluralAttribute"),d=a("../collection"),e=c.inherit({collectionType:c.CollectionType.COLLECTION,constructor:function(a,b){c.call(this,a,b),this.typeConstructor=d.Collection}});b.exports=e},{"../collection":17,"./PluralAttribute":44}],36:[function(a,b){var c=Object.inherit({extend:{ASC:"asc",DESC:"desc",GEO:"geo",fromJSON:function(a){return new c(a.keys,a.unique)}},drop:!1,constructor:function d(a,b){if(String.isInstance(a)){var c={};c[a]=d.ASC,this.keys=[c]}else if(Array.isInstance(a))this.keys=a;else{if(!Object.isInstance(a))throw new Error("The keys parameter must be an String, Object or Array.");this.keys=[a]}this.unique=b===!0},hasKey:function(a){for(var b=0;b<this.keys.length;b++)if(this.keys[b][a])return!0;return!1},get isCompound(){return this.keys.length>1},get isUnique(){return this.unique},toJSON:function(){return{unique:this.unique,keys:this.keys,drop:this.drop}}});b.exports=c},{}],37:[function(a,b){var c=a("./ManagedType"),d=a("./Type"),e=a("../binding"),f=c.inherit({persistenceType:d.PersistenceType.EMBEDDABLE,constructor:function(a,b){c.call(this,a,b)},createProxyClass:function(){return this._enhancer.createProxy(e.Managed)},createObjectFactory:function(a){return e.ManagedFactory.create(this,a)},toJsonValue:function(a,b){return this.typeConstructor.isInstance(b)&&!b.hasOwnProperty("__metadata")&&(b._metadata={_root:a._root}),this.superCall(a,b)},fromJsonValue:function(a,b,c){return!c&&b&&(c=this.create(),c._metadata._root=a._root),this.superCall(a,b,c)},toString:function(){return"EmbeddableType("+this.ref+")"}});b.exports=f},{"../binding":16,"./ManagedType":40,"./Type":47}],38:[function(a,b){var c=a("../binding"),d=a("./SingularAttribute"),e=a("./BasicType"),f=a("./Type"),g=a("./ManagedType"),h=(a("../util/Metadata"),a("../util/Permission")),i=g.inherit({persistenceType:f.PersistenceType.ENTITY,declaredId:null,declaredVersion:null,declaredAcl:null,superType:null,get id(){return this.declaredId||this.superType.id},get version(){return this.declaredVersion||this.superType.version},get acl(){return this.declaredAcl||this.superType.acl},loadPermission:null,updatePermission:null,insertPermission:null,deletePermission:null,queryPermission:null,schemaSubclassPermission:null,constructor:function(a,b,c){g.call(this,a,c),this.superType=b,this.loadPermission=new h,this.insertPermission=new h,this.updatePermission=new h,this.deletePermission=new h,this.queryPermission=new h,this.schemaSubclassPermission=new h},createProxyClass:function(){var a=this.superType.typeConstructor;if(a===Object)switch(this.name){case"User":a=c.User;break;case"Role":a=c.Role;break;
default:a=c.Entity}return this._enhancer.createProxy(a)},createObjectFactory:function(a){switch(this.name){case"User":return c.UserFactory.create(this,a);case"Device":return c.DeviceFactory.create(this,a);case"Object":return void 0}return c.EntityFactory.create(this,a)},fromJsonValue:function(a,b,c,d){return d?this.superCall(a,b,c):b?a.db.getReference(b):null},toJsonValue:function(a,b,c){return c?this.superCall(a,b):this.typeConstructor.isInstance(b)?(b.attach(a.db),b.id):null},toString:function(){return"EntityType("+this.ref+")"},toJSON:function(){var a=this.superCall();return a.acl.schemaSubclass=this.schemaSubclassPermission,a.acl.insert=this.insertPermission,a.acl.update=this.updatePermission,a.acl["delete"]=this.deletePermission,a.acl.query=this.queryPermission,a}});i.extend({Object:i.inherit({extend:{ref:"/db/Object"},constructor:function(){i.call(this,i.Object.ref,null,Object),this.declaredId=new d("id",e.String,!0),this.declaredId.init(this,0),this.declaredId.isId=!0,this.declaredVersion=new d("version",e.Double,!0),this.declaredVersion.init(this,1),this.declaredVersion.isVersion=!0,this.declaredAcl=new d("acl",e.JsonObject,!0),this.declaredAcl.init(this,2),this.declaredAcl.isAcl=!0,this.declaredAttributes=[this.declaredId,this.declaredVersion,this.declaredAcl]}})}),b.exports=i},{"../binding":16,"../util/Metadata":54,"../util/Permission":56,"./BasicType":34,"./ManagedType":40,"./SingularAttribute":46,"./Type":47}],39:[function(a,b){var c=a("./PluralAttribute"),d=a("../collection"),e=c.inherit({extend:{ref:"/db/collection.List"},collectionType:c.CollectionType.LIST,constructor:function(a,b){c.call(this,a,b),this.typeConstructor=d.List},toJSON:function(){return{name:this.name,type:e.ref+"["+this.elementType.ref+"]",order:this.order}}});b.exports=e},{"../collection":17,"./PluralAttribute":44}],40:[function(a,b){var c=a("../binding"),d=a("../util"),e=a("./Type"),f=a("../util/Permission"),g=a("../collection").Iterator,h=a("../util/Validator"),i=e.inherit({AttributeIterator:Object.inherit(g,{index:0,constructor:function(a){this.types=[];do this.types.push(a);while(a=a.superType)},next:function(){for(var a=this.types.pop();a&&a.declaredAttributes.length==this.index;)a=this.types.pop(),this.index=0;return a?(this.types.push(a),{done:!1,value:a.declaredAttributes[this.index++]}):g.DONE}}),_enhancer:null,declaredAttributes:null,superType:null,schemaAddPermission:null,schemaReplacePermission:null,set validationCode(a){this._validationCode=a?h.compile(this,a):null},get validationCode(){return this._validationCode},_validationCode:null,get typeConstructor(){return this._typeConstructor||(this.typeConstructor=this.createProxyClass()),this._typeConstructor},set typeConstructor(a){if(this._typeConstructor)throw new Error("Type constructor has already been set.");var b=a.prototype instanceof c.Entity;if(this.isEntity){if(!b)throw new TypeError("Entity classes must extends the Entity class.")}else if(!(a.prototype instanceof c.Managed)||b)throw new TypeError("Embeddable classes must extends the Managed class.");this._enhancer.enhance(this,a),this._typeConstructor=a},constructor:function(a,b){e.call(this,0!=a.indexOf("/db/")?"/db/"+a:a,b),this.declaredAttributes=[],this.schemaAddPermission=new f,this.schemaReplacePermission=new f},init:function(a){this._enhancer=a,this._typeConstructor&&!this._enhancer.getIdentifier(this._typeConstructor)&&this._enhancer.setIdentifier(this._typeConstructor,this.ref)},createProxyClass:function(){},createObjectFactory:function(){},create:function(){var a=Object.create(this.typeConstructor.prototype);return Object.defineProperty(a,"_metadata",{value:new d.Metadata(a,this),writable:!1,enumerable:!1,configurable:!0}),a},attributes:function(){return new this.AttributeIterator(this)},addAttribute:function(a,b){if(this.getAttribute(a.name))throw new Error("An attribute with the name "+a.name+" is already declared.");b=null==a.order?"undefined"==typeof b?this.declaredAttributes.length:b:a.order,a.init(this,b),this.declaredAttributes.push(a),this._typeConstructor&&"Object"!=this.name&&this._enhancer.enhanceProperty(this._typeConstructor,a)},removeAttribute:function(a){var b=this.declaredAttributes.length;if(this.declaredAttributes=this.declaredAttributes.filter(function(b){return b.name!=a}),b==this.declaredAttributes.length)throw new Error("An Attribute with the name "+a+" is not declared.")},getAttribute:function(a){var b=this.getDeclaredAttribute(a);return!b&&this.superType&&(b=this.superType.getAttribute(a)),b},getDeclaredAttribute:function(a){for(var b,c=0;b=this.declaredAttributes[c];++c)if(b.name===a||b.order===a)return b;return null},fromJsonValue:function(a,b,c){if(b)for(var d,e=this.attributes();!(d=e.next()).done;){var f=d.value;f.isMetadata||f.setJsonValue(a,c,b[f.name])}else c=null;return c},toJsonValue:function(a,b){var c=null;if(this.typeConstructor.isInstance(b)){c={};for(var d,e=this.attributes();!(d=e.next()).done;){var f=d.value;f.isMetadata||(c[f.name]=f.getJsonValue(a,b))}}return c},toJSON:function(){var a={};a["class"]=this.ref,this.superType&&(a.superClass=this.superType.ref),this.isEmbeddable&&(a.embedded=!0),a.acl={load:this.loadPermission,schemaAdd:this.schemaAddPermission,schemaReplace:this.schemaReplacePermission};for(var b,c=a.fields={},d=0;b=this.declaredAttributes[d];d++)b.isMetadata||(c[b.name]=b);return a},references:function(){return new this.ReferenceIterator(this)},ReferenceIterator:Object.inherit({constructor:function(a){this.type=a,this.attributes=this.type.attributes(),this.embedded=[]},next:function(){for(var a,b=this.attributes;!(a=b.next()).done;){var c=a.value,d=c.isCollection?c.elementType:c.type;if(d.isEntity)return{done:!1,value:{path:[c.name]}};if(d.isEmbeddable)for(var e,f=d.references();!(e=f.next()).done;)this.embedded.push({done:!1,value:{path:[c.name].concat(e.value.path)}})}return this.embedded.length?this.embedded.pop():{done:!0}}})});b.exports=i},{"../binding":16,"../collection":17,"../util":60,"../util/Permission":56,"../util/Validator":59,"./Type":47}],41:[function(a,b){var c=a("./PluralAttribute"),d=a("../collection"),e=a("../error/PersistentError"),f=c.inherit({extend:{ref:"/db/collection.Map"},collectionType:c.CollectionType.MAP,keyType:null,constructor:function(a,b,e){c.call(this,a,e),this.keyType=b,this.typeConstructor=d.Map},getJsonValue:function(a,b){var c=this.getValue(b);if(c){c._metadata||Object.defineProperty(c,"_metadata",{value:{_root:a._root}});for(var d,f={},g=c.entries();!(d=g.next()).done;){if(null===d.value[0]||void 0===d.value[1])throw new e("Map keys can't be null nor undefined.");f[this.keyType.toJsonValue(a,d.value[0])]=this.elementType.toJsonValue(a,d.value[1])}return f}return null},setJsonValue:function(a,b,c){var d=null;if(c){d=this.getValue(b),this.typeConstructor.isInstance(d)||(d=new this.typeConstructor,Object.defineProperty(d,"_metadata",{value:{_root:a._root}}));var e=d.array,f=d.vals;d.array=[],d.vals=[];for(var g in c){g=this.keyType.fromJsonValue(a,g);var h=e.indexOf(g),i=this.elementType.fromJsonValue(a,c[g],-1!=h?f[h]:null);d.set(g,i)}}this.setValue(b,d)},toJSON:function(){return{name:this.name,type:f.ref+"["+this.keyType.ref+","+this.elementType.ref+"]",order:this.order}}});b.exports=f},{"../collection":17,"../error/PersistentError":28,"./PluralAttribute":44}],42:[function(a,b){var c=(a("./BasicType"),a("./ManagedType")),d=a("./EntityType"),e=a("../binding/Enhancer"),f=a("./ModelBuilder"),g=a("./DbIndex"),h=a("../util/Lockable"),i=a("../connector/Message").StatusCode,j=a("../message"),k=Object.inherit(h,{isInitialized:!1,_connector:null,entities:null,embeddables:null,baseTypes:null,constructor:function(){this._enhancer=new e},connected:function(a){this._connector=a},init:function(a){if(a){if(this.isInitialized)throw new Error("Metamodel is already initialized.");this.fromJSON(a||[]),this.isInitialized=!0}else if(!this.isInitialized)return this.load();return this.ready()},_getRef:function(a){var b;return String.isInstance(a)?(b=a,0!=b.indexOf("/db/")&&(b="/db/"+a)):b=this._enhancer.getIdentifier(a),b},entity:function(a){var b=this._getRef(a);return b?this.entities[b]:null},baseType:function(a){var b=null;if(String.isInstance(a))b=this._getRef(a);else for(var c in this.baseTypes){var d=this.baseTypes[c];if(!d.noResolving&&d.typeConstructor==a){b=c;break}}return b?this.baseTypes[b]:null},embeddable:function(a){var b=this._getRef(a);return b?this.embeddables[b]:null},managedType:function(a){return this.baseType(a)||this.entity(a)||this.embeddable(a)},addType:function(a){var b;if(a.isBasic?b=this.baseTypes:a.isEmbeddable?(a.init(this._enhancer),b=this.embeddables):a.isEntity&&(a.init(this._enhancer),b=this.entities,null==a.superType&&a.ref!=d.Object.ref&&(a.superType=this.entity(d.Object.ref))),b[a.ref])throw new Error("The type "+a.ref+" is already declared.");return b[a.ref]=a},load:function(){if(this.isInitialized)throw new Error("Metamodel is already initialized.");return this.withLock(function(){this.isInitialized=!0;var a=new j.GetAllSchemas;return this._connector.send(a).then(function(a){return this.fromJSON(a.response.entity),this}.bind(this))}.bind(this))},save:function(a,b){return c.isInstance(a)||(b=a,a=null),this._send(a||this.toJSON(),b).then(function(){return this}.bind(this))},update:function(a,b){return this._send(a,b).then(function(a){return this.fromJSON(a.response.entity),this}.bind(this))},_send:function(a,b){if(!this.isInitialized)throw new Error("Metamodel is not initialized.");return this.withLock(function(){var d;return d=c.isInstance(a)?new j.UpdateSchema(a.name,a.toJSON()):new j.UpdateAllSchemas(a),d.withAuthorizationToken(b),this._connector.send(d)}.bind(this))},toJSON:function(){var a=[];for(var b in this.entities)a.push(this.entities[b]);for(b in this.embeddables)a.push(this.embeddables[b]);return a},fromJSON:function(a){var b=new f,c=b.buildModels(a);this.baseTypes={},this.embeddables={},this.entities={};for(var d in c){var e=c[d];this.addType(e)}},createIndex:function(a,b,c){b.drop=!1;var d=new j.CreateDropIndex(a,b.toJSON());return d.withAuthorizationToken(c),this._connector.send(d)},dropIndex:function(a,b,c){b.drop=!0;var d=new j.CreateDropIndex(a,b.toJSON());return d.withAuthorizationToken(c),this._connector.send(d)},dropAllIndexes:function(a,b){var c=new j.DropAllIndexes(a);return c.withAuthorizationToken(b),this._connector.send(c)},getIndexes:function(a,b){var c=new j.ListIndexes(a);return c.withAuthorizationToken(b),this._connector.send(c).then(function(a){return a.response.entity.map(function(a){return new g(a.keys,a.unique)})},function(a){if(a.status==i.BUCKET_NOT_FOUND||a.status==i.OBJECT_NOT_FOUND)return null;throw a})}});b.exports=k},{"../binding/Enhancer":8,"../connector/Message":20,"../message":32,"../util/Lockable":52,"./BasicType":34,"./DbIndex":36,"./EntityType":38,"./ManagedType":40,"./ModelBuilder":43}],43:[function(a,b){var c=a("./BasicType"),d=a("./EntityType"),e=a("./EmbeddableType"),f=a("./ListAttribute"),g=a("./MapAttribute"),h=a("./SetAttribute"),i=a("./SingularAttribute"),j=a("../error/PersistentError"),k=Object.inherit({models:null,modelDescriptors:null,constructor:function(){this.models={};for(var a in c)if(c.hasOwnProperty(a)){var b=c[a];b instanceof c&&(this.models[b.ref]=b)}},getModel:function(a){return a in this.models?this.models[a]:this.models[a]=this.buildModel(a)},buildModels:function(a){this.modelDescriptors={};for(var b,c=0;b=a[c];++c)this.modelDescriptors[b["class"]]=b;for(var e in this.modelDescriptors)try{var f=this.getModel(e);this.buildAttributes(f)}catch(g){throw new j("Can't create model for entity class "+e,g)}return this.getModel(d.Object.ref),this.models},buildModel:function(a){var b,c=this.modelDescriptors[a];if(a==d.Object.ref)b=new d.Object;else{if(!c)throw new TypeError("No model available for "+a);if(c.embedded)b=new e(a);else{var f=c.superClass||d.Object.ref;b=new d(a,this.getModel(f))}}if(c){var g=c.acl;for(var h in g)b[h+"Permission"].fromJSON(g[h])}return b},buildAttributes:function(a){var b=this.modelDescriptors[a.ref],c=b.fields;for(var d in c){var e=c[d];a.getAttribute(d)||a.addAttribute(this.buildAttribute(e.name,e.type),e.order)}b.validationCode&&(a.validationCode=b.validationCode)},buildAttribute:function(a,b){if(0!=b.indexOf("/db/collection."))return new i(a,this.getModel(b));var c=b.substring(0,b.indexOf("[")),d=b.substring(b.indexOf("[")+1,b.indexOf("]")).trim();switch(c){case f.ref:return new f(a,this.getModel(d));case h.ref:return new h(a,this.getModel(d));case g.ref:var e=d.substring(0,d.indexOf(",")).trim();return d=d.substring(d.indexOf(",")+1).trim(),new g(a,this.getModel(e),this.getModel(d));default:throw new TypeError("No collection available for "+b)}}});b.exports=k},{"../error/PersistentError":28,"./BasicType":34,"./EmbeddableType":37,"./EntityType":38,"./ListAttribute":39,"./MapAttribute":41,"./SetAttribute":45,"./SingularAttribute":46}],44:[function(a,b){var c=a("./Attribute"),d=c.inherit({extend:{CollectionType:{COLLECTION:0,LIST:1,MAP:2,SET:3}},typeConstructor:null,persistentAttributeType:c.PersistentAttributeType.ELEMENT_COLLECTION,elementType:null,constructor:function(a,b){c.call(this,a),this.elementType=b},getJsonValue:function(a,b){var c=this.getValue(b);if(this.typeConstructor.isInstance(c)){c._metadata||Object.defineProperty(c,"_metadata",{value:{_root:a._root}});for(var d,e=[],f=c.values();!(d=f.next()).done;)e.push(this.elementType.toJsonValue(a,d.value));return e}return null},setJsonValue:function(a,b,c){var d=null;if(c){d=this.getValue(b),this.typeConstructor.isInstance(d)||(d=new this.typeConstructor,Object.defineProperty(d,"_metadata",{value:{_root:a._root}}));var e=d.array;d.array=[];for(var f=0,g=c.length;g>f;++f)d.add(this.elementType.fromJsonValue(a,c[f],e[f]))}this.setValue(b,d)}});b.exports=d},{"./Attribute":33}],45:[function(a,b){var c,d=a("./PluralAttribute"),e=a("../collection"),c=d.inherit({extend:{ref:"/db/collection.Set"},collectionType:d.CollectionType.SET,constructor:function(a,b){d.call(this,a,b),this.typeConstructor=e.Set},toJSON:function(){return{name:this.name,type:c.ref+"["+this.elementType.ref+"]",order:this.order}}});b.exports=c},{"../collection":17,"./PluralAttribute":44}],46:[function(a,b){var c=a("./Attribute"),d=a("./Type"),e=c.inherit({get typeConstructor(){return this.type.typeConstructor},type:null,constructor:function(a,b,e){switch(c.call(this,a,e),this.type=b,b.persistenceType){case d.PersistenceType.BASIC:this.persistentAttributeType=c.PersistentAttributeType.BASIC;break;case d.PersistenceType.EMBEDDABLE:this.persistentAttributeType=c.PersistentAttributeType.EMBEDDED;break;case d.PersistenceType.ENTITY:this.persistentAttributeType=c.PersistentAttributeType.ONE_TO_MANY}},getJsonValue:function(a,b){return this.type.toJsonValue(a,this.getValue(b))},setJsonValue:function(a,b,c){this.setValue(b,this.type.fromJsonValue(a,c,this.getValue(b)))},toJSON:function(){return{name:this.name,type:this.type.ref,order:this.order}}});b.exports=e},{"./Attribute":33,"./Type":47}],47:[function(a,b){var c=Object.inherit({extend:{PersistenceType:{BASIC:0,EMBEDDABLE:1,ENTITY:2,MAPPED_SUPERCLASS:3}},get isBasic(){return this.persistenceType==c.PersistenceType.BASIC},get isEmbeddable(){return this.persistenceType==c.PersistenceType.EMBEDDABLE},get isEntity(){return this.persistenceType==c.PersistenceType.ENTITY},get isMappedSuperclass(){return this.persistenceType==c.PersistenceType.MAPPED_SUPERCLASS},persistenceType:-1,get typeConstructor(){return this._typeConstructor},set typeConstructor(a){if(this._typeConstructor)throw new Error("typeConstructor has already been set.");this._typeConstructor=a},ref:null,name:null,constructor:function(a,b){if(0!=a.indexOf("/db/"))throw new SyntaxError("Type ref "+a+" is invalid.");this.ref=a,this.name=a.substring(4),this._typeConstructor=b},fromJsonValue:function(){},toJsonValue:function(){}});b.exports=c},{}],48:[function(a,b,c){var d=a("./Metamodel");c=b.exports=new d,c.Attribute=a("./Attribute"),c.BasicType=a("./BasicType"),c.CollectionAttribute=a("./CollectionAttribute"),c.EmbeddableType=a("./EmbeddableType"),c.EntityType=a("./EntityType"),c.ListAttribute=a("./ListAttribute"),c.ManagedType=a("./ManagedType"),c.MapAttribute=a("./MapAttribute"),c.Metamodel=a("./Metamodel"),c.ModelBuilder=a("./ModelBuilder"),c.PluralAttribute=a("./PluralAttribute"),c.SetAttribute=a("./SetAttribute"),c.SingularAttribute=a("./SingularAttribute"),c.Type=a("./Type"),c.DbIndex=a("./DbIndex")},{"./Attribute":33,"./BasicType":34,"./CollectionAttribute":35,"./DbIndex":36,"./EmbeddableType":37,"./EntityType":38,"./ListAttribute":39,"./ManagedType":40,"./MapAttribute":41,"./Metamodel":42,"./ModelBuilder":43,"./PluralAttribute":44,"./SetAttribute":45,"./SingularAttribute":46,"./Type":47}],49:[function(){Function.prototype.bind=Function.prototype.bind||function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}},{}],50:[function(a,b){var c=a("./Permission"),d=Object.inherit({read:null,write:null,constructor:function(a){this.read=new c(a),this.write=new c(a)},clear:function(){this.read.clear(),this.write.clear()},isPublicReadAllowed:function(){return this.read.isPublicAllowed()},setPublicReadAllowed:function(){return this.read.setPublicAllowed()},isReadAllowed:function(a){return this.read.isAllowed(a)},isReadDenied:function(a){return this.read.isDenied(a)},allowReadAccess:function(a){return this.read.allowAccess(a),this},denyReadAccess:function(a){return this.read.denyAccess(a),this},deleteReadAccess:function(a){return this.read.deleteAccess(a),this},isPublicWriteAllowed:function(){return this.write.isPublicAllowed()},setPublicWriteAllowed:function(){return this.write.setPublicAllowed()},isWriteAllowed:function(a){return this.write.isAllowed(a)},isWriteDenied:function(a){return this.write.isDenied(a)},allowWriteAccess:function(a){return this.write.allowAccess(a),this},denyWriteAccess:function(a){return this.write.denyAccess(a),this},deleteWriteAccess:function(a){return this.write.deleteAccess(a),this},toJSON:function(){return{read:this.read,write:this.write}},fromJSON:function(a){this.read.fromJSON(a.read||{}),this.write.fromJSON(a.write||{})}});b.exports=d},{"./Permission":56}],51:[function(a,b){var c=a("../message"),d=a("../connector/Message").StatusCode,e=Object.inherit({_connector:null,_metamodel:null,constructor:function(a){this._metamodel=a},connected:function(a){this._connector=a},functionToString:function(a){if(!a)return"";var b=a.toString();return b=b.substring(b.indexOf("{")+1,b.lastIndexOf("}")),"\n"==b.charAt(0)&&(b=b.substring(1)),"\n"==b.charAt(b.length-1)&&(b=b.substring(0,b.length-1)),b},stringToFunction:function(a,b){return new Function(a,b)},loadModules:function(a){var b=new c.GetAllModules;return b.withAuthorizationToken(a),this._connector.send(b).then(function(a){return a.response.entity})},loadCode:function(a,b,e,f){var g=String.isInstance(a)?a:a.name,h=new c.GetBaqendCode(g,b);return h.withAuthorizationToken(e),this._connector.send(h).then(function(a){return this._parseCode(g,b,f,a.response.entity)}.bind(this),function(a){if(a.status==d.OBJECT_NOT_FOUND)return null;throw a})},saveCode:function(a,b,d,e){var f=String.isInstance(a)?a:a.name,g=Function.isInstance(d),h=new c.SetBaqendCode(f,b,g?this.functionToString(d):d);return h.withAuthorizationToken(e),this._connector.send(h).then(function(a){return this._parseCode(f,b,g,a.response.entity)}.bind(this))},deleteCode:function(a,b,d){var e=String.isInstance(a)?a:a.name,f=new c.DeleteBaqendCode(e,b);return f.withAuthorizationToken(d),this._connector.send(f).then(function(){return this._parseCode(e,b,!1,null)}.bind(this))},_parseCode:function(a,b,c,d){if("validate"==b){var e=this._metamodel.entity(a);return e.validationCode=d,c?e.validationCode:d}return c?this.stringToFunction(["module","exports"],d):d}});b.exports=e},{"../connector/Message":20,"../message":32}],52:[function(a,b){var c=Trait.inherit({_isLocked:!1,_readyPromise:Promise.resolve(null),_deferred:null,get isReady(){return!this._isLocked},ready:function(a,b){var c=this;return this._readyPromise.then(function(){return c},function(a){if(c._isLocked)throw a;return c}).then(a,b)},withLock:function(a,b){if(this._isLocked)throw new Error("Current operation has not been finished.");try{return this._isLocked=!0,this._readyPromise=a().then(function(a){return this._isLocked=!1,a}.bind(this),function(a){throw b||(this._isLocked=!1),a}.bind(this))}catch(c){throw b||(this._isLocked=!1),c}}});b.exports=c},{}],53:[function(a,b){var c=a("../message"),d=(a("../connector/Message").StatusCode,Object.inherit({extend:{LEVELS:["trace","debug","info","warn","error"],FORMAT_REGEXP:/%[sdj%]/g,create:function(a){function b(){c.log.apply(b,arguments)}var c=this.prototype;return Object.cloneOwnProperties(b,c),b._init(a),b}},entityManager:null,levelIndex:2,get level(){return d.LEVELS[this.levelIndex]},set level(a){var b=d.LEVELS.indexOf(a);if(-1==b)throw new Error("Unknown logging level "+a);this.levelIndex=b},log:function(a,b,c){var e=Array.prototype.slice.call(arguments);a=-1==d.LEVELS.indexOf(e[0])?"info":e.shift(),this.levelIndex>d.LEVELS.indexOf(a)||(b=this._format(e.shift(),e),c=null,e.length&&"object"==typeof e[e.length-1]&&(c=e.pop()),e.length&&(b+=", "+e.join(", ")),this._log({date:new Date,message:b,level:a,user:this.entityManager.me&&this.entityManager.me.id,data:c}))},_format:function(a,b){if(0==b.length)return a;var c=String(a).replace(d.FORMAT_REGEXP,function(a){if("%%"===a)return"%";if(!b.length)return a;switch(a){case"%s":return String(b.shift());case"%d":return Number(b.shift());case"%j":try{return JSON.stringify(b.shift())}catch(c){return"[Circular]"}default:return a}});return c},_init:function(a){this.entityManager=a,d.LEVELS.forEach(function(a){this[a]=this.log.bind(this,a)}.bind(this))},_log:function(a){this.entityManager.isReady?this.entityManager._send(new c.CreateObject("logs.AppLog",a)):this.entityManager.ready(this._log.bind(this,a))}}));b.exports=d},{"../connector/Message":20,"../message":32}],54:[function(a,b){var c=a("../error/PersistentError"),d=a("./Acl"),e=a("./Lockable"),f=Object.inherit(e,{extend:{Type:{UNAVAILABLE:-1,PERSISTENT:0,DIRTY:1},get:function(a){return a._metadata},getRoot:function(a){var b=a&&a._metadata;return b&&b._root!=a&&(b=b._root&&b._root._metadata),b},readAccess:function(a){var b=f.getRoot(a);b&&b.readAccess()},writeAccess:function(a){var b=f.getRoot(a);b&&b.writeAccess()}},get db(){return this._db?this._db:this._db=a("../")},set db(a){if(this._db)throw new Error("DB has already been set.");this._db=a},get bucket(){return this.type&&this.type.name},get key(){if(!this._key&&this.id){var a=this.id.lastIndexOf("/");this._key=decodeURIComponent(this.id.substring(a+1))}return this._key},get isAttached(){return!!this._db},get isAvailable(){return this._state>f.Type.UNAVAILABLE},get isPersistent(){return this._state==f.Type.PERSISTENT},get isDirty(){return this._state==f.Type.DIRTY},_root:null,_db:null,id:null,version:null,acl:null,type:null,constructor:function g(a,b){this._root=a,this.type=b,this._state=g.Type.DIRTY,this._enabled=!0,this.acl=new d(this)},readAccess:function(){if(this._enabled&&!this.isAvailable)throw new c("This object "+this.bucket+"/"+this.id+" is not available.")},writeAccess:function(){if(this._enabled){if(!this.isAvailable)throw new c("This object "+this.bucket+"/"+this.id+" is not available.");this.setDirty()}},setUnavailable:function(){this._state=f.Type.UNAVAILABLE},setPersistent:function(){this._state=f.Type.PERSISTENT},setDirty:function(){this._state=f.Type.DIRTY},setRemoved:function(){this.setDirty(),this.version=null},getJsonMetadata:function(a){var b={};return this.id&&(b.id=this.id),!a&&this.version&&(b.version=this.version),b.acl=this.acl,b},setJsonMetadata:function(a){this.id||(this.id=a.id),a.version&&(this.version=a.version),this.acl.fromJSON(a.acl||{})},getJson:function(a,b){this._enabled=!1;var c=this.type.toJsonValue(this,this._root,!0);return this._enabled=!0,this.isAttached&&!b&&Object.extend(c,this.getJsonMetadata(a)),c},setJson:function(a){(a.id||a.version||a.acl)&&this.setJsonMetadata(a),this._enabled=!1,this.type.fromJsonValue(this,a,this._root,!0),this._enabled=!0}});b.exports=f},{"../":31,"../error/PersistentError":28,"./Acl":50,"./Lockable":52}],55:[function(a,b){var c=a("../message"),d=Object.inherit({_entityManager:null,_connector:null,constructor:function(a,b){this._entityManager=a,this._connector=b},get:function(a,b,d,e){Function.isInstance(b)&&(e=d,d=b,b=null);var f=new c.GetBaqendModule(a);return f.addQueryString(b),this._send(f,d,e)},post:function(a,b,d,e){var f=new c.PostBaqendModule(a,b);return this._send(f,d,e)},_send:function(a,b,c){return this._entityManager._send(a).then(function(a){return a.response.entity}).then(b,c)}});b.exports=d},{"../message":32}],56:[function(a,b){var c=Object.inherit({_metadata:null,_rules:null,constructor:function(a){this._rules={},this._metadata=a},allRules:function(){return Object.keys(this._rules)},clear:function(){this._metadata&&this._metadata.writeAccess(),this._rules={}},isPublicAllowed:function(){if("*"in this._rules)return!1;for(var a in this._rules)if("allow"==this._rules[a])return!1;return!0},setPublicAllowed:function(){this._metadata&&this._metadata.writeAccess();for(var a in this._rules)"allow"==this._rules[a]&&delete this._rules[a]},getRule:function(a){return this._rules[this._getRef(a)]},isAllowed:function(a){return"allow"==this._rules[this._getRef(a)]},isDenied:function(a){return"deny"==this._rules[this._getRef(a)]},allowAccess:function(a){return this._metadata&&this._metadata.writeAccess(),this._rules[this._getRef(a)]="allow",this},denyAccess:function(a){return this._metadata&&this._metadata.writeAccess(),this._rules[this._getRef(a)]="deny",this},deleteAccess:function(a){return this._metadata&&this._metadata.writeAccess(),delete this._rules[this._getRef(a)],this},toJSON:function(){return this._rules},fromJSON:function(a){this._rules=a},_getRef:function(a){if(String.isInstance(a)||(a=a._metadata.id),0==a.indexOf("/db/User/")||0==a.indexOf("/db/Role/"))return a;throw new TypeError("The given object isn't a user, role or a valid reference.")}});b.exports=c},{}],57:[function(a,b){var c=a("../collection").Set,d=a("../collection").List,e=(a("./Metadata"),a("../binding/Entity")),f=Object.inherit({devices:null,message:null,subject:null,sound:null,badge:0,data:null,constructor:function(a,b,f,g,h,i){if(Array.isInstance(a)||d.isInstance(a)||!a)this.devices=new c(a);else if(e.isInstance(a))this.devices=new c,this.devices.add(a);else if(!c.isInstance(a))throw new Error("Only Sets, Lists and Arrays can be used as devices.");this.message=b,this.subject=f,this.sound=g,this.badge=h,this.data=i},addDevice:function(a){this.devices?Array.isInstance(this.devices)&&(this.devices=new c(this.devices)):this.devices=new c,this.devices.add(a)},toJSON:function(){if((Array.isInstance(this.devices)||d.isInstance(this.devices))&&(this.devices=new c(this.devices)),!this.devices||!this.devices.size)throw new Error("Set of devices is empty.");return Object.extend(Object.extend({},this),{devices:this.devices.map(function(a){return a.id})})}});b.exports=f},{"../binding/Entity":9,"../collection":17,"./Metadata":54}],58:[function(a,b){var c=Object.inherit({fields:null,get isValid(){for(var a in this.fields)if(!this.fields[a].isValid)return!1;return!0},constructor:function(){this.fields={}},toJSON:function(){var a={};for(var b in this.fields)a[b]=this.fields[b].toJSON();return a}});b.exports=c},{}],59:[function(a,b){var c=a("validator"),d=(a("./ValidationResult"),Object.inherit({extend:{initialize:function(){Object.keys(c).forEach(function(a){"function"==typeof c[a]&&"toString"!==a&&"toDate"!==a&&"extend"!==a&&"init"!==a&&(this.prototype[a]=function(b){return this._callMethod(a,b||a,Array.prototype.slice.call(arguments,b?1:0))})}.bind(this))},compile:function(a,b){for(var c,d=[],e=a.attributes();!(c=e.next()).done;)d.push(c.value.name);var f=new Function(d,b);return function(a){var b=d.map(function(b){return a[b]});return f.apply({},b)}}},key:null,errors:null,_entity:null,get value(){return this._entity[this.key]},get isValid(){return 0==this.errors.length},is:function(a,b){return Function.isInstance(a)&&(b=a,a="is"),b(this.value,c)===!1&&this.errors.push(a),this},constructor:function(a,b){this.key=a,this._entity=b,this.errors=[]},_callMethod:function(a,b,d){return d=d||[],d.unshift(this.value),c[a].apply(this,d)===!1&&this.errors.push(b),this},toString:function(){return this.value},toJSON:function(){return{isValid:this.isValid,errors:this.errors}}}));b.exports=d},{"./ValidationResult":58,validator:64}],60:[function(a,b,c){c.Metadata=a("./Metadata"),c.Permission=a("./Permission"),c.Acl=a("./Acl"),c.Validator=a("./Validator"),c.ValidationResult=a("./ValidationResult"),c.Code=a("./Code"),c.Modules=a("./Modules"),c.Lockable=a("./Lockable"),c.Logger=a("./Logger"),c.uuid=a("node-uuid").v4,c.PushMessage=a("./PushMessage")},{"./Acl":50,"./Code":51,"./Lockable":52,"./Logger":53,"./Metadata":54,"./Modules":55,"./Permission":56,"./PushMessage":57,"./ValidationResult":58,"./Validator":59,"node-uuid":63}],61:[function(){!function(a){var b=Object.getPrototypeOf({constructor:String})==String.prototype;Function.prototype.extend||(Function.prototype.extend=function(a,b){b||(b=a,a=this);for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}),Object.extend(Function.prototype,{linearizedTypes:[Object],inherit:function(){for(var a=arguments[arguments.length-1],b=a.constructor!==Object?a.constructor:function(a){return this instanceof b?void(this.initialize&&(arguments.length?this.initialize.apply(this,arguments):this.initialize())):b.asInstance(a)},c=Object.createPrototypeChain(b,this,Array.prototype.slice.call(arguments,0,arguments.length-1)),d=Object.getOwnPropertyNames(a),e=0;e<d.length;++e){var f=d[e],g=!1;if(Object.properties.hasOwnProperty(f)&&(g=Object.properties[f](c,a,f)),!g){var h=Object.getOwnPropertyDescriptor(a,f);if(h.value){var i=h.value;i instanceof Function?/this\.superCall/.test(i.toString())&&(h.value=Object.createSuperCallWrapper(b,f,i)):i&&(i.hasOwnProperty("get")||i.hasOwnProperty("value"))&&(h=i)}Object.defineProperty(c,f,h)}}return b.initialize&&b.initialize(),b},isA:function(a){return this.prototype instanceof a||-1!=this.linearizedTypes.lastIndexOf(a)},isInstance:function(a){return null===a||void 0===a?!1:Object(a)instanceof this||-1!=d(a).linearizedTypes.lastIndexOf(this)},asInstance:function(a){return this.isInstance(a)?a:this.conv(a)},conv:function(){return null}}),Object.extend({properties:{},cloneOwnProperties:function(a,b){for(var c=Object.getOwnPropertyNames(b),d=0;d<c.length;++d){var e=c[d];if("__proto__"!=e){var f=Object.getOwnPropertyDescriptor(b,e);Object.defineProperty(a,e,f)}}},createPrototypeChain:function(a,c,d){for(var f,g=c.prototype,h=c.linearizedTypes.slice(),i=c.prototypeChain?c.prototypeChain.slice():[g],j=0;f=d[j];++j){if(!(f.prototype instanceof e))throw new TypeError("Only traits can be mixed in.");for(var k,l=f.linearizedTypes,m=0;k=l[m];++m)-1==h.indexOf(k)&&k!=e&&(g=Object.create(g),Object.cloneOwnProperties(g,k.wrappedPrototype?k.wrappedPrototype:k.prototype),g.constructor=k,h.push(k),i.push(g))}return g=Object.create(g),g.constructor=a,h.push(a),i.push(g),b?(a.wrappedPrototype=g,a.prototype=Object.create(g)):a.prototype=g,a.linearizedTypes=h,a.prototypeChain=i,g},createSuperCallWrapper:function(a,b,c){var e=function(){var c=d(this),e=c.linearizedTypes.lastIndexOf(a);if(-1==e)throw new ReferenceError("superCall can't determine any super method");var f=c.prototypeChain[e-1];return"initialize"!=b||f[b]?arguments.length?f[b].apply(this,arguments):f[b].call(this):void 0};return function(){var a=this.superCall;this.superCall=e;

try{return arguments.length?c.apply(this,arguments):c.call(this)}finally{a?this.superCall=a:delete this.superCall}}}}),Object.extend(Object.properties,{initialize:function(a,b){var c=b.initialize,f=/this\.superCall/.test(c.toString());if(a instanceof e){if(f)throw new TypeError("Trait constructors can not call super constructors directly.");b.initialize=function(){arguments.length?this.superCall.apply(this,arguments):this.superCall.call(this),c.call(this)}}else f||d(a)==Object||(b.initialize=function(){this.superCall.call(this),arguments.length?c.apply(this,arguments):c.call(this)})},extend:function(a,b){return Object.extend(a.constructor,b.extend),!0}});for(var c,d=function(a){return null===a||void 0===a?a:Object.getPrototypeOf(Object(a)).constructor},e=Object.inherit({}),f=(e.inherit({extend:{initialize:function(){try{Object.defineProperty(this.prototype,"bind",{get:function(){return this.bind=f.create(this)},set:function(a){Object.defineProperty(this,"bind",{value:a})},configurable:!0}),this.Object=Object.inherit({initialize:function(a){this.self=a}})}catch(a){this.Object=Object.inherit({initialize:function(a){this.self=a;var b=this;f.each(a,function(a,c){b[a]=c.bind(b.self)})}})}},create:function(a){if(!a.constructor.Bind)try{var b={};f.each(a,function(a,c){b[a]={get:function(){return this[a]=c.bind(this.self)},set:function(b){Object.defineProperty(this,a,{value:b})},configurable:!0}}),a.constructor.Bind=f.Object.inherit(b)}catch(c){a.constructor.Bind=f.Object.inherit({})}return new a.constructor.Bind(a)},each:function(a,b){var c=Object.getPrototypeOf(a);for(var d in c){var e=c[d];"initialize"!=d&&"constructor"!=d&&e instanceof Function&&b(d,e)}}},initialize:function(){"bind"in this||(this.bind=f.create(this))}})),g=[Boolean,Number,String,Function,RegExp,Error],h=0;c=g[h];++h)c.conv=c;Date.conv=function(a){return new Date(a)},Array.conv=function(a){return Array.prototype.slice.call(a)},Array.prototype.initialize=function(){for(var a=0;a<arguments.length;++a)this[a]=arguments[a];this.length=arguments.length},Error.prototype.initialize=function(a){var b=(new Error).stack||"Error";b=b.substring(b.indexOf("\n")+1),this.stack=a+"\n"+b,this.message=a},TypeError instanceof Error&&(Error.prototype.isInstance=Error.isInstance,Error.prototype.asInstance=Error.asInstance,Error.prototype.conv=Error.conv),Object.extend(a,{classOf:d,Trait:e,Bind:f})}("undefined"!=typeof window?window:global)},{}],62:[function(a){!function b(c,d,e){function f(h,i){if(!d[h]){if(!c[h]){var j="function"==typeof a&&a;if(!i&&j)return j(h,!0);if(g)return g(h,!0);var k=new Error("Cannot find module '"+h+"'");throw k.code="MODULE_NOT_FOUND",k}var l=d[h]={exports:{}};c[h][0].call(l.exports,function(a){var b=c[h][1][a];return f(b?b:a)},l,l.exports,b,c,d,e)}return d[h].exports}for(var g="function"==typeof a&&a,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(a){(function(b){"use strict";"function"!=typeof b.Promise&&(b.Promise=a("./index"))}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./index":5}],2:[function(a,b){"use strict";function c(){}b.exports=c},{}],3:[function(a,b){"use strict";function c(a){function b(a,b){function d(a){j[b]=a,++k===c&!i&&(i=!0,h.resolve(m,j))}f(a).then(d,function(a){i||(i=!0,h.reject(m,a))})}if("[object Array]"!==Object.prototype.toString.call(a))return e(new TypeError("must be an array"));var c=a.length,i=!1;if(!c)return f([]);for(var j=new Array(c),k=0,l=-1,m=new d(g);++l<c;)b(a[l],l);return m}var d=a("./promise"),e=a("./reject"),f=a("./resolve"),g=a("./INTERNAL"),h=a("./handlers");b.exports=c},{"./INTERNAL":2,"./handlers":4,"./promise":6,"./reject":9,"./resolve":10}],4:[function(a,b,c){"use strict";function d(a){var b=a&&a.then;return a&&"object"==typeof a&&"function"==typeof b?function(){b.apply(a,arguments)}:void 0}var e=a("./tryCatch"),f=a("./resolveThenable"),g=a("./states");c.resolve=function(a,b){var h=e(d,b);if("error"===h.status)return c.reject(a,h.value);var i=h.value;if(i)f.safely(a,i);else{a.state=g.FULFILLED,a.outcome=b;for(var j=-1,k=a.queue.length;++j<k;)a.queue[j].callFulfilled(b)}return a},c.reject=function(a,b){a.state=g.REJECTED,a.outcome=b;for(var c=-1,d=a.queue.length;++c<d;)a.queue[c].callRejected(b);return a}},{"./resolveThenable":11,"./states":12,"./tryCatch":13}],5:[function(a,b,c){b.exports=c=a("./promise"),c.resolve=a("./resolve"),c.reject=a("./reject"),c.all=a("./all"),c.race=a("./race")},{"./all":3,"./promise":6,"./race":8,"./reject":9,"./resolve":10}],6:[function(a,b){"use strict";function c(a){if(!(this instanceof c))return new c(a);if("function"!=typeof a)throw new TypeError("resolver must be a function");this.state=g.PENDING,this.queue=[],this.outcome=void 0,a!==e&&f.safely(this,a)}var d=a("./unwrap"),e=a("./INTERNAL"),f=a("./resolveThenable"),g=a("./states"),h=a("./queueItem");b.exports=c,c.prototype["catch"]=function(a){return this.then(null,a)},c.prototype.then=function(a,b){if("function"!=typeof a&&this.state===g.FULFILLED||"function"!=typeof b&&this.state===g.REJECTED)return this;var f=new c(e);if(this.state!==g.PENDING){var i=this.state===g.FULFILLED?a:b;d(f,i,this.outcome)}else this.queue.push(new h(f,a,b));return f}},{"./INTERNAL":2,"./queueItem":7,"./resolveThenable":11,"./states":12,"./unwrap":14}],7:[function(a,b){"use strict";function c(a,b,c){this.promise=a,"function"==typeof b&&(this.onFulfilled=b,this.callFulfilled=this.otherCallFulfilled),"function"==typeof c&&(this.onRejected=c,this.callRejected=this.otherCallRejected)}var d=a("./handlers"),e=a("./unwrap");b.exports=c,c.prototype.callFulfilled=function(a){d.resolve(this.promise,a)},c.prototype.otherCallFulfilled=function(a){e(this.promise,this.onFulfilled,a)},c.prototype.callRejected=function(a){d.reject(this.promise,a)},c.prototype.otherCallRejected=function(a){e(this.promise,this.onRejected,a)}},{"./handlers":4,"./unwrap":14}],8:[function(a,b){"use strict";function c(a){function b(a){f(a).then(function(a){i||(i=!0,h.resolve(k,a))},function(a){i||(i=!0,h.reject(k,a))})}if("[object Array]"!==Object.prototype.toString.call(a))return e(new TypeError("must be an array"));var c=a.length,i=!1;if(!c)return f([]);for(var j=-1,k=new d(g);++j<c;)b(a[j]);return k}var d=a("./promise"),e=a("./reject"),f=a("./resolve"),g=a("./INTERNAL"),h=a("./handlers");b.exports=c},{"./INTERNAL":2,"./handlers":4,"./promise":6,"./reject":9,"./resolve":10}],9:[function(a,b){"use strict";function c(a){var b=new d(e);return f.reject(b,a)}var d=a("./promise"),e=a("./INTERNAL"),f=a("./handlers");b.exports=c},{"./INTERNAL":2,"./handlers":4,"./promise":6}],10:[function(a,b){"use strict";function c(a){if(a)return a instanceof d?a:f.resolve(new d(e),a);var b=typeof a;switch(b){case"boolean":return g;case"undefined":return i;case"object":return h;case"number":return j;case"string":return k}}var d=a("./promise"),e=a("./INTERNAL"),f=a("./handlers");b.exports=c;var g=f.resolve(new d(e),!1),h=f.resolve(new d(e),null),i=f.resolve(new d(e),void 0),j=f.resolve(new d(e),0),k=f.resolve(new d(e),"")},{"./INTERNAL":2,"./handlers":4,"./promise":6}],11:[function(a,b,c){"use strict";function d(a,b){function c(b){h||(h=!0,e.reject(a,b))}function d(b){h||(h=!0,e.resolve(a,b))}function g(){b(d,c)}var h=!1,i=f(g);"error"===i.status&&c(i.value)}var e=a("./handlers"),f=a("./tryCatch");c.safely=d},{"./handlers":4,"./tryCatch":13}],12:[function(a,b,c){c.REJECTED=["REJECTED"],c.FULFILLED=["FULFILLED"],c.PENDING=["PENDING"]},{}],13:[function(a,b){"use strict";function c(a,b){var c={};try{c.value=a(b),c.status="success"}catch(d){c.status="error",c.value=d}return c}b.exports=c},{}],14:[function(a,b){"use strict";function c(a,b,c){d(function(){var d;try{d=b(c)}catch(f){return e.reject(a,f)}d===a?e.reject(a,new TypeError("Cannot resolve promise with itself")):e.resolve(a,d)})}var d=a("immediate"),e=a("./handlers");b.exports=c},{"./handlers":4,immediate:16}],15:[function(){},{}],16:[function(a,b){"use strict";function c(){e=!0;for(var a,b,c=h.length;c;){for(b=h,h=[],a=-1;++a<c;)b[a]();c=h.length}e=!1}function d(a){1!==h.push(a)||e||f()}for(var e,f,g=[a("./nextTick"),a("./mutation.js"),a("./messageChannel"),a("./stateChange"),a("./timeout")],h=[],i=-1,j=g.length;++i<j;)if(g[i]&&g[i].test&&g[i].test()){f=g[i].install(c);break}b.exports=d},{"./messageChannel":17,"./mutation.js":18,"./nextTick":15,"./stateChange":19,"./timeout":20}],17:[function(a,b,c){(function(a){"use strict";c.test=function(){return a.setImmediate?!1:"undefined"!=typeof a.MessageChannel},c.install=function(b){var c=new a.MessageChannel;return c.port1.onmessage=b,function(){c.port2.postMessage(0)}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],18:[function(a,b,c){(function(a){"use strict";var b=a.MutationObserver||a.WebKitMutationObserver;c.test=function(){return b},c.install=function(c){var d=0,e=new b(c),f=a.document.createTextNode("");return e.observe(f,{characterData:!0}),function(){f.data=d=++d%2}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],19:[function(a,b,c){(function(a){"use strict";c.test=function(){return"document"in a&&"onreadystatechange"in a.document.createElement("script")},c.install=function(b){return function(){var c=a.document.createElement("script");return c.onreadystatechange=function(){b(),c.onreadystatechange=null,c.parentNode.removeChild(c),c=null},a.document.documentElement.appendChild(c),b}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],20:[function(a,b,c){"use strict";c.test=function(){return!0},c.install=function(a){return function(){setTimeout(a,0)}}},{}]},{},[1])},{}],63:[function(b,c){!function(d){"use strict";function e(){var a=d.crypto||d.msCrypto;if(!k&&a&&a.getRandomValues)try{var b=new Uint8Array(16);n=k=function(){return a.getRandomValues(b),b},k()}catch(c){}if(!k){var e=new Array(16);l=k=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),e[b]=a>>>((3&b)<<3)&255;return e},"undefined"!=typeof console&&console.warn&&console.warn("[SECURITY] node-uuid: crypto not usable, falling back to insecure Math.random()")}}function f(){if("function"==typeof b)try{var a=b("crypto").randomBytes;m=k=a&&function(){return a(16)},k()}catch(c){}}function g(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>e&&(b[d+e++]=r[a])});16>e;)b[d+e++]=0;return b}function h(a,b){var c=b||0,d=q;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function i(a,b,c){var d=b&&c||0,e=b||[];a=a||{};var f=null!=a.clockseq?a.clockseq:v,g=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:x+1,j=g-w+(i-x)/1e4;if(0>j&&null==a.clockseq&&(f=f+1&16383),(0>j||g>w)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");w=g,x=i,v=f,g+=122192928e5;var k=(1e4*(268435455&g)+i)%4294967296;e[d++]=k>>>24&255,e[d++]=k>>>16&255,e[d++]=k>>>8&255,e[d++]=255&k;var l=g/4294967296*1e4&268435455;e[d++]=l>>>8&255,e[d++]=255&l,e[d++]=l>>>24&15|16,e[d++]=l>>>16&255,e[d++]=f>>>8|128,e[d++]=255&f;for(var m=a.node||u,n=0;6>n;n++)e[d+n]=m[n];return b?b:h(e)}function j(a,b,c){var d=b&&c||0;"string"==typeof a&&(b="binary"===a?new p(16):null,a=null),a=a||{};var e=a.random||(a.rng||k)();if(e[6]=15&e[6]|64,e[8]=63&e[8]|128,b)for(var f=0;16>f;f++)b[d+f]=e[f];return b||h(e)}var k,l,m,n,o;d?e():f();for(var p="function"==typeof Buffer?Buffer:Array,q=[],r={},s=0;256>s;s++)q[s]=(s+256).toString(16).substr(1),r[q[s]]=s;var t=k(),u=[1|t[0],t[1],t[2],t[3],t[4],t[5]],v=16383&(t[6]<<8|t[7]),w=0,x=0,y=j;y.v1=i,y.v4=j,y.parse=g,y.unparse=h,y.BufferClass=p,y._rng=k,y._mathRNG=l,y._nodeRNG=m,y._whatwgRNG=n,"undefined"!=typeof c&&c.exports?c.exports=y:"function"==typeof a&&a.amd?a(function(){return y}):(o=d.uuid,y.noConflict=function(){return d.uuid=o,y},d.uuid=y)}("undefined"!=typeof window?window:null)},{crypto:void 0}],64:[function(b,c,d){!function(b,e){"undefined"!=typeof d&&"undefined"!=typeof c?c.exports=e():"function"==typeof a&&"object"==typeof a.amd?a(e):this[b]=e()}("validator",function(a){"use strict";function b(a,b){a=a||{};for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a}function c(a){var b="(\\"+a.symbol.replace(/\./g,"\\.")+")"+(a.require_symbol?"":"?"),c="-?",d="[1-9]\\d*",e="[1-9]\\d{0,2}(\\"+a.thousands_separator+"\\d{3})*",f=["0",d,e],g="("+f.join("|")+")?",h="(\\"+a.decimal_separator+"\\d{2})?",i=g+h;return a.allow_negatives&&!a.parens_for_negatives&&(a.negative_sign_after_digits?i+=c:a.negative_sign_before_digits&&(i=c+i)),a.allow_negative_sign_placeholder?i="( (?!\\-))?"+i:a.allow_space_after_symbol?i=" ?"+i:a.allow_space_after_digits&&(i+="( (?!$))?"),a.symbol_after_digits?i+=b:i=b+i,a.allow_negatives&&(a.parens_for_negatives?i="(\\("+i+"\\)|"+i+")":a.negative_sign_before_digits||a.negative_sign_after_digits||(i=c+i)),new RegExp("^(?!-? )(?=.*\\d)"+i+"$")}a={version:"3.43.0"};var d=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e])|(\\[\x01-\x09\x0b\x0c\x0d-\x7f])))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))$/i,e=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))$/i,f=/^(?:[a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~\.]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(?:[a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~\.]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\s)*<(.+)>$/i,g=/^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})$/,h=/^[A-Z]{2}[0-9A-Z]{9}[0-9]$/,i=/^(?:[0-9]{9}X|[0-9]{10})$/,j=/^(?:[0-9]{13})$/,k=/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/,l=/^[0-9A-F]{1,4}$/i,m={3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,all:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i},n=/^[A-Z]+$/i,o=/^[0-9A-Z]+$/i,p=/^[-+]?[0-9]+$/,q=/^(?:[-+]?(?:0|[1-9][0-9]*))$/,r=/^(?:[-+]?(?:[0-9]+))?(?:\.[0-9]*)?(?:[eE][\+\-]?(?:[0-9]+))?$/,s=/^[0-9A-F]+$/i,t=/^[-+]?[0-9]*(\.[0-9]+)?$/,u=/^#?([0-9A-F]{3}|[0-9A-F]{6})$/i,v=/^[\x00-\x7F]+$/,w=/[^\x00-\x7F]/,x=/[^\u0020-\u007E\uFF61-\uFF9F\uFFA0-\uFFDC\uFFE8-\uFFEE0-9a-zA-Z]/,y=/[\u0020-\u007E\uFF61-\uFF9F\uFFA0-\uFFDC\uFFE8-\uFFEE0-9a-zA-Z]/,z=/[\uD800-\uDBFF][\uDC00-\uDFFF]/,A=/^(?:[A-Z0-9+\/]{4})*(?:[A-Z0-9+\/]{2}==|[A-Z0-9+\/]{3}=|[A-Z0-9+\/]{4})$/i,B={"zh-CN":/^(\+?0?86\-?)?1[345789]\d{9}$/,"en-ZA":/^(\+?27|0)\d{9}$/,"en-AU":/^(\+?61|0)4\d{8}$/,"en-HK":/^(\+?852\-?)?[569]\d{3}\-?\d{4}$/,"fr-FR":/^(\+?33|0)[67]\d{8}$/,"pt-PT":/^(\+351)?9[1236]\d{7}$/,"el-GR":/^(\+30)?((2\d{9})|(69\d{8}))$/,"en-GB":/^(\+?44|0)7\d{9}$/,"en-US":/^(\+?1)?[2-9]\d{2}[2-9](?!11)\d{6}$/,"en-ZM":/^(\+26)?09[567]\d{7}$/,"ru-RU":/^(\+?7|8)?9\d{9}$/};a.extend=function(b,c){a[b]=function(){var b=Array.prototype.slice.call(arguments);return b[0]=a.toString(b[0]),c.apply(a,b)}},a.init=function(){for(var b in a)"function"==typeof a[b]&&"toString"!==b&&"toDate"!==b&&"extend"!==b&&"init"!==b&&a.extend(b,a[b])},a.toString=function(a){return"object"==typeof a&&null!==a&&a.toString?a=a.toString():null===a||"undefined"==typeof a||isNaN(a)&&!a.length?a="":"string"!=typeof a&&(a+=""),a},a.toDate=function(a){return"[object Date]"===Object.prototype.toString.call(a)?a:(a=Date.parse(a),isNaN(a)?null:new Date(a))},a.toFloat=function(a){return parseFloat(a)},a.toInt=function(a,b){return parseInt(a,b||10)},a.toBoolean=function(a,b){return b?"1"===a||"true"===a:"0"!==a&&"false"!==a&&""!==a},a.equals=function(b,c){return b===a.toString(c)},a.contains=function(b,c){return b.indexOf(a.toString(c))>=0},a.matches=function(a,b,c){return"[object RegExp]"!==Object.prototype.toString.call(b)&&(b=new RegExp(b,c)),b.test(a)};var C={allow_display_name:!1,allow_utf8_local_part:!0,require_tld:!0};a.isEmail=function(c,g){if(g=b(g,C),g.allow_display_name){var h=c.match(f);h&&(c=h[1])}else if(/\s/.test(c))return!1;var i=c.split("@"),j=i.pop(),k=i.join("@"),l=j.toLowerCase();return("gmail.com"===l||"googlemail.com"===l)&&(k=k.replace(/\./g,"").toLowerCase()),a.isFQDN(j,{require_tld:g.require_tld})?g.allow_utf8_local_part?e.test(k):d.test(k):!1};var D={protocols:["http","https","ftp"],require_tld:!0,require_protocol:!1,require_valid_protocol:!0,allow_underscores:!1,allow_trailing_dot:!1,allow_protocol_relative_urls:!1};a.isURL=function(c,d){if(!c||c.length>=2083||/\s/.test(c))return!1;if(0===c.indexOf("mailto:"))return!1;d=b(d,D);var e,f,g,h,i,j,k;if(k=c.split("://"),k.length>1){if(e=k.shift(),d.require_valid_protocol&&-1===d.protocols.indexOf(e))return!1}else{if(d.require_protocol)return!1;d.allow_protocol_relative_urls&&"//"===c.substr(0,2)&&(k[0]=c.substr(2))}return c=k.join("://"),k=c.split("#"),c=k.shift(),k=c.split("?"),c=k.shift(),k=c.split("/"),c=k.shift(),k=c.split("@"),k.length>1&&(f=k.shift(),f.indexOf(":")>=0&&f.split(":").length>2)?!1:(h=k.join("@"),k=h.split(":"),g=k.shift(),k.length&&(j=k.join(":"),i=parseInt(j,10),!/^[0-9]+$/.test(j)||0>=i||i>65535)?!1:a.isIP(g)||a.isFQDN(g,d)||"localhost"===g?d.host_whitelist&&-1===d.host_whitelist.indexOf(g)?!1:d.host_blacklist&&-1!==d.host_blacklist.indexOf(g)?!1:!0:!1)},a.isIP=function(b,c){if(c=a.toString(c),!c)return a.isIP(b,4)||a.isIP(b,6);if("4"===c){if(!k.test(b))return!1;var d=b.split(".").sort(function(a,b){return a-b});return d[3]<=255}if("6"===c){var e=b.split(":"),f=!1,g=a.isIP(e[e.length-1],4),h=g?7:8;if(e.length>h)return!1;if("::"===b)return!0;"::"===b.substr(0,2)?(e.shift(),e.shift(),f=!0):"::"===b.substr(b.length-2)&&(e.pop(),e.pop(),f=!0);for(var i=0;i<e.length;++i)if(""===e[i]&&i>0&&i<e.length-1){if(f)return!1;f=!0}else if(g&&i==e.length-1);else if(!l.test(e[i]))return!1;return f?e.length>=1:e.length===h}return!1};var E={require_tld:!0,allow_underscores:!1,allow_trailing_dot:!1};a.isFQDN=function(a,c){c=b(c,E),c.allow_trailing_dot&&"."===a[a.length-1]&&(a=a.substring(0,a.length-1));var d=a.split(".");if(c.require_tld){var e=d.pop();if(!d.length||!/^([a-z\u00a1-\uffff]{2,}|xn[a-z0-9-]{2,})$/i.test(e))return!1}for(var f,g=0;g<d.length;g++){if(f=d[g],c.allow_underscores){if(f.indexOf("__")>=0)return!1;f=f.replace(/_/g,"")}if(!/^[a-z\u00a1-\uffff0-9-]+$/i.test(f))return!1;if("-"===f[0]||"-"===f[f.length-1]||f.indexOf("---")>=0)return!1}return!0},a.isBoolean=function(a){return["true","false","1","0"].indexOf(a)>=0},a.isAlpha=function(a){return n.test(a)},a.isAlphanumeric=function(a){return o.test(a)},a.isNumeric=function(a){return p.test(a)},a.isDecimal=function(a){return t.test(a)},a.isHexadecimal=function(a){return s.test(a)},a.isHexColor=function(a){return u.test(a)},a.isLowercase=function(a){return a===a.toLowerCase()},a.isUppercase=function(a){return a===a.toUpperCase()},a.isInt=function(a,b){return b=b||{},q.test(a)&&(!b.hasOwnProperty("min")||a>=b.min)&&(!b.hasOwnProperty("max")||a<=b.max)},a.isFloat=function(a,b){return b=b||{},""!==a&&r.test(a)&&(!b.hasOwnProperty("min")||a>=b.min)&&(!b.hasOwnProperty("max")||a<=b.max)},a.isDivisibleBy=function(b,c){return a.toFloat(b)%a.toInt(c)===0},a.isNull=function(a){return 0===a.length},a.isLength=function(a,b,c){var d=a.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g)||[],e=a.length-d.length;return e>=b&&("undefined"==typeof c||c>=e)},a.isByteLength=function(a,b,c){return a.length>=b&&("undefined"==typeof c||a.length<=c)},a.isUUID=function(a,b){var c=m[b?b:"all"];return c&&c.test(a)},a.isDate=function(a){return!isNaN(Date.parse(a))},a.isAfter=function(b,c){var d=a.toDate(c||new Date),e=a.toDate(b);return!!(e&&d&&e>d)},a.isBefore=function(b,c){var d=a.toDate(c||new Date),e=a.toDate(b);return e&&d&&d>e},a.isIn=function(b,c){var d;if("[object Array]"===Object.prototype.toString.call(c)){var e=[];for(d in c)e[d]=a.toString(c[d]);return e.indexOf(b)>=0}return"object"==typeof c?c.hasOwnProperty(b):c&&"function"==typeof c.indexOf?c.indexOf(b)>=0:!1},a.isCreditCard=function(a){var b=a.replace(/[^0-9]+/g,"");if(!g.test(b))return!1;for(var c,d,e,f=0,h=b.length-1;h>=0;h--)c=b.substring(h,h+1),d=parseInt(c,10),e?(d*=2,f+=d>=10?d%10+1:d):f+=d,e=!e;return!!(f%10===0?b:!1)},a.isISIN=function(a){if(!h.test(a))return!1;for(var b,c,d=a.replace(/[A-Z]/g,function(a){return parseInt(a,36)}),e=0,f=!0,g=d.length-2;g>=0;g--)b=d.substring(g,g+1),c=parseInt(b,10),f?(c*=2,e+=c>=10?c+1:c):e+=c,f=!f;return parseInt(a.substr(a.length-1),10)===(1e4-e)%10},a.isISBN=function(b,c){if(c=a.toString(c),!c)return a.isISBN(b,10)||a.isISBN(b,13);var d,e=b.replace(/[\s-]+/g,""),f=0;if("10"===c){if(!i.test(e))return!1;for(d=0;9>d;d++)f+=(d+1)*e.charAt(d);if(f+="X"===e.charAt(9)?100:10*e.charAt(9),f%11===0)return!!e}else if("13"===c){if(!j.test(e))return!1;var g=[1,3];for(d=0;12>d;d++)f+=g[d%2]*e.charAt(d);if(e.charAt(12)-(10-f%10)%10===0)return!!e}return!1},a.isMobilePhone=function(a,b){return b in B?B[b].test(a):!1};var F={symbol:"$",require_symbol:!1,allow_space_after_symbol:!1,symbol_after_digits:!1,allow_negatives:!0,parens_for_negatives:!1,negative_sign_before_digits:!1,negative_sign_after_digits:!1,allow_negative_sign_placeholder:!1,thousands_separator:",",decimal_separator:".",allow_space_after_digits:!1};a.isCurrency=function(a,d){return d=b(d,F),c(d).test(a)},a.isJSON=function(a){try{var b=JSON.parse(a);return!!b&&"object"==typeof b}catch(c){}return!1},a.isMultibyte=function(a){return w.test(a)},a.isAscii=function(a){return v.test(a)},a.isFullWidth=function(a){return x.test(a)},a.isHalfWidth=function(a){return y.test(a)},a.isVariableWidth=function(a){return x.test(a)&&y.test(a)},a.isSurrogatePair=function(a){return z.test(a)},a.isBase64=function(a){return A.test(a)},a.isMongoId=function(b){return a.isHexadecimal(b)&&24===b.length},a.ltrim=function(a,b){var c=b?new RegExp("^["+b+"]+","g"):/^\s+/g;return a.replace(c,"")},a.rtrim=function(a,b){var c=b?new RegExp("["+b+"]+$","g"):/\s+$/g;return a.replace(c,"")},a.trim=function(a,b){var c=b?new RegExp("^["+b+"]+|["+b+"]+$","g"):/^\s+|\s+$/g;return a.replace(c,"")},a.escape=function(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\//g,"&#x2F;").replace(/\`/g,"&#96;")},a.stripLow=function(b,c){var d=c?"\\x00-\\x09\\x0B\\x0C\\x0E-\\x1F\\x7F":"\\x00-\\x1F\\x7F";return a.blacklist(b,d)},a.whitelist=function(a,b){return a.replace(new RegExp("[^"+b+"]+","g"),"")},a.blacklist=function(a,b){return a.replace(new RegExp("["+b+"]+","g"),"")};var G={lowercase:!0};return a.normalizeEmail=function(c,d){if(d=b(d,G),!a.isEmail(c))return!1;var e=c.split("@",2);if(e[1]=e[1].toLowerCase(),"gmail.com"===e[1]||"googlemail.com"===e[1]){if(e[0]=e[0].toLowerCase().replace(/\./g,""),"+"===e[0][0])return!1;e[0]=e[0].split("+")[0],e[1]="gmail.com"}else d.lowercase&&(e[0]=e[0].toLowerCase());return e.join("@")},a.init(),a})},{}],65:[function(a,b){function c(a,b){var c;return c=b?new e(a,b):new e(a)}var d=function(){return this}(),e=d.WebSocket||d.MozWebSocket,f=a("./version");b.exports={w3cwebsocket:e?c:null,version:f}},{"./version":66}],66:[function(a,b){b.exports=a("../package.json").version},{"../package.json":67}],67:[function(a,b){b.exports={_args:[["websocket@^1.0.18","/Users/hannes/Work/orestes/orestes-js"]],_from:"websocket@>=1.0.18 <2.0.0",_id:"websocket@1.0.22",_inCache:!0,_location:"/websocket",_nodeVersion:"3.3.1",_npmUser:{email:"brian@worlize.com",name:"theturtle32"},_npmVersion:"2.14.3",_phantomChildren:{},_requested:{name:"websocket",raw:"websocket@^1.0.18",rawSpec:"^1.0.18",scope:null,spec:">=1.0.18 <2.0.0",type:"range"},_requiredBy:["/"],_resolved:"https://registry.npmjs.org/websocket/-/websocket-1.0.22.tgz",_shasum:"8c33e3449f879aaf518297c9744cebf812b9e3d8",_shrinkwrap:null,_spec:"websocket@^1.0.18",_where:"/Users/hannes/Work/orestes/orestes-js",author:{email:"brian@worlize.com",name:"Brian McKelvey",url:"https://www.worlize.com/"},browser:"lib/browser.js",bugs:{url:"https://github.com/theturtle32/WebSocket-Node/issues"},config:{verbose:!1},contributors:[{name:"Iñaki Baz Castillo",email:"ibc@aliax.net",url:"http://dev.sipdoc.net"}],dependencies:{debug:"~2.2.0",nan:"~2.0.5","typedarray-to-buffer":"~3.0.3",yaeti:"~0.0.4"},description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",devDependencies:{"buffer-equal":"^0.0.1",faucet:"^0.0.1",gulp:"git+https://github.com/gulpjs/gulp.git#4.0","gulp-jshint":"^1.11.2","jshint-stylish":"^1.0.2",tape:"^4.0.1"},directories:{lib:"./lib"},dist:{shasum:"8c33e3449f879aaf518297c9744cebf812b9e3d8",tarball:"http://registry.npmjs.org/websocket/-/websocket-1.0.22.tgz"},engines:{node:">=0.8.0"},gitHead:"19108bbfd7d94a5cd02dbff3495eafee9e901ca4",homepage:"https://github.com/theturtle32/WebSocket-Node",installable:!0,keywords:["RFC-6455","client","comet","networking","push","realtime","server","socket","websocket","websockets"],license:"Apache-2.0",main:"index",maintainers:[{name:"theturtle32",email:"brian@worlize.com"}],name:"websocket",optionalDependencies:{},repository:{type:"git",url:"git+https://github.com/theturtle32/WebSocket-Node.git"},scripts:{gulp:"gulp",install:"(node-gyp rebuild 2> builderror.log) || (exit 0)",test:"faucet test/unit"},version:"1.0.22"}},{}]},{},[31])(31)});