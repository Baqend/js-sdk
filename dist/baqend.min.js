/*! baqend 1.0.0 | Copyright (c) 2015 Baqend GmbH | MIT */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.DB=a()}}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return e(c?c:b)},k,k.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){var d=a("./message"),e=a("./error"),f=(a("./binding"),a("./util")),g=a("./EntityTransaction"),h=a("./Query"),i=a("./util/Metadata"),j=a("./connector/Message"),k=j.StatusCode,l=Object.inherit(f.Lockable,{List:a("./collection").List,Set:a("./collection").Set,Map:a("./collection").Map,GeoPoint:a("./GeoPoint"),entityManagerFactory:null,metamodel:null,code:null,modules:null,log:null,_connector:null,_entities:null,get isOpen(){return!!this._connector},token:null,me:null,isDeviceRegistered:!1,isGlobal:!1,constructor:function(a,b){this.entityManagerFactory=a,this.metamodel=a.metamodel,this.code=a.code,this.isGlobal=!!b,this.log=f.Logger.create(this)},connected:function(a,b){this._connector=a,this._entities={},this._createObjectFactory(this.metamodel.embeddables),this._createObjectFactory(this.metamodel.entities),this.transaction=new g(this),this.modules=new f.Modules(this,a),this.isGlobal&&b&&(this.token=b.token,this.isDeviceRegistered=!!b.device,b.user&&this._setUser(b.user,!0))},_createObjectFactory:function(a){Object.keys(a).forEach(function(a){var b=this.metamodel.managedType(a),c=b.name;this[c]?(b.typeConstructor=this[c],Object.defineProperty(this,c,{value:b.createObjectFactory(this)})):Object.defineProperty(this,c,{get:function(){return Object.defineProperty(this,c,{value:b.createObjectFactory(this)}),this[c]},set:function(a){b.typeConstructor=a},configurable:!0})},this)},_sendOverSocket:function(a){a.token=this.token,this._connector.sendOverSocket(a)},_subscribe:function(a,b){this._connector.subscribe(a,b)},_unsubscribe:function(a,b){this._connector.unsubscribe(a,b)},_send:function(a){return a.withAuthorizationToken(this.isGlobal?null:this.token),this._connector.send(a).then(function(){var b=a.getAuthorizationToken();return b&&(this.token=b),a}.bind(this))},getReference:function(a,b){var c,d;b?(d=this.metamodel.entity(a),c=0==b.indexOf("/db/")?b:d.ref+"/"+encodeURIComponent(b)):(c=a,d=this.metamodel.entity(c.substring(0,c.indexOf("/",4))));var e=this._entities[c];if(!e){e=d.create();var f=i.get(e);f.id=c,f.setUnavailable(),this._attach(e)}return e},createQueryBuilder:function(a){return new h.Builder(this,a)},clear:function(){this._entities={}},close:function(){return this._connector=null,this.clear()},contains:function(a){return!!a&&this._entities[a.id]===a},containsById:function(a){return!(!a||!this._entities[a.id])},detach:function(a){var b=i.get(a);return b.withLock(function(){return this.removeReference(a),Promise.resolve(a)}.bind(this))},resolveDepth:function(a,b){if(!b||!b.depth)return Promise.resolve(a);b.resolved=b.resolved||[];var c=[],d=Object.extend({},b);return d.depth=b.depth===!0?!0:b.depth-1,this.getSubEntities(a,1).forEach(function(a){null==a||~b.resolved.indexOf(a)||(b.resolved.push(a),c.push(this.load(a.id,null,d)))}.bind(this)),Promise.all(c).then(function(){return a})},load:function(a,b,c){c=c||{};var e=this.getReference(a,b),f=i.get(e),g=new d.GetObject(f.bucket,f.key);return(f.version||c.refresh)&&g.setIfNoneMatch(c.refresh?"":f.version),this._send(g).then(function(a){return a.response.status!=k.NOT_MODIFIED&&f.setJson(a.response.entity),f.setPersistent(),this.resolveDepth(e,c)}.bind(this),function(a){if(a.status==k.OBJECT_NOT_FOUND)return this.removeReference(e),f.setRemoved(),null;throw a}.bind(this))},insert:function(a,b){b=b||{};var c;return this._save(a,b,function(a){if(a.version)throw new e.PersistentError("Existing objects can't be inserted.");return c=!a.id,new d.CreateObject(a.bucket,a.getJson())}).then(function(b){return c&&this._attach(a),b}.bind(this))},update:function(a,b){return b=b||{},this._save(a,b,function(a){if(!a.version)throw new e.PersistentError("New objects can't be inserted.");if(b.force){var c=new d.ReplaceObject(a.bucket,a.key,a.getJson(!0));return c.setIfMatch("*"),c}return c=new d.ReplaceObject(a.bucket,a.key,a.getJson(!1)),c.setIfMatch(a.version),c})},save:function(a,b){return b=b||{},this._save(a,b,function(a){if(b.force){if(!a.id)throw new e.PersistentError("New special objects can't be forcedly saved.");return new d.ReplaceObject(a.bucket,a.key,a.getJson(!0))}if(a.version){var c=new d.ReplaceObject(a.bucket,a.key,a.getJson(!1));return c.setIfMatch(a.version),c}return new d.CreateObject(a.bucket,a.getJson())})},optimisticSave:function(a,b){var c=!1,d=function(){c=!0},e=Promise.resolve(b(a,d));return c?Promise.resolve(a):e.then(function(){return a.save()["catch"](function(c){if(412==c.status)return this.refresh(a).then(function(){return this.optimisticSave(a,b)}.bind(this));throw c}.bind(this))}.bind(this))},_save:function(a,b,c){this.attach(a);var d=i.get(a);return d.withLock(function(){var e;if(d.isDirty){b.refresh||d.setPersistent();var f=this._send(c(d)).then(function(c){return b.refresh?(d.setJson(c.response.entity),d.setPersistent()):d.setJsonMetadata(c.response.entity),a}.bind(this),function(b){if(b.status==k.OBJECT_NOT_FOUND)return this.removeReference(a),d.setRemoved(),null;throw d.setDirty(),b}.bind(this));e=[f]}else e=[Promise.resolve(a)];var g=Object.extend({},b);return g.depth=0,this.getSubEntities(a,b.depth).forEach(function(a){e.push(this._save(a,g,c))}.bind(this)),Promise.all(e).then(function(){return a})}.bind(this))},getSubEntities:function(a,b,c,d){if(c=c||[],!b)return c;d=d||a;for(var e=i.get(a),f=e.type.references(),g=f.next();!g.done;g=f.next())this.getSubEntitiesByPath(a,g.value.path).forEach(function(a){~c.indexOf(a)||a==d||(c.push(a),c=this.getSubEntities(a,b===!0?b:b-1,c,d))}.bind(this));return c},getSubEntitiesByPath:function(a,b){var c=[a];return b.forEach(function(a){var b=[];c.forEach(function(c){var d=c[a];if(d){var e=this.metamodel.managedType(c.constructor).getAttribute(a);if(e.isCollection)for(var f,g=d.entries();!(f=g.next()).done;)b.push(f.value[1]),e.keyType&&e.keyType.isEntity&&b.push(f.value[0]);else b.push(d)}}.bind(this)),c=b}.bind(this)),c},"delete":function(a,b){b=b||{},this.attach(a);var c=i.get(a);return c.withLock(function(){if(!c.version&&!b.force)throw new e.IllegalEntityError(a);var f=new d.DeleteObject(c.bucket,c.key);b.force||f.setIfMatch(c.version);var g=[this._send(f).then(function(){return this.removeReference(a),c.setRemoved(),a}.bind(this))],h=Object.extend({},b);return h.depth=0,this.getSubEntities(a,b.depth).forEach(function(a){g.push(this["delete"](a,h))}.bind(this)),Promise.all(g).then(function(){return a})}.bind(this))},flush:function(a,b){},persist:function(a){a.attach(this)},refresh:function(a,b){return b=b||{},b.refresh=!0,this.load(a.id,null,b)},attach:function(a){if(!this.contains(a)){var b=this.metamodel.entity(classOf(a));if(!b)throw new e.IllegalEntityError(a);if(this.containsById(a))throw new e.EntityExistsError(a);this._attach(a)}},_attach:function(a){var b=i.get(a);if(b.isAttached){if(b.db!=this)throw new e.EntityExistsError(a)}else b.db=this;b.id||"User"!=b.type.name&&"Role"!=b.type.name&&"logs.AppLog"!=b.type.name&&(b.id="/db/"+b.type.name+"/"+f.uuid()),b.id&&(this._entities[b.id]=a)},removeReference:function(a){var b=i.get(a);if(!b)throw new e.IllegalEntityError(a);delete this._entities[b.id]},register:function(a,b,c){if(this.me&&c)throw new e.PersistentError("User is already logged in.");return this.withLock(function(){var e=new d.Register({user:a,password:b,global:this.isGlobal,login:c});return this._userRequest(e,c)}.bind(this))},login:function(a,b){if(this.me)throw new e.PersistentError("User is already logged in.");return this.withLock(function(){var c=new d.Login({username:a,password:b,global:this.isGlobal});return this._userRequest(c,!0)}.bind(this))},logout:function(){return this.withLock(function(){var a=function(){this.me=null,this.token=null}.bind(this);return this.isGlobal?this._send(new d.Logout).then(a):Promise.resolve(a())}.bind(this))},loginWithOAuth:function(a,b,c){c=Object.extend({title:"Login with "+a,timeout:3e5,state:{}},c);var d,f=Object.extend(c.state,{isGlobal:this.isGlobal});if(!j[a+"OAuth"])throw new Error("Provider not supported.");d=new j[a+"OAuth"](b,c.scope,JSON.stringify(f));var g=this._userRequest(d,!0);open(d.request.path,c.title,"width="+c.width+",height="+c.height);return new Promise(function(a,b){var d=setTimeout(function(){b(new e.PersistentError("OAuth login timeout."))},c.timeout);g.then(function(b){clearTimeout(d),a(b)},function(a){clearTimeout(d),b(a)})}.bind(this))},renew:function(){return this.withLock(function(){var a=new d.Me;return a.withAuthorizationToken(this.isGlobal?!1:this.token),this._userRequest(a,!0)}.bind(this))},newPassword:function(a,b,c){return this.withLock(function(){var e=new d.NewPassword({username:a,password:b,newPassword:c,global:this.isGlobal});return this._send(e).then(function(){var a=this.getReference(e.response.entity.id),b=i.get(a);b.setJson(e.response.entity),b.setPersistent()}.bind(this))}.bind(this))},_setUser:function(a,b){var c=this.getReference(a.id),d=i.get(c);return d.setJson(a),d.setPersistent(),b&&(this.me=c),c},_userRequest:function(a,b){return this._send(a).then(function(){return a.response.entity?this._setUser(a.response.entity,b):void 0}.bind(this),function(a){if(a.status==k.OBJECT_NOT_FOUND)return null;throw a})},registerDevice:function(a,b,c){var e=new d.DeviceRegister({token:b,devicetype:a,device:c});return this._send(e)},checkDeviceRegistration:function(){return this._send(new d.DeviceRegistered).then(function(){return this.isDeviceRegistered=!0}.bind(this),function(a){if(a.status==k.OBJECT_NOT_FOUND)return this.isDeviceRegistered=!1;throw a}.bind(this))},pushDevice:function(a){return this._send(new d.DevicePush(a))},validate:function(a){for(var b,c=i.get(a).type,d=new f.ValidationResult,e=c.attributes();!(b=e.next()).done;){var g=new f.Validator(b.value.name,a);d.fields[g.key]=g}var h=c.validationCode;return h&&h(d.fields),d},User:null,Device:null});b.exports=l},{"./EntityTransaction":3,"./GeoPoint":4,"./Query":5,"./binding":16,"./collection":17,"./connector/Message":20,"./error":30,"./message":32,"./util":60,"./util/Metadata":54}],2:[function(a,b,c){var d=a("./message"),e=a("./metamodel"),f=a("./util/Lockable"),g=a("./util/Code"),h=a("./connector/Connector"),i=a("./EntityManager"),j=Object.inherit(f,{_connector:null,metamodel:null,code:null,_connectData:null,_connected:function(){},constructor:function(a){a=String.isInstance(a)?{host:a}:a||{},this.metamodel=this.createMetamodel(a.global),this.code=new g(this.metamodel),a.schema&&(this._connectData=a),a.host?this.connect(a.host,a.port,a.secure,a.basePath):this.withLock(function(){return new Promise(function(a){this._connected=a}.bind(this))}.bind(this),!0),a.schema&&this.metamodel.init(a.schema)},connect:function(a,b,c,d){if(this._connector)throw new Error("The EntityManagerFactory is already connected.");Boolean.isInstance(b)&&(c=b,b=0),this._connector=h.create(a,b,c,d),this.metamodel.connected(this._connector),this.code.connected(this._connector),this._connectData?this._connected():this._loadConnect()},createMetamodel:function(a){return a?e:new e.Metamodel},createConnectedMetamodel:function(a){var b=this.createMetamodel(a);return b.connected(this._connector),b},createEntityManager:function(a){var b=new i(this,a);if(this.isReady&&this.metamodel.isInitialized)return b.connected(this._connector,this._connectData),b;var c=this.ready().then(function(){return this.metamodel.isInitialized?void 0:this.metamodel.init(a?this._connectData.schema:null)}.bind(this));return b.withLock(function(){return c.then(function(){b.connected(this._connector,this._connectData)}.bind(this))}.bind(this),!0),b},_loadConnect:function(){return this.isReady?this.withLock(function(){return this._loadConnectData().then(function(){this._connected()}.bind(this))}.bind(this),!0):this._loadConnectData().then(function(){this._connected()}.bind(this))},_loadConnectData:function(){var a=new d.Connect;return a.withAuthorizationToken(),this._connector.send(a).then(function(a){this._connectData=a.response.entity}.bind(this))}});b.exports=j},{"./EntityManager":1,"./connector/Connector":18,"./message":32,"./metamodel":48,"./util/Code":51,"./util/Lockable":52}],3:[function(a,b,c){var d=a("./message"),e=a("./error"),f=Object.inherit({get isActive(){return Boolean(this.tid)},constructor:function(a){this._connector=a.connector,this.entityManager=a,this.tid=null,this.rollbackOnly=!1,this.readSet=null,this.changeSet=null},begin:function(a,b){return this["yield"]().then(function(){var a=this.send(new d.PostTransaction).done(function(a){this.tid=a.tid,this.rollbackOnly=!1,this.readSet={},this.changeSet={}});return this.wait(a)}).then(a,b)},commit:function(a,b){return this["yield"]().then(function(){return this.getRollbackOnly()?this.rollback().then(function(){throw new e.RollbackError}):this.wait(this.entityManager.flush()).then(function(){var a=[];for(var b in this.readSet)a.push({oid:b,version:this.readSet[b]});var c=this.send(new d.PutTransactionCommitted(this.tid,a));return this.wait(c).then(function(a){this.tid=null,this.readSet=null,this.changeSet=null;var b=a.oids;for(var c in b){var d=b[c],e=this.entityManager.entities[c];if(e){var f=util.Metadata.get(e);"DELETED"==d||f.isDeleted?this.entityManager.removeReference(e):f.setJsonValue(f.type.version,d)}}})})}).then(a,b)},getRollbackOnly:function(){return this.rollbackOnly},rollback:function(a,b){return this["yield"]().then(function(){var a=this.send(new d.PutTransactionAborted(this.tid));this.wait(a).then(function(){return this.tid=null,this.readSet=null,this.changeSet=null,this.entityManager.clear()},function(){return this.entityManager.clear()})}).then(a,b)},setRollbackOnly:function(a,b){return this["yield"]().done(function(){this.rollbackOnly=!0})},isRead:function(a){return this.isActive&&a in this.readSet},setRead:function(a,b){this.isActive&&!this.isChanged(a)&&(this.readSet[a]=b)},isChanged:function(a){return this.isActive&&a in this.changeSet},setChanged:function(a){this.isActive&&(delete this.readSet[a],this.changeSet[a]=!0)}});b.exports=f},{"./error":30,"./message":32}],4:[function(a,b,c){var d=(a("./collection"),Object.inherit({extend:{DEG_TO_RAD:Math.PI/180,EARTH_RADIUS_IN_KILOMETERS:6371,EARTH_RADIUS_IN_MILES:3956,current:function(){return new Promise(function(a,b){navigator.geolocation.getCurrentPosition(function(b){a(new d(b.coords.latitude,b.coords.longitude))},function(a){b(a)})})},conv:function(a){return new this(a)}},latitude:0,longitude:0,constructor:function(a,b){if(String.isInstance(a)){var c=a.indexOf(";");this.latitude=a.substring(0,c),this.longitude=a.substring(c+1)}else Number.isInstance(a)?(this.latitude=a,this.longitude=b):Array.isInstance(a)?(this.latitude=a[0],this.longitude=a[1]):Object.isInstance(a)&&(this.latitude=a.latitude,this.longitude=a.longitude);if(this.latitude<-90||this.latitude>90)throw new Error("Latitude "+this.latitude+" is not in bound of -90 <= latitude <= 90");if(this.longitude<-180||this.longitude>180)throw new Error("Longitude "+this.longitude+" is not in bound of -180 <= longitude <= 180")},kilometersTo:function(a){return Number((d.EARTH_RADIUS_IN_KILOMETERS*this.radiansTo(a)).toFixed(3))},milesTo:function(a){return Number((d.EARTH_RADIUS_IN_MILES*this.radiansTo(a)).toFixed(3))},radiansTo:function(a){var b=this,c=a,e=b.latitude*d.DEG_TO_RAD,f=c.latitude*d.DEG_TO_RAD,g=(c.longitude-b.longitude)*d.DEG_TO_RAD;return Math.acos(Math.sin(e)*Math.sin(f)+Math.cos(e)*Math.cos(f)*Math.cos(g))},toString:function(){return this.latitude+";"+this.longitude},toJSON:function(){return{latitude:this.latitude,longitude:this.longitude}}}));b.exports=d},{"./collection":17}],5:[function(a,b,c){var d=a("./message"),e=a("./util/Metadata"),f=a("./binding/Entity"),g=Trait.inherit({extend:{MAX_URI_SIZE:2e3},entityManager:null,resultClass:null,ascending:function(a){return this._addOrder(a,1)},descending:function(a){return this._addOrder(a,-1)},sort:function(a){if(classOf(a)!=Object)throw new Error("sort must be an object.");return this._addOrder(a)},offset:function(a){if(0>a)throw new Error("The offset can't be nagative.");return this._addOffset(a)},limit:function(a){if(0>a)throw new Error("The limit can't be nagative.");return this._addLimit(a)},resultList:function(a,b,c){},singleResult:function(a,b,c){},stream:function(a){},count:function(a,b){}});g.Condition=g.inherit({where:function(a){return this._addFilter(null,null,a)},equal:function(a,b){return this._addFilter(a,null,b)},notEqual:function(a,b){return this._addFilter(a,"$ne",b)},greaterThan:function(a,b){return this._addFilter(a,"$gt",b)},greaterThanOrEqualTo:function(a,b){return this._addFilter(a,"$gte",b)},lessThan:function(a,b){return this._addFilter(a,"$lt",b)},lessThanOrEqualTo:function(a,b){return this._addFilter(a,"$lte",b)},between:function(a,b,c){return this._addFilter(a,"$gt",b)._addFilter(a,"$lt",c)},"in":function(a,b){return this._addFilter(a,"$in",classOf(b)==Array?b:Array.prototype.slice.call(arguments,1))},notIn:function(a,b){return this._addFilter(a,"$nin",classOf(b)==Array?b:Array.prototype.slice.call(arguments,1))},isNull:function(a){return this.equal(a,null)},isNotNull:function(a){return this._addFilter(a,"$exists",!0)._addFilter(a,"$ne",null)},containsAll:function(a,b){return this._addFilter(a,"$all",classOf(b)==Array?b:Array.prototype.slice.call(arguments,1))},mod:function(a,b,c){return this._addFilter(a,"$mod",[b,c])},matches:function(a,b){if(RegExp.isInstance(b)||(b=new RegExp(b)),b.ignoreCase)throw new Error("RegExp.ignoreCase flag is not supported.");if(b.global)throw new Error("RegExp.global flag is not supported.");if(0!=b.source.indexOf("^"))throw new Error("regExp must be an anchored expression, i.e. it must be started with a ^.");var c=this._addFilter(a,"$regex",b.source);return b.multiline&&c._addFilter(a,"$options","m"),c},size:function(a,b){return this._addFilter(a,"$size",b)},near:function(a,b,c){return this._addFilter(a,"$nearSphere",{$geometry:{type:"Point",coordinates:[b.longitude,b.latitude]},$maxDistance:c})},withinPolygon:function(a,b){return b=classOf(b)==Array?b:Array.prototype.slice.call(arguments,1),this._addFilter(a,"$geoWithin",{$geometry:{type:"Polygon",coordinates:[b.map(function(a){return[a.longitude,a.latitude]})]}})}});var h=g.Condition.prototype;Object.extend(h,{lt:h.lessThan,le:h.lessThanOrEqualTo,gt:h.greaterThan,ge:h.greaterThanOrEqualTo,containsAny:h["in"]}),g.Node=Object.inherit(g,{firstResult:0,maxResults:-1,initialize:function(a,b){this.entityManager=a,this.resultClass=b,this._sort={}},stream:function(a){var b=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!b)throw new Error("Only typed queries can be executed.");void 0===a&&(a=!0);var c=this._serializeSort();return new g.Stream(this.entityManager,b.name,this._serializeQuery(),a,c,this.maxResults)},resultList:function(a,b,c){Function.isInstance(a)&&(c=b,b=a,a={});var e=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!e)throw new Error("Only typed queries can be executed.");var f,h=this._serializeQuery(),i=this._serializeSort(),j=this.entityManager._connector.host.length+h.length;return f=j>g.MAX_URI_SIZE?new d.AdhocQueryPOST(e.name,this.firstResult,this.maxResults,i,h):new d.AdhocQuery(e.name,h,this.firstResult,this.maxResults,i),this.entityManager._send(f).then(function(){return this._createResultList(f.response.entity,a)}.bind(this)).then(b,c)},singleResult:function(a,b,c){Function.isInstance(a)&&(c=b,b=a,a={});var e=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!e)throw new Error("Only typed queries can be executed.");var f,h=this._serializeQuery(),i=this._serializeSort(),j=this.entityManager._connector.host.length+h.length;return f=j>g.MAX_URI_SIZE?new d.AdhocQueryPOST(e.name,h,this.firstResult,1,i,h):new d.AdhocQuery(e.name,h,this.firstResult,1,i),this.entityManager._send(f).then(function(){return this._createResultList(f.response.entity,a)}.bind(this)).then(function(a){return a.length?a[0]:null}).then(b,c)},count:function(a,b){var c=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!c)throw new Error("Only typed queries can be executed.");var e,f=this._serializeQuery(),h=this.entityManager._connector.host.length+f.length;return e=h>g.MAX_URI_SIZE?new d.AdhocCountQueryPOST(c.name,f):new d.AdhocCountQuery(c.name,f),this.entityManager._send(e).then(function(){return e.response.entity.count}).then(a,b)},_serializeQuery:function(){return JSON.stringify(this,function(a,b){var c=this[a];return Date.isInstance(c)?{$date:b}:f.isInstance(c)?c.id:b})},_serializeSort:function(){return JSON.stringify(this._sort)},_createResultList:function(a,b){return a.length?Promise.all(a.map(function(a){if(a.id){var c=this.entityManager.getReference(this.resultClass,a.id),d=e.get(c);return d.setJson(a),d.setPersistent(),this.entityManager.resolveDepth(c,b)}return this.entityManager.load(Object.keys(a)[0])},this)).then(function(a){return a.filter(function(a){return!!a})}):Promise.resolve([])},_addOrder:function(a,b){return b?this._sort[a]=b:this._sort=a,this},_addOffset:function(a){return this.firstResult=a,this},_addLimit:function(a){return this.maxResults=a,this}}),g.Builder=Object.inherit(g.Condition,{initialize:function(a,b){this.entityManager=a,this.resultClass=b},and:function(a){return this._addOperator("$and",classOf(a)==Array?a:Array.prototype.slice.call(arguments))},or:function(a){return this._addOperator("$or",classOf(a)==Array?a:Array.prototype.slice.call(arguments))},nor:function(a){return this._addOperator("$nor",classOf(a)==Array?a:Array.prototype.slice.call(arguments))},stream:function(a){return this.where({}).stream(a)},resultList:function(a,b,c){return this.where({}).resultList(a,b,c)},singleResult:function(a,b,c){return this.where({}).singleResult(a,b,c)},count:function(a,b){return this.where({}).count(a,b)},_addOperator:function(a,b){if(b.length<2)throw new Error("Only two or more queries can be joined with an "+a+" operator.");return b.forEach(function(a,b){if(!g.isInstance(a))throw new Error("Argument at index "+b+" is not a Query.")}),new g.Operator(this.entityManager,this.resultClass,a,b)},_addOrder:function(a,b){return new g.Filter(this.entityManager,this.resultClass)._addOrder(a,b)},_addFilter:function(a,b,c){return new g.Filter(this.entityManager,this.resultClass)._addFilter(a,b,c)},_addOffset:function(a){return new g.Filter(this.entityManager,this.resultClass)._addOffset(a)},_addLimit:function(a){return new g.Filter(this.entityManager,this.resultClass)._addLimit(a)}}),g.Filter=g.Node.inherit(g.Condition,{_filter:null,initialize:function(a,b){this.superCall(a,b),this._filter={}},_addFilter:function(a,b,c){if(null!==a){if(!String.isInstance(a))throw new Error("Field must be a string.");if(b){var d=this._filter[a];classOf(d)!=Object&&(this._filter[a]=d={}),d[b]=c}else this._filter[a]=c}else Object.extend(this._filter,c);return this},toJSON:function(){return this._filter}}),g.Operator=g.Node.inherit({_operator:null,_childs:null,initialize:function(a,b,c,d){this.superCall(a,b),this._operator=c,this._childs=d},toJSON:function(){var a={};return a[this._operator]=this._childs,a}}),g.Stream=Object.inherit({initialize:function(a,b,c,d,e,f){this.entityManager=a,this.bucket=b,this.fetchQuery=d,this.sort=e,this.limit=f,this.query=c,this.callbacks=[]},on:function(a,b){var c=[this.bucket,this.query,a,"any"].join("/"),d=this._wrapQueryCallback(b);this.entityManager._subscribe(c,d);var e={register:!0,topic:c,query:{bucket:this.bucket,matchTypes:[a],operations:["any"],query:this.query}};this.fetchQuery&&(e.fromstart=!0,e.limit=this.limit,e.sort=this.sort),this.entityManager._sendOverSocket(e),this.callbacks.push({matchType:a,callback:b,topic:c,wrappedCallback:d,queryMessage:e})},off:function(a,b){this.callbacks=this.callbacks.reduce(function(c,d){return b&&d.callback!=b||a&&d.matchType!=a?c.push(d):(this.entityManager._unsubscribe(d.topic,d.wrappedCallback),d.queryMessage.register=!1,this.entityManager._sendOverSocket(d.queryMessage)),c}.bind(this),[])},once:function(a,b){var c=function(d,e,f){this.off(a,c),b(d,e,f)}.bind(this);this.on(a,c)},_wrapQueryCallback:function(a){var b=!1;return function(c){var d=c.query.bucket;if(c.match){var e=c.match.update.operation,f=c.match.update.object?c.match.update.object:{id:c.match.update.id},g=this._createObject(d,e,f);a({type:c.match.matchtype,data:g,operation:e,date:new Date(c.date),target:this,initial:!1,query:this.query})}else b||(c.result.forEach(function(b){var e="insert",f=this._createObject(d,e,b,b.id);a({type:"match",data:f,operation:e,date:new Date(c.date),target:this,initial:!0,query:this.query})},this),b=!0)}.bind(this)},_createObject:function(a,b,c){var d=this.entityManager.getReference(a,c.id),f=e.get(d);return f.setJson(c),f.setPersistent(),d}}),b.exports=g},{"./binding/Entity":9,"./message":32,"./util/Metadata":54}],6:[function(a,b,c){var d=Object.inherit({getValue:function(a,b){return a[b.name]},setValue:function(a,b,c){a[b.name]=c}});b.exports=d},{}],7:[function(a,b,c){var d=a("./EntityFactory"),e={};Object.cloneOwnProperties(e,d),Object.defineProperty(e,"isRegistered",{get:function(){return this._db.isDeviceRegistered}}),Object.extend(e,{PushMessage:a("../util/PushMessage"),register:function(a,b,c,d,e){return Function.isInstance(c)&&(e=d,d=c,c=null),this._db.registerDevice(a,b,c).then(d,e)},push:function(a,b,c){return this._db.pushDevice(a).then(b,c)}}),b.exports=e},{"../util/PushMessage":57,"./EntityFactory":10}],8:[function(a,b,c){var d=a("../util/Metadata"),e=(a("../util/Lockable"),Object.inherit({createProxy:function(a){function b(b){a.apply(this,arguments)}return b.prototype=Object.create(a.prototype,{constructor:{value:b,enumerable:!1,configurable:!0}}),b},getIdentifier:function(a){return a.__baqendId__},setIdentifier:function(a,b){a.__baqendId__=b},enhance:function(a,b){this.setIdentifier(b,a.ref),this.enhancePrototype(b,a)},enhancePrototype:function(a,b){if(a.prototype.toString===Object.prototype.toString&&Object.defineProperty(a.prototype,"toString",{value:function(){return this._metadata.id||this._metadata.bucket},enumerable:!1}),b.superType&&"Object"==b.superType.name)for(var c,d=0;c=b.superType.declaredAttributes[d];++d)c.isMetadata||this.enhanceProperty(a,c);for(var c,d=0;c=b.declaredAttributes[d];++d)this.enhanceProperty(a,c)},enhanceProperty:function(a,b){var c="$"+b.name;Object.defineProperty(a.prototype,b.name,{get:function(){return d.readAccess(this),this._metadata[c]},set:function(a){d.writeAccess(this),this._metadata[c]=a},configurable:!0,enumerable:!0})}}));b.exports=e},{"../util/Lockable":52,"../util/Metadata":54}],9:[function(a,b,c){var d=a("./Managed"),e=(a("../util/Lockable"),d.inherit({extend:{extend:d.extend},constructor:function(){d.apply(this,arguments)},get id(){return this._metadata.id},set id(a){if(this._metadata.id)throw new Error("The id can't be set twice: "+a);a+="",0==a.indexOf("/db/"+this._metadata.bucket+"/")?this._metadata.id=a:this.key=a},get key(){return this._metadata.key},set key(a){this._metadata.key=a},get version(){return this._metadata.version},set version(a){this._metadata.version=a},get acl(){return this._metadata.acl},ready:function(a){return this._metadata.ready(a)},attach:function(a){a.attach(this)},save:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db.save(this,a).then(b,c)},insert:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db.insert(this,a).then(b,c)},update:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db.update(this,a).then(b,c)},load:function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={depth:1}),this._metadata.db.load(this.id,null,a).then(b,c)},"delete":function(a,b,c){return Function.isInstance(a)&&(c=b,b=a,a={}),this._metadata.db["delete"](this,a).then(b,c)},optimisticSave:function(a,b,c){return this._metadata.db.optimisticSave(this,a).then(b,c)},attr:function(){throw new Error("Attr is not yet implemented.")},validate:function(){return this._metadata.db.validate(this)},toJSON:function(a){return this._metadata.getJson(a,a)}}));b.exports=e},{"../util/Lockable":52,"./Managed":11}],10:[function(a,b,c){var d=a("./ManagedFactory"),e={};Object.cloneOwnProperties(e,d),Object.extend(e,{load:function(a,b,c,d){return Function.isInstance(b)&&(d=c,c=b,b={}),this._db.load(this._managedType.typeConstructor,a,b).then(c,d)},fromJSON:function(a){var b=a.id?this._db.getReference(this._managedType.typeConstructor,a.id):this.newInstance(),c=b._metadata;return c.setJson(a),c.setDirty(),b},find:function(){return this._db.createQueryBuilder(this._managedType.typeConstructor)},partialUpdate:function(){throw new Error("partialUpdate is not yet implemented.")}}),b.exports=e},{"./ManagedFactory":12}],11:[function(a,b,c){var d=(a("../util"),Object.inherit({extend:{extend:function(a){return a.prototype=Object.create(this.prototype,{constructor:{value:a,enumerable:!1,configurable:!0,writable:!0}}),a.extend=d.extend,a}},constructor:function(a){a&&Object.extend(this,a)},toJSON:function(){return this._metadata.type.toJsonValue(this._metadata,this)}}));b.exports=d},{"../util":60}],12:[function(a,b,c){var d={};Object.defineProperty(d,"methods",{get:function(){return this.prototype}}),Object.extend(d,{create:function(a,b){var c=this,d=function(){return d.newInstance.apply(d,arguments)};return Object.cloneOwnProperties(d,c),d.prototype=a.typeConstructor.prototype,d._managedType=a,d._db=b,d},newInstance:function(a){var b=this._managedType.create();return this.prototype.constructor.apply(b,arguments),b._metadata.db=this._db,b},fromJSON:function(a){var b=this.newInstance(),c=b._metadata;return this._managedType.fromJsonValue(c,a,b),b},addMethods:function(a){Object.extend(this.methods,a)},addMethod:function(a,b){this.methods[a]=b}}),b.exports=d},{}],13:[function(a,b,c){var d=a("./Entity"),e=a("./User"),f=a("../collection").Set,g=d.inherit({extend:{extend:d.extend},users:null,name:null,constructor:function(){d.apply(this,arguments)},hasUser:function(a){return this.users&&this.users.has(a)},addUser:function(a){if(!(a instanceof e))throw new Error("Only user instances can be added to a role.");this.users||(this.users=new f),this.users.add(a)},removeUser:function(a){if(!(a instanceof e))throw new Error("Only user instances can be removed from a role.");this.users&&this.users["delete"](a)}});b.exports=g},{"../collection":17,"./Entity":9,"./User":14}],14:[function(a,b,c){var d=a("./Entity"),e=d.inherit({extend:{extend:d.extend},constructor:function(){d.apply(this,arguments)},username:null,newPassword:function(a,b,c,d){return this._metadata.db.newPassword(this.username,a,b).then(c,d)}});b.exports=e},{"./Entity":9}],15:[function(a,b,c){var d=a("./EntityFactory"),e={};Object.cloneOwnProperties(e,d),Object.defineProperty(e,"me",{get:function(){return this._db.me}}),Object.extend(e,{defaultOptions:{google:{width:585,height:545,scope:"email"},facebook:{width:1140,height:640,scope:"email"},github:{width:1040,height:580,scope:"user:email"},twitter:{width:740,height:730},linkedin:{width:630,height:530,scope:""}},register:function(a,b,c,d,e){return Boolean.isInstance(c)||(e=d,d=c,c=!0),a=String.isInstance(a)?this.fromJSON({username:a}):a,this._db.register(a,b,c).then(d,e)},login:function(a,b,c,d){return this._db.login(a,b).then(c,d)},logout:function(a,b){return this._db.logout().then(a,b)},newPassword:function(a,b,c,d,e){
return this._db.newPassword(a,b,c).then(d,e)}}),["Google","Facebook","GitHub","Twitter","LinkedIn"].forEach(function(a){e["loginWith"+a]=function(b,c,d,f){return Function.isInstance(c)&&(f=d,d=c,c={}),c=Object.extend(Object.extend({},e.defaultOptions[a.toLowerCase()]),c||{}),this._db.loginWithOAuth(a,b,c).then(d,f)}}),b.exports=e},{"./EntityFactory":10}],16:[function(a,b,c){c.Accessor=a("./Accessor"),c.Enhancer=a("./Enhancer"),c.ManagedFactory=a("./ManagedFactory"),c.EntityFactory=a("./EntityFactory"),c.UserFactory=a("./UserFactory"),c.DeviceFactory=a("./DeviceFactory"),c.Managed=a("./Managed"),c.Entity=a("./Entity"),c.Role=a("./Role"),c.User=a("./User")},{"./Accessor":6,"./DeviceFactory":7,"./Enhancer":8,"./Entity":9,"./EntityFactory":10,"./Managed":11,"./ManagedFactory":12,"./Role":13,"./User":14,"./UserFactory":15}],17:[function(a,b,c){var d,e,f,g,h,i,j,k,l=a("./util/Metadata"),m="@@iterator";c.Iterator=d=Trait.inherit({extend:{DONE:{done:!0}},constructor:function(a){return a?a[m]&&Function.isInstance(a[m])?a[m]():Array.isInstance(a)?new e(a.length,function(b){return a[b]}):new f(a):void 0},next:function(){return d.DONE}}),c.IndexIterator=e=Object.inherit(d,{length:0,index:0,constructor:function(a,b){this.length=a,b&&(this.accessor=b)},accessor:function(a){return a},next:function(){if(this.index<this.length){var a={done:!1,value:this.accessor(this.index)};return this.index++,a}return d.DONE}}),c.PropertyIterator=f=d.inherit({index:0,constructor:function(a){this.object=a,this.names=Object.getOwnPropertyNames(a)},next:function(){if(this.names.length<this.index){var a=this.names[this.index++];return{done:!1,value:[a,this.object[a]]}}return d.DONE}}),c.Iterable=g=Trait.inherit({entries:function(){return null},forEach:function(a,b){if(!a||!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=this.entries();!(c=d.next()).done;)a.call(b,c.value[1],c.value[0],this)},every:function(a,b){if(!a||!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=this.entries();!(c=d.next()).done;)if(!a.call(b,c.value[1],c.value[0],this))return!1;return!0},some:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=this.entries();!(c=d.next()).done;)if(a.call(b,c.value[1],c.value[0],this))return!0;return!1},filter:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=new this.constructor,e=this.entries();!(c=e.next()).done;)a.call(b,c.value[1],c.value[0],this)&&(d.set?d.set(c.value[0],c.value[1]):d.add(c.value[1]));return d},map:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c,d=new this.constructor,e=this.entries();!(c=e.next()).done;){var f=a.call(b,c.value[1],c.value[0],this);d.set?d.set(c.value[0],f):d.add(f)}return d},reduce:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");var c=this.entries();1==arguments.length&&(b=c.next().value);for(var d;!(d=c.next()).done;)b=a.call(null,b,d.value[1],d.value[0],this);return b}}),c.Collection=h=Object.inherit(g,{array:null,get size(){return this.array.length},constructor:function(a){this.array=[];var b=d(a);if(b)for(var c;!(c=b.next()).done;)this.add(c.value)},has:function(a){return-1!=this.array.indexOf(a)},clear:function(){l.writeAccess(this),this.array=[]},add:function(a){l.writeAccess(this),this.array.push(a)},"delete":function(a){l.writeAccess(this);var b=this.array.indexOf(a);b>-1&&this.array.splice(b,1)},entries:function(){var a=this.array;return new e(this.size,function(b){return[b,a[b]]})},keys:function(){return new e(this.size)},values:function(){var a=this.array;return new e(this.size,function(b){return a[b]})},toString:function(){return this.array.toString()},toJSON:function(){return this.array}});var n=Array.prototype;c.List=i=h.inherit({constructor:function(a){h.call(this,a)},get:function(a){return 0>a&&(a=this.size+a),a>=0&&a<this.size?this.array[a]:void 0},add:function(a){l.writeAccess(this),this.array.push(a)},set:function(a,b){l.writeAccess(this),0>a&&(a=this.size+a),0>a?this.array.unshift(b):a>=this.size?this.array.push(b):this.array[a]=b},concat:function(){var a=n.map.call(arguments,function(a){return i.isInstance(a)?a.array:a});return new i(n.concat.apply(this.array,a))},indexOf:function(a){return this.seq.indexOf(a)},lastIndexOf:function(a){return this.seq.lastIndexOf(a)},join:function(a){return this.array.join(a)},pop:function(){return l.writeAccess(this),this.array.pop()},push:function(){return l.writeAccess(this),n.push.apply(this.array,arguments)},reverse:function(){l.writeAccess(this),this.array.reverse()},shift:function(){return l.writeAccess(this),this.array.shift()},slice:function(a,b){return new i(this.array.slice(a,b))},sort:function(a){l.writeAccess(this),this.array.sort(a)},splice:function(){return l.writeAccess(this),n.splice.apply(this.array,arguments)},unshift:function(){return l.writeAccess(this),n.unshift.apply(this.array,arguments)}}),i.prototype[m]=i.prototype.values,c.Set=j=h.inherit({constructor:function(a){h.call(this,a)},add:function(a){var b=this.array.indexOf(a);0>b&&(this.array.push(a),l.writeAccess(this))},entries:function(){var a=this.array;return new e(this.size,function(b){return[a[b],a[b]]})}}),j.prototype.keys=j.prototype.values,j.prototype[m]=j.prototype.values,c.Map=k=h.inherit({_dateCache:null,constructor:function(a){this.array=[],this.vals=[],this._dateCache={};var b=d(a);if(b)for(var c;!(c=b.next()).done;){if(!Array.isInstance(c.value)||2!=c.value.length)throw new Error("No key value pair in entry "+c.value);this.set(c.value[0],c.value[1])}},clear:function(){l.writeAccess(this),this.array=[],this.vals=[],this._dateCache={}},has:function(a){return a instanceof Date&&(a=this._dateCache[a.getTime()]||a),-1!=this.array.indexOf(a)},get:function(a){a instanceof Date&&(a=this._dateCache[a.getTime()]||a);var b=this.array.indexOf(a);return b>-1?this.vals[b]:void 0},add:function(a){l.writeAccess(this),this.set(a,a)},set:function(a,b){if(l.writeAccess(this),a instanceof Date){var c=a.getTime();a=this._dateCache[c]||a,this._dateCache[c]=a}var d=this.array.indexOf(a);-1==d&&(d=this.array.length,this.array[d]=a),this.vals[d]=b},"delete":function(a){if(l.writeAccess(this),a instanceof Date){var b=a.getTime();a=this._dateCache[b]||a,delete this._dateCache[b]}var c=this.array.indexOf(a);c>-1&&(this.array.splice(c,1),this.vals.splice(c,1))},entries:function(){var a=this.array,b=this.vals;return new e(this.size,function(c){return[a[c],b[c]]})},keys:function(){var a=this.array;return new e(this.size,function(b){return a[b]})},values:function(){var a=this.vals;return new e(this.size,function(b){return a[b]})},toString:function(){for(var a="",b=0,c=this.size;c>b;++b)""!=a&&(a+=", "),a+=this.array[b],a+=" => ",a+=this.vals[b];return"{"+a+"}"},toJSON:function(){for(var a=[],b=0,c=this.size;c>b;++b)a.push({key:this.array[b],value:this.vals[b]});return a}}),k.prototype[m]=k.prototype.entries},{"./util/Metadata":54}],18:[function(a,b,c){var d=a("../error/PersistentError"),e=Object.inherit({extend:{DEFAULT_BASE_PATH:"/v1",HTTP_DOMAIN:".app.baqend.com",SSL_DOMAIN:"-bq.global.ssl.fastly.net",RESPONSE_HEADERS:["Baqend-Authorization-Token","Content-Type"],connectors:[],connections:{},gzip:!1,create:function(a,b,c,d){if(a||"undefined"==typeof window||(a=window.location.hostname,b=Number(window.location.port),c="https:"==window.location.protocol),void 0===d&&(d=e.DEFAULT_BASE_PATH),-1!=a.indexOf("/")){var f=/^(https?):\/\/([^\/:]+|\[[^\]]+])(:(\d*))?(\/\w+)?\/?$/.exec(a);if(!f)throw new Error("The connection uri host "+a+" seems not to be valid");c="https"==f[1],a=f[2].replace(/(\[|])/g,""),b=f[4],d=f[5]||""}else"localhost"!=a&&/^[a-z0-9-]*$/.test(a)&&(a+=c?e.SSL_DOMAIN:e.HTTP_DOMAIN);b||(b=c?443:80);var g=e.toUri(a,b,c,d),h=this.connections[g];if(!h){for(var i in this.connectors){var j=this.connectors[i];if(j.isUsable&&j.isUsable(a,b,c,d)){h=new j(a,b,c,d);break}}if(!h)throw new Error("No connector is usable for the requested connection.");this.connections[g]=h}return h},toUri:function(a,b,c,d){var e=(c?"https://":"http://")+(-1!=a.indexOf(":")?"["+a+"]":a);return e+=c&&443!=b||!c&&80!=b?":"+b:"",e+=d}},constructor:function f(a,b,c,d){this.host=a,this.port=b,this.secure=c,this.basePath=d,this.socket=null,this.listeners={},this.origin=f.toUri(a,b,c,"")},send:function(a){return"OAUTH"==a.request.method&&a.addRedirectOrigin(this.origin+this.basePath),new Promise(function(b,c){this.prepareRequestEntity(a),this.doSend(a.request,this.receive.bind(this,a,b,c))}.bind(this))["catch"](function(a){throw d.of(a)})},receive:function(a,b,c,e){a.response=e;try{a.response.status=1223==a.response.status?204:a.response.status,this.prepareResponseEntity(a),a.doReceive(),b(a)}catch(f){f=d.of(f),a.response.entity=null,c(f)}},doSend:function(a,b){},subscribe:function(a,b){a=String.isInstance(a)?a:JSON.stringify(a),this.listeners[a]?-1==this.listeners[a].indexOf(b)&&this.listeners[a].push(b):this.listeners[a]=[b]},unsubscribe:function(a,b){if(a=String.isInstance(a)?a:JSON.stringify(a),this.listeners[a]){var c=this.listeners[a].indexOf(b);-1!=c&&this.listeners[a].splice(c,1)}},socketListener:function(a){var b=JSON.parse(a.data),c=b.topic;c=String.isInstance(c)?c:JSON.stringify(c),this.listeners[c]&&this.listeners[c].forEach(function(a){a(b)})},socketOpen:null,sendOverSocket:function(a){null===this.socket&&(this.socket=this.createWebSocket((this.secure?"wss://":"ws://")+this.host+":"+this.port+this.basePath+"/events"),this.socket.onmessage=this.socketListener.bind(this),this.socketOpen=new Promise(function(a,b){this.socket.onopen=a,this.socket.onerror=b}.bind(this)),this.socket.onclose=function(){this.socket=null,this.socketOpen=null}.bind(this));var b=JSON.stringify(a);this.socketOpen.then(function(){this.socket.send(b)}.bind(this))},createWebSocket:function(a){},prepareRequestEntity:function(a){a.request.entity&&(String.isInstance(a.request.entity)?a.request.headers["Content-Type"]="text/plain;charset=utf-8":(a.request.headers["Content-Type"]="application/json;charset=utf-8",a.request.entity=JSON.stringify(a.request.entity))),this.gzip&&a.request.headers["If-None-Match"]&&"*"!=a.request.headers["If-None-Match"]&&(a.request.headers["If-None-Match"]=a.request.headers["If-None-Match"].slice(0,-1)+'--gzip"')},prepareResponseEntity:function(a){var b=a.response.entity;if(b&&b.length>0){var c=a.response.headers["Content-Type"]||a.response.headers["content-type"];c&&c.indexOf("application/json")>-1&&(b=JSON.parse(b))}else b=null;a.request.path.indexOf("/connect")>-1&&(this.gzip=!!b.gzip),a.response.entity=b}});b.exports=e},{"../error/PersistentError":28}],19:[function(a,b,c){var d=a("./Connector"),e=d.inherit({extend:{loadedAttr:"data-loaded",style:"width:1px;height:1px;position:absolute;top:-10px;left:-10px;",initialize:function(){d.connectors.push(this)},isUsable:function(a,b,c){return"undefined"!=typeof window&&(window.location.hostname!=a||window.location.port!=b)}},queue:null,origin:null,iframe:null,messages:null,mid:0,constructor:function f(a,b,c,e){d.call(this,a,b,c,e),this.messages={};var g=this.origin+this.basePath+"/connect";this.iframe=document.querySelector('iframe[src="'+g+'"]'),this.iframe&&this.iframe.src==g||(this.iframe=document.createElement("iframe"),this.iframe.src=g,this.iframe.setAttribute("style",f.style),document.body.appendChild(this.iframe)),this.isLoaded()||(this.queue=[],this.iframe.addEventListener("load",this.onLoad.bind(this),!1)),window.addEventListener("message",this.doReceive.bind(this),!1)},onLoad:function(){for(var a=this.queue,b=0;b<a.length;++b)this.iframe.contentWindow.postMessage(a[b],this.origin);this.queue=null,this.setLoaded()},setLoaded:function(){this.iframe.setAttribute(e.loadedAttr,!0)},isLoaded:function(){return!!this.iframe.getAttribute(e.loadedAttr)},doSend:function(a,b){var c={mid:++this.mid,method:a.method,path:a.path,headers:a.headers,entity:a.entity,responseHeaders:d.RESPONSE_HEADERS};this.messages[c.mid]={request:a,receive:b},c=JSON.stringify(c),this.queue?this.queue.push(c):this.iframe.contentWindow.postMessage(c,this.origin)},createWebSocket:function(a){return new WebSocket(a)},doReceive:function(a){if(a.origin===this.origin&&"{"==a.data[0]){var b=JSON.parse(a.data),c=this.messages[b.mid];delete this.messages[b.mid],c.receive({status:b.status,headers:b.headers,entity:b.entity})}}});b.exports=e},{"./Connector":18}],20:[function(a,b,c){var d=a("../error/CommunicationError"),e=Object.inherit({extend:{StatusCode:{NOT_MODIFIED:304,BAD_CREDENTIALS:460,BUCKET_NOT_FOUND:461,INVALID_PERMISSION_MODIFICATION:462,INVALID_TYPE_VALUE:463,OBJECT_NOT_FOUND:404,OBJECT_OUT_OF_DATE:412,PERMISSION_DENIED:466,QUERY_DISPOSED:467,QUERY_NOT_SUPPORTED:468,SCHEMA_NOT_COMPATIBLE:469,SCHEMA_STILL_EXISTS:470,SYNTAX_ERROR:471,TRANSACTION_INACTIVE:472,TYPE_ALREADY_EXISTS:473,TYPE_STILL_REFERENCED:474,SCRIPT_ABORTION:475},create:function(a){var b=a.path.split("?"),c=b[0].split(/:\w*/),d=[];return b[1]&&b[1].split("&").forEach(function(a){var b=a.split("=");d.push(b[0])}),a.path=c,a.query=d,e.inherit({spec:a})},createExternal:function(a,b){return a.path=[a.path],e.inherit({spec:a})}},spec:null,withCredentials:!1,initialize:function(){var a=arguments,b=0,c=this.spec.path;if(!String.isInstance(c)){c=this.spec.path[0];for(var d=1;d<this.spec.path.length;++d)c+=encodeURIComponent(a[b++])+this.spec.path[d]}for(var e="",d=0;d<this.spec.query.length;++d){var f=a[b++];void 0!==f&&null!==f&&(e+=e||~c.indexOf("?")?"&":"?",e+=this.spec.query[d]+"="+encodeURIComponent(f))}this.request={method:this.spec.method,path:c+e,headers:{accept:"application/json, text/*;q=0.1"},entity:a[b]||null},this.response={status:0,headers:{},entity:null}},setIfMatch:function(a){"*"!=a&&(a='"'+a+'"'),this.request.headers["If-Match"]=a},setIfNoneMatch:function(a){"*"!=a&&(a='"'+a+'"'),this.request.headers["If-None-Match"]=a},setCacheControl:function(a){this.request.headers["Cache-Control"]=a},getAuthorizationToken:function(){return this.response.headers["Baqend-Authorization-Token"]||this.response.headers["baqend-authorization-token"]},setAuthorizationToken:function(a){this.request.headers.Authorization="BAT "+a},withAuthorizationToken:function(a){a?this.setAuthorizationToken(a):this.request.withCredentials=!0},addQueryString:function(a){if(String.isInstance(a))this.request.path+=a;else if(a){var b=~this.request.path.indexOf("?")?"&":"?";Object.keys(a).forEach(function(c,d){this.request.path+=b+c+"="+encodeURIComponent(a[c]),0==d&&(b="&")}.bind(this))}},doReceive:function(){if(-1==this.spec.status.indexOf(this.response.status))throw new d(this)}});e.GoogleOAuth=e.createExternal({method:"OAUTH",path:"https://accounts.google.com/o/oauth2/auth?response_type=code&access_type=online",query:["client_id","scope","state"],status:[200]}),e.GoogleOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/google"})},e.FacebookOAuth=e.createExternal({method:"OAUTH",path:"https://www.facebook.com/dialog/oauth?response_type=code",query:["client_id","scope","state"],status:[200]}),e.FacebookOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/facebook"})},e.GitHubOAuth=e.createExternal({method:"OAUTH",path:"https://github.com/login/oauth/authorize?response_type=code&access_type=online",query:["client_id","scope","state"],status:[200]}),e.GitHubOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/github"})},e.LinkedInOAuth=e.createExternal({method:"OAUTH",path:"https://www.linkedin.com/uas/oauth2/authorization?response_type=code&access_type=online",query:["client_id","scope","state"],status:[200]}),e.LinkedInOAuth.prototype.addRedirectOrigin=function(a){this.addQueryString({redirect_uri:a+"/db/User/OAuth/linkedin"})},e.TwitterOAuth=e.createExternal({method:"OAUTH",path:"",query:[],status:[200]}),e.TwitterOAuth.prototype.addRedirectOrigin=function(a){this.request.path=a+"/db/User/OAuth1/twitter"},b.exports=e},{"../error/CommunicationError":24}],21:[function(a,b,c){var d=a("./Connector"),e=d.inherit({extend:{initialize:function(){d.connectors.push(this)},isUsable:function(b,c,d){if(!this.prototype.http)try{var e;e=a(d?"https":"http"),e.request&&e.Server&&(this.prototype.http=e)}catch(f){}return Boolean(this.prototype.http)}},constructor:function(){d.apply(this,arguments)},cookie:null,doSend:function(a,b){a.host=this.host,a.port=this.port,a.path=this.basePath+a.path;var c=this,d=a.entity;this.cookie&&this.secure&&a.withCredentials&&(a.headers.Cookie=this.cookie);var e=this.http.request(a,function(a){var d="";a.setEncoding("utf-8"),a.on("data",function(a){d+=a}),a.on("end",function(){var e=a.headers["set-cookie"];e&&(c.cookie=c.parseCookie(e+"")),b({status:a.statusCode,headers:a.headers,entity:d})})});e.on("error",function(a){b({status:0,error:a})}),d?e.end(d,"utf8"):e.end()},createWebSocket:function(b){var c=a("websocket").w3cwebsocket;return new c(b)},parseCookie:function(a){for(var b,c=a.split(";"),d=0;b=c[d];++d)if(0==b.indexOf("Expires=")){var e=Date.parse(b.substring(8));if(e<Date.now())return null}return c[0]}});b.exports=e},{"./Connector":18,http:void 0,https:void 0,websocket:void 0}],22:[function(a,b,c){var d=a("./Connector"),e=d.inherit({extend:{initialize:function(){d.connectors.push(this)},isUsable:function(a,b,c){return"undefined"!=window&&window.location.hostname==a&&window.location.port==b&&window.location.protocol==(c?"https:":"http:")&&"undefined"!=typeof XMLHttpRequest}},constructor:function(){d.apply(this,arguments)},doSend:function(a,b){if("OAUTH"==a.method)return void addEventListener("storage",function i(a){"oauth-response"==a.key&&(b(JSON.parse(a.newValue)),localStorage.removeItem("oauth-response"),removeEventListener("storage",i,!1))},!1);var c=new XMLHttpRequest,e=this.origin+this.basePath+a.path;c.onreadystatechange=function(){if(4==c.readyState){var a={headers:{},status:c.status,entity:c.response||c.responseText};d.RESPONSE_HEADERS.forEach(function(b){a.headers[b]=c.getResponseHeader(b)}),b(a)}},c.open(a.method,e,!0);var f=a.entity,g=a.headers;for(var h in g)c.setRequestHeader(h,g[h]);c.withCredentials=a.withCredentials,c.send(f)},createWebSocket:function(a){return new WebSocket(a)}});b.exports=e},{"./Connector":18}],23:[function(a,b,c){c.Message=a("./Message"),c.Connector=a("./Connector"),c.NodeConnector=a("./NodeConnector"),c.XMLHttpConnector=a("./XMLHttpConnector"),c.IFrameConnector=a("./IFrameConnector")},{"./Connector":18,"./IFrameConnector":19,"./Message":20,"./NodeConnector":21,"./XMLHttpConnector":22}],24:[function(a,b,c){var d=a("./PersistentError"),e=d.inherit({status:0,constructor:function(a){var b=a.response.entity||{},c=0==a.response.status?"Request":"Response",e=b.message||"Handling the "+c+" for "+a.request.method+" "+a.request.path;d.call(this,e,b),this.name=b.className||"CommunicationError",this.reason=b.reason||"Communication failed",this.status=a.response.status,b.data&&(this.data=b.data);for(var f=b;f&&f.stackTrace;){this.stack+="\nServerside Caused by: "+f.className+" "+f.message;for(var g=f.stackTrace,h=0;h<g.length;++h){var i=g[h];this.stack+="\n    at "+i.className+"."+i.methodName,this.stack+=" ("+i.fileName+":"+i.lineNumber+")"}f=f.cause}}});b.exports=e},{"./PersistentError":28}],25:[function(a,b,c){var d=a("./PersistentError"),e=d.inherit({constructor:function(a){d.call(this,"The entity "+a+" is managed by a different db."),this.entity=a}});b.exports=e},{"./PersistentError":28}],26:[function(a,b,c){var d=a("./PersistentError"),e=d.inherit({constructor:function(a){d.call(this,"Entity "+a+" is not found"),this.identity=a}});b.exports=e},{"./PersistentError":28}],27:[function(a,b,c){var d=a("./PersistentError"),e=d.inherit({constructor:function(a){d.call(this,"Entity "+a+" is not a valid entity"),this.entity=a}});b.exports=e},{"./PersistentError":28}],28:[function(a,b,c){var d=Error.inherit({cause:null,extend:{of:function(a){return a instanceof d?a:new d(null,a)}},constructor:function(a,b){a=a?a:"An unexpected persistent error occured.",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=a,this.name=this.constructor.name,b&&(this.cause=b,b.stack&&(this.stack+="\nCaused By: "+b.stack))}});b.exports=d},{}],29:[function(a,b,c){var d=a("./PersistentError"),e=d.inherit({constructor:function(a){d.call(this,"The transaction has been rollbacked",a)}});b.exports=e},{"./PersistentError":28}],30:[function(a,b,c){c.CommunicationError=a("./CommunicationError"),c.EntityExistsError=a("./EntityExistsError"),c.EntityNotFoundError=a("./EntityNotFoundError"),c.IllegalEntityError=a("./IllegalEntityError"),c.PersistentError=a("./PersistentError"),c.RollbackError=a("./RollbackError")},{"./CommunicationError":24,"./EntityExistsError":25,"./EntityNotFoundError":26,"./IllegalEntityError":27,"./PersistentError":28,"./RollbackError":29}],31:[function(a,b,c){a("jahcode"),a("lie/dist/lie.polyfill"),a("./polyfills");var d=a("./EntityManagerFactory"),e=a("./EntityManager"),f=new d({global:!0});c=b.exports=f.createEntityManager(!0),e.prototype.collection=a("./collection"),e.prototype.binding=a("./binding"),e.prototype.connector=a("./connector"),e.prototype.error=a("./error"),e.prototype.message=a("./message"),e.prototype.metamodel=a("./metamodel"),e.prototype.util=a("./util"),e.prototype.EntityManager=a("./EntityManager"),e.prototype.EntityManagerFactory=a("./EntityManagerFactory"),e.prototype.EntityTransaction=a("./EntityTransaction"),e.prototype.Query=a("./Query"),c.connect=function(a,b,c,d){return b instanceof Function&&(d=c,c=b,b=!1),f.connect(a,b),this.ready(c,d)}},{"./EntityManager":1,"./EntityManagerFactory":2,"./EntityTransaction":3,"./Query":5,"./binding":16,"./collection":17,"./connector":23,"./error":30,"./message":32,"./metamodel":48,"./polyfills":49,"./util":60,jahcode:61,"lie/dist/lie.polyfill":62}],32:[function(a,b,c){var d=a("./connector/Message");c.ListAllResources=d.create({method:"GET",path:"/",status:[200]}),c.ApiVersion=d.create({method:"GET",path:"/version",status:[200]}),c.Specification=d.create({method:"GET",path:"/spec",status:[200]}),c.GetBloomFilter=d.create({method:"GET",path:"/replication",status:[200]}),c.GetOrestesConfig=d.create({method:"GET",path:"/config",status:[200]}),c.UpdateOrestesConfig=d.create({method:"PUT",path:"/config",status:[200,202]}),c.Connect=d.create({method:"GET",path:"/connect",status:[200]}),c.Status=d.create({method:"GET",path:"/status",status:[200]}),c.BannedIp=d.create({method:"GET",path:"/banned/:ip",status:[204]}),c.Banned=d.create({method:"GET",path:"/banned",status:[]}),c.Unban=d.create({method:"DELETE",path:"/banned",status:[204]}),c.UnbanIp=d.create({method:"DELETE",path:"/banned/:ip",status:[204]}),c.GetBucketNames=d.create({method:"GET",path:"/db",status:[200]}),c.GetBucketIds=d.create({method:"GET",path:"/db/:bucket/ids?start=0&count=-1",status:[200]}),c.ExportBucket=d.create({method:"GET",path:"/db/:bucket?bat=",status:[200]}),c.ImportBucket=d.create({method:"PUT",path:"/db/:bucket?bat=",status:[200]}),c.TruncateBucket=d.create({method:"DELETE",path:"/db/:bucket?bat=",status:[200]}),c.CreateObject=d.create({method:"POST",path:"/db/:bucket",status:[201,202]}),c.GetObject=d.create({method:"GET",path:"/db/:bucket/:oid",status:[200,304]}),c.ReplaceObject=d.create({method:"PUT",path:"/db/:bucket/:oid",status:[200,202]}),c.DeleteObject=d.create({method:"DELETE",path:"/db/:bucket/:oid",status:[202,204]}),c.GetAllSchemas=d.create({method:"GET",path:"/schema",status:[200]}),c.UpdateAllSchemas=d.create({method:"POST",path:"/schema",status:[200]}),c.ReplaceAllSchemas=d.create({method:"PUT",path:"/schema",status:[200]}),c.GetSchema=d.create({method:"GET",path:"/schema/:bucket",status:[200]}),c.UpdateSchema=d.create({method:"POST",path:"/schema/:bucket",status:[200]}),c.ReplaceSchema=d.create({method:"PUT",path:"/schema/:bucket",status:[200]}),c.DeleteSchema=d.create({method:"DELETE",path:"/schema/:bucket",status:[204]}),c.AdhocQuery=d.create({method:"GET",path:"/db/:bucket/query?q&start=0&count=-1&sort=&eager=",status:[200]}),c.AdhocQueryPOST=d.create({method:"POST",path:"/db/:bucket/query?start=0&count=-1&sort=",status:[200]}),c.AdhocCountQuery=d.create({method:"GET",path:"/db/:bucket/count?q",status:[200]}),c.AdhocCountQueryPOST=d.create({method:"POST",path:"/db/:bucket/count",status:[200]}),c.ListQueryResources=d.create({method:"GET",path:"/query",status:[200]}),c.CreateQuery=d.create({method:"POST",path:"/query",status:[201]}),c.ListThisQueryResources=d.create({method:"GET",path:"/query/:qid",status:[200]}),c.GetQueryCode=d.create({method:"GET",path:"/query/:qid/source",status:[200]}),c.RunQuery=d.create({method:"GET",path:"/query/:qid/result?start=0&count=-1",status:[200]}),c.GetQueryParameters=d.create({method:"GET",path:"/query/:qid/parameters",status:[200]}),c.NewTransaction=d.create({method:"POST",path:"/transaction",status:[201]}),c.CommitTransaction=d.create({method:"PUT",path:"/transaction/:tid/committed",status:[200]}),c.GetObjectInExplicitVersion=d.create({method:"GET",path:"/db/:bucket/:oid/:version",status:[200]}),c.UpdatePartially=d.create({method:"POST",path:"/db/:bucket/:oid",status:[204]}),c.UpdateField=d.create({method:"POST",path:"/db/:bucket/:oid/:field",status:[204]}),c.Login=d.create({method:"POST",path:"/db/User/login",status:[200]}),c.Register=d.create({method:"POST",path:"/db/User/register",status:[200,204]}),c.Me=d.create({method:"GET",path:"/db/User/me",status:[200]}),c.ValidateUser=d.create({method:"GET",path:"/db/User/validate",status:[200]}),c.Logout=d.create({method:"GET",path:"/db/User/logout",status:[204]}),c.NewPassword=d.create({method:"POST",path:"/db/User/password",status:[200]}),c.Verify=d.create({method:"GET",path:"/db/User/verify?token=",status:[204]}),c.OAuth2=d.create({method:"GET",path:"/db/User/OAuth/:provider?state=&code=&oauth_verifier=&oauth_token=",status:[200]}),c.OAuth1=d.create({method:"GET",path:"/db/User/OAuth1/:provider",status:[200]}),c.GetBaqendCode=d.create({method:"GET",path:"/code/:bucket/:type",status:[200]}),c.SetBaqendCode=d.create({method:"PUT",path:"/code/:bucket/:type",status:[200,202]}),c.DeleteBaqendCode=d.create({method:"DELETE",path:"/code/:bucket/:type",status:[202,204]}),c.PostBaqendModule=d.create({method:"POST",path:"/code/:bucket",status:[200,204]}),c.GetBaqendModule=d.create({method:"GET",path:"/code/:bucket",status:[200,204]}),c.GetAllModules=d.create({method:"GET",path:"/code",status:[200]}),c.ListFiles=d.create({method:"GET",path:"/file/:bucket/ids?start=&count=-1",status:[200]}),c.GetFileBucketAcls=d.create({method:"GET",path:"/file/:bucket",status:[200]}),c.SetFileBucketAcls=d.create({method:"PUT",path:"/file/:bucket",status:[204]}),c.DeleteFileBucket=d.create({method:"DELETE",path:"/file/:bucket",status:[204]}),c.CreateFile=d.create({method:"POST",path:"/file/:bucket",status:[200]}),c.GetFile=d.create({method:"GET",path:"/file/:bucket/:oid",status:[200,304]}),c.SetFileAcl=d.create({method:"POST",path:"/file/:bucket/:oid",status:[204]}),c.ReplaceFile=d.create({method:"PUT",path:"/file/:bucket/:oid",status:[200]}),c.DeleteFile=d.create({method:"DELETE",path:"/file/:bucket/:oid",status:[203]}),c.ListIndexes=d.create({method:"GET",path:"/index/:bucket",status:[200]}),c.CreateDropIndex=d.create({method:"POST",path:"/index/:bucket",status:[202]}),c.DropAllIndexes=d.create({method:"DELETE",path:"/index/:bucket",status:[202]}),c.DeviceRegister=d.create({method:"POST",path:"/db/Device/register",status:[204]}),c.DevicePush=d.create({method:"POST",path:"/db/Device/push",status:[204]}),c.DeviceRegistered=d.create({method:"GET",path:"/db/Device/registered",status:[200]}),c.UploadAPNSCertificate=d.create({method:"POST",path:"/config/APNSCert",status:[204]}),c.GCMAKey=d.create({method:"POST",path:"/config/GCMKey",status:[204]})},{"./connector/Message":20}],33:[function(a,b,c){var d=a("../binding/Accessor"),e=Object.inherit({extend:{PersistentAttributeType:{BASIC:0,ELEMENT_COLLECTION:1,EMBEDDED:2,MANY_TO_MANY:3,MANY_TO_ONE:4,ONE_TO_MANY:5,ONE_TO_ONE:6}},get isAssociation(){return this.persistentAttributeType>e.PersistentAttributeType.EMBEDDED},get isCollection(){return this.persistentAttributeType==e.PersistentAttributeType.ELEMENT_COLLECTION},isId:!1,isVersion:!1,isAcl:!1,isMetadata:!1,accessor:null,persistentAttributeType:-1,declaringType:null,name:null,order:null,constructor:function(a,b){this.name=a,this.isMetadata=!!b},init:function(a,b){if(this.declaringType)throw new Error("The attribute is already initialized.");this.order=b,this.accessor=new d,this.declaringType=a},getValue:function(a){return this.accessor.getValue(a,this)},setValue:function(a,b){this.accessor.setValue(a,this,b)},getJsonValue:function(a,b){},setJsonValue:function(a,b,c){},toJSON:function(){}});b.exports=e},{"../binding/Accessor":6}],34:[function(a,b,c){var d=a("./Type"),e=a("../GeoPoint"),f=d.inherit({persistenceType:d.PersistenceType.BASIC,noResolving:!1,constructor:function(a,b,c){0!=a.indexOf("/db/")&&(a="/db/"+a),d.call(this,a,b),this.noResolving=c},toJsonValue:function(a,b){return null===b||void 0===b?null:this.typeConstructor.asInstance(b)},fromJsonValue:function(a,b,c){return null===b||void 0===b?null:this.typeConstructor.asInstance(b)},toString:function(){return"BasicType("+this.ref+")"}});f.extend({Boolean:new f("Boolean",Boolean),Double:new f("Double",Number),Integer:new f("Integer",Number),String:new f("String",String),DateTime:new(f.inherit({constructor:function(){f.call(this,"DateTime",Date)},toJsonValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString()),c}})),Date:new(f.inherit({constructor:function(){f.call(this,"Date",Date)},toJsonValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString(),c=c.substring(0,c.indexOf("T"))),c},fromJsonValue:function(a,b){return this.superCall(a,String.isInstance(b)?b+"T00:00Z":b)}})),Time:new(f.inherit({constructor:function(){f.call(this,"Time",Date)},toJsonValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString(),c=c.substring(c.indexOf("T")+1)),c},fromJsonValue:function(a,b){return this.superCall(a,String.isInstance(b)?"1970-01-01T"+b:b)}})),GeoPoint:new f("GeoPoint",e),JsonArray:new(f.inherit({constructor:function(){f.call(this,"JsonArray",Array)},init:function(a){this._enhancer=a},toJsonValue:function(a,b){return b&&b.constructor==Array?b:null}})),JsonObject:new(f.inherit({constructor:function(){f.call(this,"JsonObject",Object)},init:function(a){this._enhancer=a},toJsonValue:function(a,b){return b&&b.constructor==Object?b:null}}))}),b.exports=f},{"../GeoPoint":4,"./Type":47}],35:[function(a,b,c){var d=a("./PluralAttribute"),e=a("../collection"),f=d.inherit({collectionType:d.CollectionType.COLLECTION,constructor:function(a,b){d.call(this,a,b),this.typeConstructor=e.Collection}});b.exports=f},{"../collection":17,"./PluralAttribute":44}],36:[function(a,b,c){var d=Object.inherit({extend:{ASC:"asc",DESC:"desc",GEO:"geo",fromJSON:function(a){return new d(a.keys,a.unique)}},drop:!1,constructor:function e(a,b){if(String.isInstance(a)){var c={};c[a]=e.ASC,this.keys=[c]}else if(Array.isInstance(a))this.keys=a;else{if(!Object.isInstance(a))throw new Error("The keys parameter must be an String, Object or Array.");this.keys=[a]}this.unique=b===!0},hasKey:function(a){for(var b=0;b<this.keys.length;b++)if(this.keys[b][a])return!0;return!1},get isCompound(){return this.keys.length>1},get isUnique(){return this.unique},toJSON:function(){return{unique:this.unique,keys:this.keys,drop:this.drop}}});b.exports=d},{}],37:[function(a,b,c){var d=a("./ManagedType"),e=a("./Type"),f=a("../binding"),g=d.inherit({persistenceType:e.PersistenceType.EMBEDDABLE,constructor:function(a,b){d.call(this,a,b)},createProxyClass:function(){return this._enhancer.createProxy(f.Managed)},createObjectFactory:function(a){return f.ManagedFactory.create(this,a)},create:function(){var a=Object.create(this.typeConstructor.prototype);
return Object.defineProperty(a,"_metadata",{value:{type:this},writable:!1,enumerable:!1,configurable:!0}),a},toJsonValue:function(a,b){return a._root&&this.typeConstructor.isInstance(b)&&!b._metadata._root&&(b._metadata._root=a._root),this.superCall(a,b)},fromJsonValue:function(a,b,c){return b&&(this.typeConstructor.isInstance(c)||(c=this.create()),a._root&&!c._metadata._root&&(c._metadata._root=a._root)),this.superCall(a,b,c)},toString:function(){return"EmbeddableType("+this.ref+")"}});b.exports=g},{"../binding":16,"./ManagedType":40,"./Type":47}],38:[function(a,b,c){var d=a("../binding"),e=a("./SingularAttribute"),f=a("./BasicType"),g=a("./Type"),h=a("./ManagedType"),i=a("../util"),j=h.inherit({persistenceType:g.PersistenceType.ENTITY,declaredId:null,declaredVersion:null,declaredAcl:null,superType:null,get id(){return this.declaredId||this.superType.id},get version(){return this.declaredVersion||this.superType.version},get acl(){return this.declaredAcl||this.superType.acl},loadPermission:null,updatePermission:null,insertPermission:null,deletePermission:null,queryPermission:null,schemaSubclassPermission:null,constructor:function(a,b,c){h.call(this,a,c),this.superType=b,this.loadPermission=new i.Permission,this.insertPermission=new i.Permission,this.updatePermission=new i.Permission,this.deletePermission=new i.Permission,this.queryPermission=new i.Permission,this.schemaSubclassPermission=new i.Permission},createProxyClass:function(){var a=this.superType.typeConstructor;if(a===Object)switch(this.name){case"User":a=d.User;break;case"Role":a=d.Role;break;default:a=d.Entity}return this._enhancer.createProxy(a)},create:function(){var a=Object.create(this.typeConstructor.prototype);return Object.defineProperty(a,"_metadata",{value:new i.Metadata(a,this),writable:!1,enumerable:!1,configurable:!0}),a},createObjectFactory:function(a){switch(this.name){case"User":return d.UserFactory.create(this,a);case"Device":return d.DeviceFactory.create(this,a);case"Object":return}return d.EntityFactory.create(this,a)},fromJsonValue:function(a,b,c,d){return d?this.superCall(a,b,c):b?a.db.getReference(b):null},toJsonValue:function(a,b,c){return c?this.superCall(a,b):this.typeConstructor.isInstance(b)?(b.attach(a.db),b.id):null},toString:function(){return"EntityType("+this.ref+")"},toJSON:function(){var a=this.superCall();return a.acl.schemaSubclass=this.schemaSubclassPermission,a.acl.insert=this.insertPermission,a.acl.update=this.updatePermission,a.acl["delete"]=this.deletePermission,a.acl.query=this.queryPermission,a}});j.extend({Object:j.inherit({extend:{ref:"/db/Object"},constructor:function(){j.call(this,j.Object.ref,null,Object),this.declaredId=new e("id",f.String,!0),this.declaredId.init(this,0),this.declaredId.isId=!0,this.declaredVersion=new e("version",f.Double,!0),this.declaredVersion.init(this,1),this.declaredVersion.isVersion=!0,this.declaredAcl=new e("acl",f.JsonObject,!0),this.declaredAcl.init(this,2),this.declaredAcl.isAcl=!0,this.declaredAttributes=[this.declaredId,this.declaredVersion,this.declaredAcl]}})}),b.exports=j},{"../binding":16,"../util":60,"./BasicType":34,"./ManagedType":40,"./SingularAttribute":46,"./Type":47}],39:[function(a,b,c){var d=a("./PluralAttribute"),e=a("../collection"),f=d.inherit({extend:{ref:"/db/collection.List"},collectionType:d.CollectionType.LIST,constructor:function(a,b){d.call(this,a,b),this.typeConstructor=e.List},toJSON:function(){return{name:this.name,type:f.ref+"["+this.elementType.ref+"]",order:this.order}}});b.exports=f},{"../collection":17,"./PluralAttribute":44}],40:[function(a,b,c){var d=a("../binding"),e=a("./Type"),f=a("../util/Permission"),g=a("../collection").Iterator,h=a("../util/Validator"),i=e.inherit({AttributeIterator:Object.inherit(g,{index:0,constructor:function(a){this.types=[];do this.types.push(a);while(a=a.superType)},next:function(){for(var a=this.types.pop();a&&a.declaredAttributes.length==this.index;)a=this.types.pop(),this.index=0;return a?(this.types.push(a),{done:!1,value:a.declaredAttributes[this.index++]}):g.DONE}}),_enhancer:null,declaredAttributes:null,superType:null,schemaAddPermission:null,schemaReplacePermission:null,set validationCode(a){a?this._validationCode=h.compile(this,a):this._validationCode=null},get validationCode(){return this._validationCode},_validationCode:null,get typeConstructor(){return this._typeConstructor||(this.typeConstructor=this.createProxyClass()),this._typeConstructor},set typeConstructor(a){if(this._typeConstructor)throw new Error("Type constructor has already been set.");var b=a.prototype instanceof d.Entity;if(this.isEntity){if(!b)throw new TypeError("Entity classes must extends the Entity class.")}else if(!(a.prototype instanceof d.Managed)||b)throw new TypeError("Embeddable classes must extends the Managed class.");this._enhancer.enhance(this,a),this._typeConstructor=a},constructor:function(a,b){e.call(this,0!=a.indexOf("/db/")?"/db/"+a:a,b),this.declaredAttributes=[],this.schemaAddPermission=new f,this.schemaReplacePermission=new f},init:function(a){this._enhancer=a,this._typeConstructor&&!this._enhancer.getIdentifier(this._typeConstructor)&&this._enhancer.setIdentifier(this._typeConstructor,this.ref)},createProxyClass:function(){},createObjectFactory:function(a){},create:function(){},attributes:function(){return new this.AttributeIterator(this)},addAttribute:function(a,b){if(this.getAttribute(a.name))throw new Error("An attribute with the name "+a.name+" is already declared.");b=null==a.order?"undefined"==typeof b?this.declaredAttributes.length:b:a.order,a.init(this,b),this.declaredAttributes.push(a),this._typeConstructor&&"Object"!=this.name&&this._enhancer.enhanceProperty(this._typeConstructor,a)},removeAttribute:function(a){var b=this.declaredAttributes.length;if(this.declaredAttributes=this.declaredAttributes.filter(function(b){return b.name!=a}),b==this.declaredAttributes.length)throw new Error("An Attribute with the name "+a+" is not declared.")},getAttribute:function(a){var b=this.getDeclaredAttribute(a);return!b&&this.superType&&(b=this.superType.getAttribute(a)),b},getDeclaredAttribute:function(a){for(var b,c=0;b=this.declaredAttributes[c];++c)if(b.name===a||b.order===a)return b;return null},fromJsonValue:function(a,b,c){if(b)for(var d,e=this.attributes();!(d=e.next()).done;){var f=d.value;f.isMetadata||f.setJsonValue(a,c,b[f.name])}else c=null;return c},toJsonValue:function(a,b){var c=null;if(this.typeConstructor.isInstance(b)){c={};for(var d,e=this.attributes();!(d=e.next()).done;){var f=d.value;f.isMetadata||(c[f.name]=f.getJsonValue(a,b))}}return c},toJSON:function(){var a={};a["class"]=this.ref,this.superType&&(a.superClass=this.superType.ref),this.isEmbeddable&&(a.embedded=!0),a.acl={load:this.loadPermission,schemaAdd:this.schemaAddPermission,schemaReplace:this.schemaReplacePermission};for(var b,c=a.fields={},d=0;b=this.declaredAttributes[d];d++)b.isMetadata||(c[b.name]=b);return a},references:function(){return new this.ReferenceIterator(this)},ReferenceIterator:Object.inherit({constructor:function(a){this.type=a,this.attributes=this.type.attributes(),this.embedded=[]},next:function(){for(var a,b=this.attributes;!(a=b.next()).done;){var c=a.value,d=c.isCollection?c.elementType:c.type;if(d.isEntity)return{done:!1,value:{path:[c.name]}};if(d.isEmbeddable)for(var e,f=d.references();!(e=f.next()).done;)this.embedded.push({done:!1,value:{path:[c.name].concat(e.value.path)}})}return this.embedded.length?this.embedded.pop():{done:!0}}})});b.exports=i},{"../binding":16,"../collection":17,"../util/Permission":56,"../util/Validator":59,"./Type":47}],41:[function(a,b,c){var d=a("./PluralAttribute"),e=a("../collection"),f=a("../error/PersistentError"),g=d.inherit({extend:{ref:"/db/collection.Map"},collectionType:d.CollectionType.MAP,keyType:null,constructor:function(a,b,c){d.call(this,a,c),this.keyType=b,this.typeConstructor=e.Map},getJsonValue:function(a,b){var c=this.getValue(b);if(c){a._root&&!c._metadata&&Object.defineProperty(c,"_metadata",{value:{_root:a._root}});for(var d,e={},g=c.entries();!(d=g.next()).done;){if(null===d.value[0]||void 0===d.value[1])throw new f("Map keys can't be null nor undefined.");e[this.keyType.toJsonValue(a,d.value[0])]=this.elementType.toJsonValue(a,d.value[1])}return e}return null},setJsonValue:function(a,b,c){var d=null;if(c){d=this.getValue(b),this.typeConstructor.isInstance(d)||(d=new this.typeConstructor),a._root&&!d._metadata&&Object.defineProperty(d,"_metadata",{value:{_root:a._root}});var e=new this.typeConstructor(d);d.clear();for(var f in c){var g="Boolean"==this.keyType.name?"false"!=f:this.keyType.fromJsonValue(a,f),h=this.elementType.fromJsonValue(a,c[f],e.get(g));d.set(g,h)}}this.setValue(b,d)},toJSON:function(){return{name:this.name,type:g.ref+"["+this.keyType.ref+","+this.elementType.ref+"]",order:this.order}}});b.exports=g},{"../collection":17,"../error/PersistentError":28,"./PluralAttribute":44}],42:[function(a,b,c){var d=(a("./BasicType"),a("./ManagedType")),e=a("./EntityType"),f=a("../binding/Enhancer"),g=a("./ModelBuilder"),h=a("./DbIndex"),i=a("../util/Lockable"),j=a("../connector/Message").StatusCode,k=a("../message"),l=Object.inherit(i,{isInitialized:!1,_connector:null,entities:null,embeddables:null,baseTypes:null,constructor:function(){this._enhancer=new f},connected:function(a){this._connector=a},init:function(a){if(a){if(this.isInitialized)throw new Error("Metamodel is already initialized.");this.fromJSON(a||[]),this.isInitialized=!0}else if(!this.isInitialized&&this.isReady)return this.load();return this.ready()},_getRef:function(a){var b;return String.isInstance(a)?(b=a,0!=b.indexOf("/db/")&&(b="/db/"+a)):b=this._enhancer.getIdentifier(a),b},entity:function(a){var b=this._getRef(a);return b?this.entities[b]:null},baseType:function(a){var b=null;if(String.isInstance(a))b=this._getRef(a);else for(var c in this.baseTypes){var d=this.baseTypes[c];if(!d.noResolving&&d.typeConstructor==a){b=c;break}}return b?this.baseTypes[b]:null},embeddable:function(a){var b=this._getRef(a);return b?this.embeddables[b]:null},managedType:function(a){return this.baseType(a)||this.entity(a)||this.embeddable(a)},addType:function(a){var b;if(a.isBasic?b=this.baseTypes:a.isEmbeddable?(a.init(this._enhancer),b=this.embeddables):a.isEntity&&(a.init(this._enhancer),b=this.entities,null==a.superType&&a.ref!=e.Object.ref&&(a.superType=this.entity(e.Object.ref))),b[a.ref])throw new Error("The type "+a.ref+" is already declared.");return b[a.ref]=a},load:function(){if(this.isInitialized)throw new Error("Metamodel is already initialized.");return this.withLock(function(){var a=new k.GetAllSchemas;return this._connector.send(a).then(function(a){return this.fromJSON(a.response.entity),this.isInitialized=!0,this}.bind(this))}.bind(this))},save:function(a,b){return d.isInstance(a)||(b=a,a=null),this._send(a||this.toJSON(),b).then(function(){return this}.bind(this))},update:function(a,b){return this._send(a,b).then(function(a){return this.fromJSON(a.response.entity),this}.bind(this))},_send:function(a,b){if(!this.isInitialized)throw new Error("Metamodel is not initialized.");return this.withLock(function(){var c;return c=d.isInstance(a)?new k.UpdateSchema(a.name,a.toJSON()):new k.UpdateAllSchemas(a),c.withAuthorizationToken(b),this._connector.send(c)}.bind(this))},toJSON:function(){var a=[];for(var b in this.entities)a.push(this.entities[b]);for(b in this.embeddables)a.push(this.embeddables[b]);return a},fromJSON:function(a){var b=new g,c=b.buildModels(a);this.baseTypes={},this.embeddables={},this.entities={};for(var d in c){var e=c[d];this.addType(e)}},createIndex:function(a,b,c){b.drop=!1;var d=new k.CreateDropIndex(a,b.toJSON());return d.withAuthorizationToken(c),this._connector.send(d)},dropIndex:function(a,b,c){b.drop=!0;var d=new k.CreateDropIndex(a,b.toJSON());return d.withAuthorizationToken(c),this._connector.send(d)},dropAllIndexes:function(a,b){var c=new k.DropAllIndexes(a);return c.withAuthorizationToken(b),this._connector.send(c)},getIndexes:function(a,b){var c=new k.ListIndexes(a);return c.withAuthorizationToken(b),this._connector.send(c).then(function(a){return a.response.entity.map(function(a){return new h(a.keys,a.unique)})},function(a){if(a.status==j.BUCKET_NOT_FOUND||a.status==j.OBJECT_NOT_FOUND)return null;throw a})}});b.exports=l},{"../binding/Enhancer":8,"../connector/Message":20,"../message":32,"../util/Lockable":52,"./BasicType":34,"./DbIndex":36,"./EntityType":38,"./ManagedType":40,"./ModelBuilder":43}],43:[function(a,b,c){var d=a("./BasicType"),e=a("./EntityType"),f=a("./EmbeddableType"),g=a("./ListAttribute"),h=a("./MapAttribute"),i=a("./SetAttribute"),j=a("./SingularAttribute"),k=a("../error/PersistentError"),l=Object.inherit({models:null,modelDescriptors:null,constructor:function(){this.models={};for(var a in d)if(d.hasOwnProperty(a)){var b=d[a];b instanceof d&&(this.models[b.ref]=b)}},getModel:function(a){return a in this.models?this.models[a]:this.models[a]=this.buildModel(a)},buildModels:function(a){this.modelDescriptors={};for(var b,c=0;b=a[c];++c)this.modelDescriptors[b["class"]]=b;for(var d in this.modelDescriptors)try{var f=this.getModel(d);this.buildAttributes(f)}catch(g){throw new k("Can't create model for entity class "+d,g)}return this.getModel(e.Object.ref),this.models},buildModel:function(a){var b,c=this.modelDescriptors[a];if(a==e.Object.ref)b=new e.Object;else{if(!c)throw new TypeError("No model available for "+a);if(c.embedded)b=new f(a);else{var d=c.superClass||e.Object.ref;b=new e(a,this.getModel(d))}}if(c){var g=c.acl;for(var h in g)b[h+"Permission"].fromJSON(g[h])}return b},buildAttributes:function(a){var b=this.modelDescriptors[a.ref],c=b.fields;for(var d in c){var e=c[d];a.getAttribute(d)||a.addAttribute(this.buildAttribute(e.name,e.type),e.order)}b.validationCode&&(a.validationCode=b.validationCode)},buildAttribute:function(a,b){if(0!=b.indexOf("/db/collection."))return new j(a,this.getModel(b));var c=b.substring(0,b.indexOf("[")),d=b.substring(b.indexOf("[")+1,b.indexOf("]")).trim();switch(c){case g.ref:return new g(a,this.getModel(d));case i.ref:return new i(a,this.getModel(d));case h.ref:var e=d.substring(0,d.indexOf(",")).trim();return d=d.substring(d.indexOf(",")+1).trim(),new h(a,this.getModel(e),this.getModel(d));default:throw new TypeError("No collection available for "+b)}}});b.exports=l},{"../error/PersistentError":28,"./BasicType":34,"./EmbeddableType":37,"./EntityType":38,"./ListAttribute":39,"./MapAttribute":41,"./SetAttribute":45,"./SingularAttribute":46}],44:[function(a,b,c){var d=a("./Attribute"),e=d.inherit({extend:{CollectionType:{COLLECTION:0,LIST:1,MAP:2,SET:3}},typeConstructor:null,persistentAttributeType:d.PersistentAttributeType.ELEMENT_COLLECTION,elementType:null,constructor:function(a,b){d.call(this,a),this.elementType=b},getJsonValue:function(a,b){var c=this.getValue(b);if(this.typeConstructor.isInstance(c)){a._root&&!c._metadata&&Object.defineProperty(c,"_metadata",{value:{_root:a._root}});for(var d,e=[],f=c.values();!(d=f.next()).done;)e.push(this.elementType.toJsonValue(a,d.value));return e}return null},setJsonValue:function(a,b,c){var d=null;if(c){d=this.getValue(b),this.typeConstructor.isInstance(d)||(d=new this.typeConstructor),a._root&&!d._metadata&&Object.defineProperty(d,"_metadata",{value:{_root:a._root}});var e=d.array;d.array=[];for(var f=0,g=c.length;g>f;++f)d.add(this.elementType.fromJsonValue(a,c[f],e[f]))}this.setValue(b,d)}});b.exports=e},{"./Attribute":33}],45:[function(a,b,c){var d,e=a("./PluralAttribute"),f=a("../collection"),d=e.inherit({extend:{ref:"/db/collection.Set"},collectionType:e.CollectionType.SET,constructor:function(a,b){e.call(this,a,b),this.typeConstructor=f.Set},toJSON:function(){return{name:this.name,type:d.ref+"["+this.elementType.ref+"]",order:this.order}}});b.exports=d},{"../collection":17,"./PluralAttribute":44}],46:[function(a,b,c){var d=a("./Attribute"),e=a("./Type"),f=d.inherit({get typeConstructor(){return this.type.typeConstructor},type:null,constructor:function(a,b,c){switch(d.call(this,a,c),this.type=b,b.persistenceType){case e.PersistenceType.BASIC:this.persistentAttributeType=d.PersistentAttributeType.BASIC;break;case e.PersistenceType.EMBEDDABLE:this.persistentAttributeType=d.PersistentAttributeType.EMBEDDED;break;case e.PersistenceType.ENTITY:this.persistentAttributeType=d.PersistentAttributeType.ONE_TO_MANY}},getJsonValue:function(a,b){return this.type.toJsonValue(a,this.getValue(b))},setJsonValue:function(a,b,c){this.setValue(b,this.type.fromJsonValue(a,c,this.getValue(b)))},toJSON:function(){return{name:this.name,type:this.type.ref,order:this.order}}});b.exports=f},{"./Attribute":33,"./Type":47}],47:[function(a,b,c){var d=Object.inherit({extend:{PersistenceType:{BASIC:0,EMBEDDABLE:1,ENTITY:2,MAPPED_SUPERCLASS:3}},get isBasic(){return this.persistenceType==d.PersistenceType.BASIC},get isEmbeddable(){return this.persistenceType==d.PersistenceType.EMBEDDABLE},get isEntity(){return this.persistenceType==d.PersistenceType.ENTITY},get isMappedSuperclass(){return this.persistenceType==d.PersistenceType.MAPPED_SUPERCLASS},persistenceType:-1,get typeConstructor(){return this._typeConstructor},set typeConstructor(a){if(this._typeConstructor)throw new Error("typeConstructor has already been set.");this._typeConstructor=a},ref:null,name:null,constructor:function(a,b){if(0!=a.indexOf("/db/"))throw new SyntaxError("Type ref "+a+" is invalid.");this.ref=a,this.name=a.substring(4),this._typeConstructor=b},fromJsonValue:function(a,b,c){},toJsonValue:function(a,b){}});b.exports=d},{}],48:[function(a,b,c){var d=a("./Metamodel");d.prototype.Attribute=a("./Attribute"),d.prototype.BasicType=a("./BasicType"),d.prototype.CollectionAttribute=a("./CollectionAttribute"),d.prototype.EmbeddableType=a("./EmbeddableType"),d.prototype.EntityType=a("./EntityType"),d.prototype.ListAttribute=a("./ListAttribute"),d.prototype.ManagedType=a("./ManagedType"),d.prototype.MapAttribute=a("./MapAttribute"),d.prototype.Metamodel=a("./Metamodel"),d.prototype.ModelBuilder=a("./ModelBuilder"),d.prototype.PluralAttribute=a("./PluralAttribute"),d.prototype.SetAttribute=a("./SetAttribute"),d.prototype.SingularAttribute=a("./SingularAttribute"),d.prototype.Type=a("./Type"),d.prototype.DbIndex=a("./DbIndex"),c=b.exports=new d},{"./Attribute":33,"./BasicType":34,"./CollectionAttribute":35,"./DbIndex":36,"./EmbeddableType":37,"./EntityType":38,"./ListAttribute":39,"./ManagedType":40,"./MapAttribute":41,"./Metamodel":42,"./ModelBuilder":43,"./PluralAttribute":44,"./SetAttribute":45,"./SingularAttribute":46,"./Type":47}],49:[function(a,b,c){Function.prototype.bind=Function.prototype.bind||function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}},{}],50:[function(a,b,c){var d=a("./Permission"),e=Object.inherit({read:null,write:null,constructor:function(a){this.read=new d(a),this.write=new d(a)},clear:function(){this.read.clear(),this.write.clear()},isPublicReadAllowed:function(){return this.read.isPublicAllowed()},setPublicReadAllowed:function(){return this.read.setPublicAllowed()},isReadAllowed:function(a){return this.read.isAllowed(a)},isReadDenied:function(a){return this.read.isDenied(a)},allowReadAccess:function(a){return this.read.allowAccess(a),this},denyReadAccess:function(a){return this.read.denyAccess(a),this},deleteReadAccess:function(a){return this.read.deleteAccess(a),this},isPublicWriteAllowed:function(){return this.write.isPublicAllowed()},setPublicWriteAllowed:function(){return this.write.setPublicAllowed()},isWriteAllowed:function(a){return this.write.isAllowed(a)},isWriteDenied:function(a){return this.write.isDenied(a)},allowWriteAccess:function(a){return this.write.allowAccess(a),this},denyWriteAccess:function(a){return this.write.denyAccess(a),this},deleteWriteAccess:function(a){return this.write.deleteAccess(a),this},toJSON:function(){return{read:this.read,write:this.write}},fromJSON:function(a){this.read.fromJSON(a.read||{}),this.write.fromJSON(a.write||{})}});b.exports=e},{"./Permission":56}],51:[function(a,b,c){var d=a("../message"),e=a("../connector/Message").StatusCode,f=Object.inherit({_connector:null,_metamodel:null,constructor:function(a){this._metamodel=a},connected:function(a){this._connector=a},functionToString:function(a){if(!a)return"";var b=a.toString();return b=b.substring(b.indexOf("{")+1,b.lastIndexOf("}")),"\n"==b.charAt(0)&&(b=b.substring(1)),"\n"==b.charAt(b.length-1)&&(b=b.substring(0,b.length-1)),b},stringToFunction:function(a,b){return new Function(a,b)},loadModules:function(a){var b=new d.GetAllModules;return b.withAuthorizationToken(a),this._connector.send(b).then(function(a){return a.response.entity})},loadCode:function(a,b,c,f){var g=String.isInstance(a)?a:a.name,h=new d.GetBaqendCode(g,b);return h.withAuthorizationToken(c),this._connector.send(h).then(function(a){return this._parseCode(g,b,f,a.response.entity)}.bind(this),function(a){if(a.status==e.OBJECT_NOT_FOUND)return null;throw a})},saveCode:function(a,b,c,e){var f=String.isInstance(a)?a:a.name,g=Function.isInstance(c),h=new d.SetBaqendCode(f,b,g?this.functionToString(c):c);return h.withAuthorizationToken(e),this._connector.send(h).then(function(a){return this._parseCode(f,b,g,a.response.entity)}.bind(this))},deleteCode:function(a,b,c){var e=String.isInstance(a)?a:a.name,f=new d.DeleteBaqendCode(e,b);return f.withAuthorizationToken(c),this._connector.send(f).then(function(){return this._parseCode(e,b,!1,null)}.bind(this))},_parseCode:function(a,b,c,d){if("validate"==b){var e=this._metamodel.entity(a);return e.validationCode=d,c?e.validationCode:d}return c?this.stringToFunction(["module","exports"],d):d}});b.exports=f},{"../connector/Message":20,"../message":32}],52:[function(a,b,c){var d=Trait.inherit({_isLocked:!1,_readyPromise:Promise.resolve(null),_deferred:null,get isReady(){return!this._isLocked},ready:function(a,b){var c=this;return this._readyPromise.then(function(){return c},function(a){if(c._isLocked)throw a;return c}).then(a,b)},withLock:function(a,b){if(this._isLocked)throw new Error("Current operation has not been finished.");try{return this._isLocked=!0,this._readyPromise=a().then(function(a){return this._isLocked=!1,a}.bind(this),function(a){throw b||(this._isLocked=!1),a}.bind(this))}catch(c){throw b||(this._isLocked=!1),c}}});b.exports=d},{}],53:[function(a,b,c){var d=a("../message"),e=(a("../connector/Message").StatusCode,Object.inherit({extend:{LEVELS:["trace","debug","info","warn","error"],FORMAT_REGEXP:/%[sdj%]/g,create:function(a){function b(){c.log.apply(b,arguments)}var c=this.prototype;return Object.cloneOwnProperties(b,c),b._init(a),b}},entityManager:null,levelIndex:2,get level(){return e.LEVELS[this.levelIndex]},set level(a){var b=e.LEVELS.indexOf(a);if(-1==b)throw new Error("Unknown logging level "+a);this.levelIndex=b},log:function(a,b,c){var d=Array.prototype.slice.call(arguments);return a=-1==e.LEVELS.indexOf(d[0])?"info":d.shift(),this.levelIndex>e.LEVELS.indexOf(a)?void 0:(b=this._format(d.shift(),d),c=null,d.length&&"object"==typeof d[d.length-1]&&(c=d.pop()),d.length&&(b+=", "+d.join(", ")),this._log({date:new Date,message:b,level:a,user:this.entityManager.me&&this.entityManager.me.id,data:c}))},_format:function(a,b){if(0==b.length)return a;var c=String(a).replace(e.FORMAT_REGEXP,function(a){if("%%"===a)return"%";if(!b.length)return a;switch(a){case"%s":return String(b.shift());case"%d":return Number(b.shift());case"%j":try{return JSON.stringify(b.shift())}catch(c){return"[Circular]"}default:return a}});return c},_init:function(a){this.entityManager=a,e.LEVELS.forEach(function(a){this[a]=this.log.bind(this,a)}.bind(this))},_log:function(a){return this.entityManager.isReady?this.entityManager._send(new d.CreateObject("logs.AppLog",a)):this.entityManager.ready(this._log.bind(this,a))}}));b.exports=e},{"../connector/Message":20,"../message":32}],54:[function(a,b,c){var d=a("../error/PersistentError"),e=a("./Acl"),f=a("./Lockable"),g=Object.inherit(f,{extend:{Type:{UNAVAILABLE:-1,PERSISTENT:0,DIRTY:1},get:function(a){return a._metadata},getRoot:function(a){var b=a&&a._metadata;return b&&b._root!=a&&(b=b._root&&b._root._metadata),b},readAccess:function(a){var b=g.getRoot(a);b&&b.readAccess()},writeAccess:function(a){var b=g.getRoot(a);b&&b.writeAccess()}},get db(){return this._db?this._db:this._db=a("../")},set db(a){if(this._db)throw new Error("DB has already been set.");this._db=a},get bucket(){return this.type&&this.type.name},get key(){if(!this._key&&this.id){var a=this.id.lastIndexOf("/");this._key=decodeURIComponent(this.id.substring(a+1))}return this._key},set key(a){if(this.id)throw new Error("The id can't be set twice.");this.id="/db/"+this.bucket+"/"+encodeURIComponent(a),this._key=a},get isAttached(){return!!this._db},get isAvailable(){return this._state>g.Type.UNAVAILABLE},get isPersistent(){return this._state==g.Type.PERSISTENT},get isDirty(){return this._state==g.Type.DIRTY},_root:null,_db:null,id:null,version:null,acl:null,type:null,constructor:function h(a,b){this._root=a,this.type=b,this._state=h.Type.DIRTY,this._enabled=!0,this.acl=new e(this)},readAccess:function(){if(this._enabled&&!this.isAvailable)throw new d("This object "+this.bucket+"/"+this.id+" is not available.")},writeAccess:function(){if(this._enabled){if(!this.isAvailable)throw new d("This object "+this.bucket+"/"+this.id+" is not available.");this.setDirty()}},setUnavailable:function(){this._state=g.Type.UNAVAILABLE},setPersistent:function(){this._state=g.Type.PERSISTENT},setDirty:function(){this._state=g.Type.DIRTY},setRemoved:function(){this.setDirty(),this.version=null},getJsonMetadata:function(a){var b={};return this.id&&(b.id=this.id),!a&&this.version&&(b.version=this.version),b.acl=this.acl,b},setJsonMetadata:function(a){this.id||(this.id=a.id),a.version&&(this.version=a.version),this.acl.fromJSON(a.acl||{})},getJson:function(a,b){this._enabled=!1;var c=this.type.toJsonValue(this,this._root,!0);return this._enabled=!0,this.isAttached&&!b&&Object.extend(c,this.getJsonMetadata(a)),c},setJson:function(a){(a.id||a.version||a.acl)&&this.setJsonMetadata(a),this._enabled=!1,this.type.fromJsonValue(this,a,this._root,!0),this._enabled=!0}});b.exports=g},{"../":31,"../error/PersistentError":28,"./Acl":50,"./Lockable":52}],55:[function(a,b,c){var d=a("../message"),e=Object.inherit({_entityManager:null,_connector:null,constructor:function(a,b){this._entityManager=a,this._connector=b},get:function(a,b,c,e){Function.isInstance(b)&&(e=c,c=b,b=null);var f=new d.GetBaqendModule(a);return f.addQueryString(b),this._send(f,c,e)},post:function(a,b,c,e){var f=new d.PostBaqendModule(a,b);return this._send(f,c,e)},_send:function(a,b,c){return this._entityManager._send(a).then(function(a){return a.response.entity}).then(b,c)}});b.exports=e},{"../message":32}],56:[function(a,b,c){var d=Object.inherit({_metadata:null,_rules:null,constructor:function(a){this._rules={},this._metadata=a},allRules:function(){return Object.keys(this._rules)},clear:function(){this._metadata&&this._metadata.writeAccess(),this._rules={}},isPublicAllowed:function(){if("*"in this._rules)return!1;for(var a in this._rules)if("allow"==this._rules[a])return!1;return!0},setPublicAllowed:function(){this._metadata&&this._metadata.writeAccess();for(var a in this._rules)"allow"==this._rules[a]&&delete this._rules[a]},getRule:function(a){return this._rules[this._getRef(a)]},isAllowed:function(a){return"allow"==this._rules[this._getRef(a)]},isDenied:function(a){return"deny"==this._rules[this._getRef(a)]},allowAccess:function(a){return this._metadata&&this._metadata.writeAccess(),this._rules[this._getRef(a)]="allow",this},denyAccess:function(a){return this._metadata&&this._metadata.writeAccess(),this._rules[this._getRef(a)]="deny",this},deleteAccess:function(a){return this._metadata&&this._metadata.writeAccess(),delete this._rules[this._getRef(a)],this},toJSON:function(){return this._rules},fromJSON:function(a){this._rules=a},_getRef:function(a){if(String.isInstance(a)||(a=a._metadata.id),0==a.indexOf("/db/User/")||0==a.indexOf("/db/Role/"))return a;throw new TypeError("The given object isn't a user, role or a valid reference.")}});b.exports=d},{}],57:[function(a,b,c){var d=a("../collection").Set,e=a("../collection").List,f=(a("./Metadata"),a("../binding/Entity")),g=Object.inherit({devices:null,message:null,subject:null,sound:null,badge:0,data:null,constructor:function(a,b,c,g,h,i){if(Array.isInstance(a)||e.isInstance(a)||!a)this.devices=new d(a);else if(f.isInstance(a))this.devices=new d,this.devices.add(a);else if(!d.isInstance(a))throw new Error("Only Sets, Lists and Arrays can be used as devices.");this.message=b,this.subject=c,this.sound=g,this.badge=h,this.data=i},addDevice:function(a){this.devices?Array.isInstance(this.devices)&&(this.devices=new d(this.devices)):this.devices=new d,this.devices.add(a)},toJSON:function(){if((Array.isInstance(this.devices)||e.isInstance(this.devices))&&(this.devices=new d(this.devices)),!this.devices||!this.devices.size)throw new Error("Set of devices is empty.");return Object.extend(Object.extend({},this),{devices:this.devices.map(function(a){return a.id})})}});b.exports=g},{"../binding/Entity":9,"../collection":17,"./Metadata":54}],58:[function(a,b,c){var d=Object.inherit({fields:null,get isValid(){for(var a in this.fields)if(!this.fields[a].isValid)return!1;return!0},constructor:function(){this.fields={}},toJSON:function(){var a={};for(var b in this.fields)a[b]=this.fields[b].toJSON();return a}});b.exports=d},{}],59:[function(a,b,c){var d=a("validator"),e=(a("./ValidationResult"),Object.inherit({extend:{initialize:function(){Object.keys(d).forEach(function(a){"function"==typeof d[a]&&"toString"!==a&&"toDate"!==a&&"extend"!==a&&"init"!==a&&(this.prototype[a]=function(b){return this._callMethod(a,b||a,Array.prototype.slice.call(arguments,b?1:0))})}.bind(this))},compile:function(a,b){for(var c,d=[],e=a.attributes();!(c=e.next()).done;)d.push(c.value.name);var f=new Function(d,b);return function(a){var b=d.map(function(b){return a[b]});return f.apply({},b)}}},key:null,errors:null,_entity:null,get value(){return this._entity[this.key]},get isValid(){return 0==this.errors.length},is:function(a,b){return Function.isInstance(a)&&(b=a,a="is"),b(this.value,d)===!1&&this.errors.push(a),this},constructor:function(a,b){this.key=a,this._entity=b,this.errors=[]},_callMethod:function(a,b,c){return c=c||[],c.unshift(this.value),d[a].apply(this,c)===!1&&this.errors.push(b),this},toString:function(){return this.value},toJSON:function(){return{isValid:this.isValid,errors:this.errors}}}));b.exports=e},{"./ValidationResult":58,validator:65}],60:[function(a,b,c){c.Metadata=a("./Metadata"),c.Permission=a("./Permission"),c.Acl=a("./Acl"),c.Validator=a("./Validator"),c.ValidationResult=a("./ValidationResult"),c.Code=a("./Code"),c.Modules=a("./Modules"),c.Lockable=a("./Lockable"),c.Logger=a("./Logger"),c.uuid=a("node-uuid").v4,c.PushMessage=a("./PushMessage")},{"./Acl":50,"./Code":51,"./Lockable":52,"./Logger":53,"./Metadata":54,"./Modules":55,"./Permission":56,"./PushMessage":57,"./ValidationResult":58,"./Validator":59,"node-uuid":63}],61:[function(a,b,c){!function(a){var b=Object.getPrototypeOf({constructor:String})==String.prototype;Function.prototype.extend||(Function.prototype.extend=function(a,b){b||(b=a,a=this);for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}),Object.extend(Function.prototype,{linearizedTypes:[Object],inherit:function(){for(var a=arguments[arguments.length-1],b=a.constructor!==Object?a.constructor:function(a){return this instanceof b?void(this.initialize&&(arguments.length?this.initialize.apply(this,arguments):this.initialize())):b.asInstance(a)},c=Object.createPrototypeChain(b,this,Array.prototype.slice.call(arguments,0,arguments.length-1)),d=Object.getOwnPropertyNames(a),e=0;e<d.length;++e){
var f=d[e],g=!1;if(Object.properties.hasOwnProperty(f)&&(g=Object.properties[f](c,a,f)),!g){var h=Object.getOwnPropertyDescriptor(a,f);if(h.value){var i=h.value;i instanceof Function?/this\.superCall/.test(i.toString())&&(h.value=Object.createSuperCallWrapper(b,f,i)):i&&(i.hasOwnProperty("get")||i.hasOwnProperty("value"))&&(h=i)}Object.defineProperty(c,f,h)}}return b.initialize&&b.initialize(),b},isA:function(a){return this.prototype instanceof a||-1!=this.linearizedTypes.lastIndexOf(a)},isInstance:function(a){return null===a||void 0===a?!1:Object(a)instanceof this||-1!=d(a).linearizedTypes.lastIndexOf(this)},asInstance:function(a){return this.isInstance(a)?a:this.conv(a)},conv:function(){return null}}),Object.extend({properties:{},cloneOwnProperties:function(a,b){for(var c=Object.getOwnPropertyNames(b),d=0;d<c.length;++d){var e=c[d];if("__proto__"!=e){var f=Object.getOwnPropertyDescriptor(b,e);Object.defineProperty(a,e,f)}}},createPrototypeChain:function(a,c,d){for(var f,g=c.prototype,h=c.linearizedTypes.slice(),i=c.prototypeChain?c.prototypeChain.slice():[g],j=0;f=d[j];++j){if(!(f.prototype instanceof e))throw new TypeError("Only traits can be mixed in.");for(var k,l=f.linearizedTypes,m=0;k=l[m];++m)-1==h.indexOf(k)&&k!=e&&(g=Object.create(g),Object.cloneOwnProperties(g,k.wrappedPrototype?k.wrappedPrototype:k.prototype),g.constructor=k,h.push(k),i.push(g))}return g=Object.create(g),g.constructor=a,h.push(a),i.push(g),b?(a.wrappedPrototype=g,a.prototype=Object.create(g)):a.prototype=g,a.linearizedTypes=h,a.prototypeChain=i,g},createSuperCallWrapper:function(a,b,c){var e=function(){var c=d(this),e=c.linearizedTypes.lastIndexOf(a);if(-1==e)throw new ReferenceError("superCall can't determine any super method");var f=c.prototypeChain[e-1];return"initialize"!=b||f[b]?arguments.length?f[b].apply(this,arguments):f[b].call(this):void 0};return function(){var a=this.superCall;this.superCall=e;try{return arguments.length?c.apply(this,arguments):c.call(this)}finally{a?this.superCall=a:delete this.superCall}}}}),Object.extend(Object.properties,{initialize:function(a,b){var c=b.initialize,f=/this\.superCall/.test(c.toString());if(a instanceof e){if(f)throw new TypeError("Trait constructors can not call super constructors directly.");b.initialize=function(){arguments.length?this.superCall.apply(this,arguments):this.superCall.call(this),c.call(this)}}else f||d(a)==Object||(b.initialize=function(){this.superCall.call(this),arguments.length?c.apply(this,arguments):c.call(this)})},extend:function(a,b){return Object.extend(a.constructor,b.extend),!0}});for(var c,d=function(a){return null===a||void 0===a?a:Object.getPrototypeOf(Object(a)).constructor},e=Object.inherit({}),f=(e.inherit({extend:{initialize:function(){try{Object.defineProperty(this.prototype,"bind",{get:function(){return this.bind=f.create(this)},set:function(a){Object.defineProperty(this,"bind",{value:a})},configurable:!0}),this.Object=Object.inherit({initialize:function(a){this.self=a}})}catch(a){this.Object=Object.inherit({initialize:function(a){this.self=a;var b=this;f.each(a,function(a,c){b[a]=c.bind(b.self)})}})}},create:function(a){if(!a.constructor.Bind)try{var b={};f.each(a,function(a,c){b[a]={get:function(){return this[a]=c.bind(this.self)},set:function(b){Object.defineProperty(this,a,{value:b})},configurable:!0}}),a.constructor.Bind=f.Object.inherit(b)}catch(c){a.constructor.Bind=f.Object.inherit({})}return new a.constructor.Bind(a)},each:function(a,b){var c=Object.getPrototypeOf(a);for(var d in c){var e=c[d];"initialize"!=d&&"constructor"!=d&&e instanceof Function&&b(d,e)}}},initialize:function(){"bind"in this||(this.bind=f.create(this))}})),g=[Boolean,Number,String,Function,RegExp,Error],h=0;c=g[h];++h)c.conv=c;Date.conv=function(a){return new Date(a)},Array.conv=function(a){return Array.prototype.slice.call(a)},Array.prototype.initialize=function(){for(var a=0;a<arguments.length;++a)this[a]=arguments[a];this.length=arguments.length},Error.prototype.initialize=function(a){var b=(new Error).stack||"Error";b=b.substring(b.indexOf("\n")+1),this.stack=a+"\n"+b,this.message=a},TypeError instanceof Error&&(Error.prototype.isInstance=Error.isInstance,Error.prototype.asInstance=Error.asInstance,Error.prototype.conv=Error.conv),Object.extend(a,{classOf:d,Trait:e,Bind:f})}("undefined"!=typeof window?window:global)},{}],62:[function(a,b,c){!function d(b,c,e){function f(h,i){if(!c[h]){if(!b[h]){var j="function"==typeof a&&a;if(!i&&j)return j(h,!0);if(g)return g(h,!0);var k=new Error("Cannot find module '"+h+"'");throw k.code="MODULE_NOT_FOUND",k}var l=c[h]={exports:{}};b[h][0].call(l.exports,function(a){var c=b[h][1][a];return f(c?c:a)},l,l.exports,d,b,c,e)}return c[h].exports}for(var g="function"==typeof a&&a,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(a,b,c){"use strict";function d(){}function e(a){if("function"!=typeof a)throw new TypeError("resolver must be a function");this.state=s,this.queue=[],this.outcome=void 0,a!==d&&i(this,a)}function f(a,b,c){this.promise=a,"function"==typeof b&&(this.onFulfilled=b,this.callFulfilled=this.otherCallFulfilled),"function"==typeof c&&(this.onRejected=c,this.callRejected=this.otherCallRejected)}function g(a,b,c){o(function(){var d;try{d=b(c)}catch(e){return p.reject(a,e)}d===a?p.reject(a,new TypeError("Cannot resolve promise with itself")):p.resolve(a,d)})}function h(a){var b=a&&a.then;return a&&"object"==typeof a&&"function"==typeof b?function(){b.apply(a,arguments)}:void 0}function i(a,b){function c(b){f||(f=!0,p.reject(a,b))}function d(b){f||(f=!0,p.resolve(a,b))}function e(){b(d,c)}var f=!1,g=j(e);"error"===g.status&&c(g.value)}function j(a,b){var c={};try{c.value=a(b),c.status="success"}catch(d){c.status="error",c.value=d}return c}function k(a){return a instanceof this?a:p.resolve(new this(d),a)}function l(a){var b=new this(d);return p.reject(b,a)}function m(a){function b(a,b){function d(a){g[b]=a,++h!==e||f||(f=!0,p.resolve(j,g))}c.resolve(a).then(d,function(a){f||(f=!0,p.reject(j,a))})}var c=this;if("[object Array]"!==Object.prototype.toString.call(a))return this.reject(new TypeError("must be an array"));var e=a.length,f=!1;if(!e)return this.resolve([]);for(var g=new Array(e),h=0,i=-1,j=new this(d);++i<e;)b(a[i],i);return j}function n(a){function b(a){c.resolve(a).then(function(a){f||(f=!0,p.resolve(h,a))},function(a){f||(f=!0,p.reject(h,a))})}var c=this;if("[object Array]"!==Object.prototype.toString.call(a))return this.reject(new TypeError("must be an array"));var e=a.length,f=!1;if(!e)return this.resolve([]);for(var g=-1,h=new this(d);++g<e;)b(a[g]);return h}var o=a("immediate"),p={},q=["REJECTED"],r=["FULFILLED"],s=["PENDING"];b.exports=c=e,e.prototype["catch"]=function(a){return this.then(null,a)},e.prototype.then=function(a,b){if("function"!=typeof a&&this.state===r||"function"!=typeof b&&this.state===q)return this;var c=new this.constructor(d);if(this.state!==s){var e=this.state===r?a:b;g(c,e,this.outcome)}else this.queue.push(new f(c,a,b));return c},f.prototype.callFulfilled=function(a){p.resolve(this.promise,a)},f.prototype.otherCallFulfilled=function(a){g(this.promise,this.onFulfilled,a)},f.prototype.callRejected=function(a){p.reject(this.promise,a)},f.prototype.otherCallRejected=function(a){g(this.promise,this.onRejected,a)},p.resolve=function(a,b){var c=j(h,b);if("error"===c.status)return p.reject(a,c.value);var d=c.value;if(d)i(a,d);else{a.state=r,a.outcome=b;for(var e=-1,f=a.queue.length;++e<f;)a.queue[e].callFulfilled(b)}return a},p.reject=function(a,b){a.state=q,a.outcome=b;for(var c=-1,d=a.queue.length;++c<d;)a.queue[c].callRejected(b);return a},c.resolve=k,c.reject=l,c.all=m,c.race=n},{immediate:2}],2:[function(a,b,c){(function(a){"use strict";function c(){k=!0;for(var a,b,c=l.length;c;){for(b=l,l=[],a=-1;++a<c;)b[a]();c=l.length}k=!1}function d(a){1!==l.push(a)||k||e()}var e,f=a.MutationObserver||a.WebKitMutationObserver;if(f){var g=0,h=new f(c),i=a.document.createTextNode("");h.observe(i,{characterData:!0}),e=function(){i.data=g=++g%2}}else if(a.setImmediate||"undefined"==typeof a.MessageChannel)e="document"in a&&"onreadystatechange"in a.document.createElement("script")?function(){var b=a.document.createElement("script");b.onreadystatechange=function(){c(),b.onreadystatechange=null,b.parentNode.removeChild(b),b=null},a.document.documentElement.appendChild(b)}:function(){setTimeout(c,0)};else{var j=new a.MessageChannel;j.port1.onmessage=c,e=function(){j.port2.postMessage(0)}}var k,l=[];b.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(a,b,c){(function(b){"use strict";"function"!=typeof b.Promise&&(b.Promise=a("./lib"))}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./lib":1}]},{},[3])},{}],63:[function(b,c,d){!function(d){"use strict";function e(){var a=d.crypto||d.msCrypto;if(!k&&a&&a.getRandomValues)try{var b=new Uint8Array(16);n=k=function(){return a.getRandomValues(b),b},k()}catch(c){}if(!k){var e=new Array(16);l=k=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),e[b]=a>>>((3&b)<<3)&255;return e},"undefined"!=typeof console&&console.warn&&console.warn("[SECURITY] node-uuid: crypto not usable, falling back to insecure Math.random()")}}function f(){if("function"==typeof b)try{var a=b("crypto").randomBytes;m=k=a&&function(){return a(16)},k()}catch(c){}}function g(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>e&&(b[d+e++]=r[a])});16>e;)b[d+e++]=0;return b}function h(a,b){var c=b||0,d=q;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function i(a,b,c){var d=b&&c||0,e=b||[];a=a||{};var f=null!=a.clockseq?a.clockseq:v,g=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:x+1,j=g-w+(i-x)/1e4;if(0>j&&null==a.clockseq&&(f=f+1&16383),(0>j||g>w)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");w=g,x=i,v=f,g+=122192928e5;var k=(1e4*(268435455&g)+i)%4294967296;e[d++]=k>>>24&255,e[d++]=k>>>16&255,e[d++]=k>>>8&255,e[d++]=255&k;var l=g/4294967296*1e4&268435455;e[d++]=l>>>8&255,e[d++]=255&l,e[d++]=l>>>24&15|16,e[d++]=l>>>16&255,e[d++]=f>>>8|128,e[d++]=255&f;for(var m=a.node||u,n=0;6>n;n++)e[d+n]=m[n];return b?b:h(e)}function j(a,b,c){var d=b&&c||0;"string"==typeof a&&(b="binary"===a?new p(16):null,a=null),a=a||{};var e=a.random||(a.rng||k)();if(e[6]=15&e[6]|64,e[8]=63&e[8]|128,b)for(var f=0;16>f;f++)b[d+f]=e[f];return b||h(e)}var k,l,m,n,o;d?e():f();for(var p="function"==typeof Buffer?Buffer:Array,q=[],r={},s=0;256>s;s++)q[s]=(s+256).toString(16).substr(1),r[q[s]]=s;var t=k(),u=[1|t[0],t[1],t[2],t[3],t[4],t[5]],v=16383&(t[6]<<8|t[7]),w=0,x=0,y=j;y.v1=i,y.v4=j,y.parse=g,y.unparse=h,y.BufferClass=p,y._rng=k,y._mathRNG=l,y._nodeRNG=m,y._whatwgRNG=n,"undefined"!=typeof c&&c.exports?c.exports=y:"function"==typeof a&&a.amd?a(function(){return y}):(o=d.uuid,y.noConflict=function(){return d.uuid=o,y},d.uuid=y)}("undefined"!=typeof window?window:null)},{crypto:void 0}],64:[function(a,b,c){"use strict";function d(a){function b(a){}if(!a)throw new TypeError("argument namespace is required");return b._file=void 0,b._ignored=!0,b._namespace=a,b._traced=!1,b._warned=Object.create(null),b["function"]=e,b.property=f,b}function e(a,b){if("function"!=typeof a)throw new TypeError("argument fn must be a function");return a}function f(a,b,c){if(!a||"object"!=typeof a&&"function"!=typeof a)throw new TypeError("argument obj must be object");var d=Object.getOwnPropertyDescriptor(a,b);if(!d)throw new TypeError("must call property on owner object");if(!d.configurable)throw new TypeError("property must be configurable")}b.exports=d},{}],65:[function(b,c,d){!function(b,e){"undefined"!=typeof d&&"undefined"!=typeof c?c.exports=e():"function"==typeof a&&"object"==typeof a.amd?a(e):"function"==typeof a&&"object"==typeof a.petal?a(b,[],e):this[b]=e()}("validator",function(a){"use strict";function d(a){var b,c,d,e,f=a.match(L);if(f){if(b=f[21],!b)return f[12]?null:0;if("z"===b||"Z"===b)return 0;c=f[22],-1!==b.indexOf(":")?(d=parseInt(f[23]),e=parseInt(f[24])):(d=0,e=parseInt(f[23]))}else{if(a=a.toLowerCase(),b=a.match(/(?:\s|gmt\s*)(-|\+)(\d{1,4})(\s|$)/),!b)return-1!==a.indexOf("gmt")?0:null;c=b[1];var g=b[2];3===g.length&&(g="0"+g),g.length<=2?(d=0,e=parseInt(g)):(d=parseInt(g.slice(0,2)),e=parseInt(g.slice(2,4)))}return(60*d+e)*("-"===c?1:-1)}function e(a,b){a=a||{};for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a}function f(a){var b="(\\"+a.symbol.replace(/\./g,"\\.")+")"+(a.require_symbol?"":"?"),c="-?",d="[1-9]\\d*",e="[1-9]\\d{0,2}(\\"+a.thousands_separator+"\\d{3})*",f=["0",d,e],g="("+f.join("|")+")?",h="(\\"+a.decimal_separator+"\\d{2})?",i=g+h;return a.allow_negatives&&!a.parens_for_negatives&&(a.negative_sign_after_digits?i+=c:a.negative_sign_before_digits&&(i=c+i)),a.allow_negative_sign_placeholder?i="( (?!\\-))?"+i:a.allow_space_after_symbol?i=" ?"+i:a.allow_space_after_digits&&(i+="( (?!$))?"),a.symbol_after_digits?i+=b:i=b+i,a.allow_negatives&&(a.parens_for_negatives?i="(\\("+i+"\\)|"+i+")":a.negative_sign_before_digits||a.negative_sign_after_digits||(i=c+i)),new RegExp("^(?!-? )(?=.*\\d)"+i+"$")}a={version:"4.8.0",coerce:!0};for(var g,h=/^[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~]+$/i,i=/^([\s\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e]|(\\[\x01-\x09\x0b\x0c\x0d-\x7f]))*$/i,j=/^[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+$/i,k=/^([\s\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|(\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*$/i,l=/^[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~\.\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~\.\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF\s]*<(.+)>$/i,m=/^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})$/,n=/^[A-Z]{2}[0-9A-Z]{9}[0-9]$/,o=/^(?:[0-9]{9}X|[0-9]{10})$/,p=/^(?:[0-9]{13})$/,q=/^([0-9a-fA-F][0-9a-fA-F]:){5}([0-9a-fA-F][0-9a-fA-F])$/,r=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/,s=/^[0-9A-F]{1,4}$/i,t={3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,all:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i},u={"en-US":/^[A-Z]+$/i,"de-DE":/^[A-ZÄÖÜß]+$/i,"es-ES":/^[A-ZÁÉÍÑÓÚÜ]+$/i,"fr-FR":/^[A-ZÀÂÆÇÉÈÊËÏÎÔŒÙÛÜŸ]+$/i,"nl-NL":/^[A-ZÉËÏÓÖÜ]+$/i,"pt-PT":/^[A-ZÃÁÀÂÇÉÊÍÕÓÔÚÜ]+$/i},v={"en-US":/^[0-9A-Z]+$/i,"de-DE":/^[0-9A-ZÄÖÜß]+$/i,"es-ES":/^[0-9A-ZÁÉÍÑÓÚÜ]+$/i,"fr-FR":/^[0-9A-ZÀÂÆÇÉÈÊËÏÎÔŒÙÛÜŸ]+$/i,"nl-NL":/^[0-9A-ZÉËÏÓÖÜ]+$/i,"pt-PT":/^[0-9A-ZÃÁÀÂÇÉÊÍÕÓÔÚÜ]+$/i},w=["AU","GB","HK","IN","NZ","ZA","ZM"],x=0;x<w.length;x++)g="en-"+w[x],u[g]=u["en-US"],v[g]=v["en-US"];var y=/^[-+]?[0-9]+$/,z=/^(?:[-+]?(?:0|[1-9][0-9]*))$/,A=/^(?:[-+]?(?:[0-9]+))?(?:\.[0-9]*)?(?:[eE][\+\-]?(?:[0-9]+))?$/,B=/^[0-9A-F]+$/i,C=/^[-+]?([0-9]+|\.[0-9]+|[0-9]+\.[0-9]+)$/,D=/^#?([0-9A-F]{3}|[0-9A-F]{6})$/i,E=/^[\x00-\x7F]+$/,F=/[^\x00-\x7F]/,G=/[^\u0020-\u007E\uFF61-\uFF9F\uFFA0-\uFFDC\uFFE8-\uFFEE0-9a-zA-Z]/,H=/[\u0020-\u007E\uFF61-\uFF9F\uFFA0-\uFFDC\uFFE8-\uFFEE0-9a-zA-Z]/,I=/[\uD800-\uDBFF][\uDC00-\uDFFF]/,J=/^(?:[A-Z0-9+\/]{4})*(?:[A-Z0-9+\/]{2}==|[A-Z0-9+\/]{3}=|[A-Z0-9+\/]{4})$/i,K={"en-US":/^(\+?1)?[2-9]\d{2}[2-9](?!11)\d{6}$/,"de-DE":/^(\+?49[ \.\-])?([\(]{1}[0-9]{1,6}[\)])?([0-9 \.\-\/]{3,20})((x|ext|extension)[ ]?[0-9]{1,4})?$/,"el-GR":/^(\+?30)?(69\d{8})$/,"en-AU":/^(\+?61|0)4\d{8}$/,"en-GB":/^(\+?44|0)7\d{9}$/,"en-HK":/^(\+?852\-?)?[569]\d{3}\-?\d{4}$/,"en-IN":/^(\+?91|0)?[789]\d{9}$/,"en-NZ":/^(\+?64|0)2\d{7,9}$/,"en-ZA":/^(\+?27|0)\d{9}$/,"en-ZM":/^(\+?26)?09[567]\d{7}$/,"es-ES":/^(\+?34)?(6\d{1}|7[1234])\d{7}$/,"fi-FI":/^(\+?358|0)\s?(4(0|1|2|4|5)?|50)\s?(\d\s?){4,8}\d$/,"fr-FR":/^(\+?33|0)[67]\d{8}$/,"nb-NO":/^(\+?47)?[49]\d{7}$/,"nn-NO":/^(\+?47)?[49]\d{7}$/,"pt-BR":/^(\+?55|0)\-?[1-9]{2}\-?[2-9]{1}\d{3,4}\-?\d{4}$/,"pt-PT":/^(\+?351)?9[1236]\d{7}$/,"ru-RU":/^(\+?7|8)?9\d{9}$/,"vi-VN":/^(\+?84|0)?((1(2([0-9])|6([2-9])|88|99))|(9((?!5)[0-9])))([0-9]{7})$/,"zh-CN":/^(\+?0?86\-?)?((13\d|14[57]|15[^4,\D]|17[678]|18\d)\d{8}|170[059]\d{7})$/,"zh-TW":/^(\+?886\-?|0)?9\d{8}$/},L=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;a.extend=function(b,c){a[b]=function(){var b=Array.prototype.slice.call(arguments);return b[0]=a.toString(b[0]),c.apply(a,b)}},a.init=function(){for(var b in a)"function"==typeof a[b]&&"toString"!==b&&"toDate"!==b&&"extend"!==b&&"init"!==b&&"isServerSide"!==b&&a.extend(b,a[b])},a.isServerSide=function(){return"object"==typeof c&&c&&"object"==typeof c.exports&&"object"==typeof process&&"function"==typeof b};var M=null;a.deprecation=function(c){if(null===M){if(!a.isServerSide())return;M=b("depd")("validator")}M(c)},a.toString=function(b){if("string"!=typeof b){if(!a.coerce)throw new Error("this library validates strings only");a.deprecation("you tried to validate a "+typeof b+" but this library (validator.js) validates strings only. Please update your code as this will be an error soon.")}return"object"==typeof b&&null!==b?b="function"==typeof b.toString?b.toString():"[object Object]":(null===b||"undefined"==typeof b||isNaN(b)&&!b.length)&&(b=""),""+b},a.toDate=function(a){return"[object Date]"===Object.prototype.toString.call(a)?a:(a=Date.parse(a),isNaN(a)?null:new Date(a))},a.toFloat=function(a){return parseFloat(a)},a.toInt=function(a,b){return parseInt(a,b||10)},a.toBoolean=function(a,b){return b?"1"===a||"true"===a:"0"!==a&&"false"!==a&&""!==a},a.equals=function(b,c){return b===a.toString(c)},a.contains=function(b,c){return b.indexOf(a.toString(c))>=0},a.matches=function(a,b,c){return"[object RegExp]"!==Object.prototype.toString.call(b)&&(b=new RegExp(b,c)),b.test(a)};var N={allow_display_name:!1,allow_utf8_local_part:!0,require_tld:!0};a.isEmail=function(b,c){if(c=e(c,N),c.allow_display_name){var d=b.match(l);d&&(b=d[1])}var f=b.split("@"),g=f.pop(),m=f.join("@"),n=g.toLowerCase();if(("gmail.com"===n||"googlemail.com"===n)&&(m=m.replace(/\./g,"").toLowerCase()),!a.isByteLength(m,{max:64})||!a.isByteLength(g,{max:256}))return!1;if(!a.isFQDN(g,{require_tld:c.require_tld}))return!1;if('"'===m[0])return m=m.slice(1,m.length-1),c.allow_utf8_local_part?k.test(m):i.test(m);for(var o=c.allow_utf8_local_part?j:h,p=m.split("."),q=0;q<p.length;q++)if(!o.test(p[q]))return!1;return!0};var O={protocols:["http","https","ftp"],require_tld:!0,require_protocol:!1,require_valid_protocol:!0,allow_underscores:!1,allow_trailing_dot:!1,allow_protocol_relative_urls:!1};a.isURL=function(b,c){if(!b||b.length>=2083||/\s/.test(b))return!1;if(0===b.indexOf("mailto:"))return!1;c=e(c,O);var d,f,g,h,i,j,k;if(k=b.split("://"),k.length>1){if(d=k.shift(),c.require_valid_protocol&&-1===c.protocols.indexOf(d))return!1}else{if(c.require_protocol)return!1;c.allow_protocol_relative_urls&&"//"===b.substr(0,2)&&(k[0]=b.substr(2))}return b=k.join("://"),k=b.split("#"),b=k.shift(),k=b.split("?"),b=k.shift(),k=b.split("/"),b=k.shift(),k=b.split("@"),k.length>1&&(f=k.shift(),f.indexOf(":")>=0&&f.split(":").length>2)?!1:(h=k.join("@"),k=h.split(":"),g=k.shift(),k.length&&(j=k.join(":"),i=parseInt(j,10),!/^[0-9]+$/.test(j)||0>=i||i>65535)?!1:a.isIP(g)||a.isFQDN(g,c)||"localhost"===g?c.host_whitelist&&-1===c.host_whitelist.indexOf(g)?!1:c.host_blacklist&&-1!==c.host_blacklist.indexOf(g)?!1:!0:!1)},a.isMACAddress=function(a){return q.test(a)},a.isIP=function(b,c){if(c=c?c+"":"",!c)return a.isIP(b,4)||a.isIP(b,6);if("4"===c){if(!r.test(b))return!1;var d=b.split(".").sort(function(a,b){return a-b});return d[3]<=255}if("6"===c){var e=b.split(":"),f=!1,g=a.isIP(e[e.length-1],4),h=g?7:8;if(e.length>h)return!1;if("::"===b)return!0;"::"===b.substr(0,2)?(e.shift(),e.shift(),f=!0):"::"===b.substr(b.length-2)&&(e.pop(),e.pop(),f=!0);for(var i=0;i<e.length;++i)if(""===e[i]&&i>0&&i<e.length-1){if(f)return!1;f=!0}else if(g&&i==e.length-1);else if(!s.test(e[i]))return!1;return f?e.length>=1:e.length===h}return!1};var P={require_tld:!0,allow_underscores:!1,allow_trailing_dot:!1};a.isFQDN=function(a,b){b=e(b,P),b.allow_trailing_dot&&"."===a[a.length-1]&&(a=a.substring(0,a.length-1));var c=a.split(".");if(b.require_tld){var d=c.pop();if(!c.length||!/^([a-z\u00a1-\uffff]{2,}|xn[a-z0-9-]{2,})$/i.test(d))return!1}for(var f,g=0;g<c.length;g++){if(f=c[g],b.allow_underscores){if(f.indexOf("__")>=0)return!1;f=f.replace(/_/g,"")}if(!/^[a-z\u00a1-\uffff0-9-]+$/i.test(f))return!1;if(/[\uff01-\uff5e]/.test(f))return!1;if("-"===f[0]||"-"===f[f.length-1])return!1;if(f.indexOf("---")>=0&&"xn--"!==f.slice(0,4))return!1}return!0},a.isBoolean=function(a){return["true","false","1","0"].indexOf(a)>=0},a.isAlpha=function(a,b){if(b=b||"en-US",b in u)return u[b].test(a);throw new Error("Invalid locale '"+b+"'")},a.isAlphanumeric=function(a,b){if(b=b||"en-US",b in v)return v[b].test(a);throw new Error("Invalid locale '"+b+"'")},a.isNumeric=function(a){return y.test(a)},a.isDecimal=function(a){return""!==a&&C.test(a)},a.isHexadecimal=function(a){return B.test(a)},a.isHexColor=function(a){return D.test(a)},a.isLowercase=function(a){return a===a.toLowerCase()},a.isUppercase=function(a){return a===a.toUpperCase()},a.isInt=function(a,b){return b=b||{},z.test(a)&&(!b.hasOwnProperty("min")||a>=b.min)&&(!b.hasOwnProperty("max")||a<=b.max)},a.isFloat=function(a,b){return b=b||{},""===a||"."===a?!1:A.test(a)&&(!b.hasOwnProperty("min")||a>=b.min)&&(!b.hasOwnProperty("max")||a<=b.max)},a.isDivisibleBy=function(b,c){return a.toFloat(b)%parseInt(c,10)===0},a.isNull=function(a){return 0===a.length},a.isLength=function(a,b){var c,d;"object"==typeof b?(c=b.min||0,d=b.max):(c=arguments[1],d=arguments[2]);var e=a.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g)||[],f=a.length-e.length;return f>=c&&("undefined"==typeof d||d>=f)},a.isByteLength=function(a,b){var c,d;"object"==typeof b?(c=b.min||0,d=b.max):(c=arguments[1],d=arguments[2]);var e=encodeURI(a).split(/%..|./).length-1;return e>=c&&("undefined"==typeof d||d>=e)},a.isUUID=function(a,b){var c=t[b?b:"all"];return c&&c.test(a)},a.isDate=function(a){var b=new Date(Date.parse(a));if(isNaN(b))return!1;var c=d(a);if(null!==c){var e=b.getTimezoneOffset()-c;b=new Date(b.getTime()+6e4*e)}var f,g,h,i=String(b.getDate());return(g=a.match(/(^|[^:\d])[23]\d([^:\d]|$)/g))?(f=g.map(function(a){return a.match(/\d+/g)[0]}).join("/"),h=String(b.getFullYear()).slice(-2),f===i||f===h?!0:f===i+"/"+h||f===h+"/"+i?!0:!1):!0},a.isAfter=function(b,c){var d=a.toDate(c||new Date),e=a.toDate(b);return!!(e&&d&&e>d)},a.isBefore=function(b,c){var d=a.toDate(c||new Date),e=a.toDate(b);return!!(e&&d&&d>e)},a.isIn=function(b,c){var d;if("[object Array]"===Object.prototype.toString.call(c)){var e=[];for(d in c)e[d]=a.toString(c[d]);return e.indexOf(b)>=0}return"object"==typeof c?c.hasOwnProperty(b):c&&"function"==typeof c.indexOf?c.indexOf(b)>=0:!1},a.isWhitelisted=function(a,b){for(var c=a.length-1;c>=0;c--)if(-1===b.indexOf(a[c]))return!1;return!0},a.isCreditCard=function(a){var b=a.replace(/[^0-9]+/g,"");if(!m.test(b))return!1;for(var c,d,e,f=0,g=b.length-1;g>=0;g--)c=b.substring(g,g+1),d=parseInt(c,10),e?(d*=2,f+=d>=10?d%10+1:d):f+=d,e=!e;return!!(f%10===0?b:!1)},a.isISIN=function(a){if(!n.test(a))return!1;for(var b,c,d=a.replace(/[A-Z]/g,function(a){return parseInt(a,36)}),e=0,f=!0,g=d.length-2;g>=0;g--)b=d.substring(g,g+1),c=parseInt(b,10),f?(c*=2,e+=c>=10?c+1:c):e+=c,f=!f;return parseInt(a.substr(a.length-1),10)===(1e4-e)%10},a.isISBN=function(b,c){if(c=c?c+"":"",!c)return a.isISBN(b,10)||a.isISBN(b,13);var d,e=b.replace(/[\s-]+/g,""),f=0;if("10"===c){if(!o.test(e))return!1;for(d=0;9>d;d++)f+=(d+1)*e.charAt(d);if(f+="X"===e.charAt(9)?100:10*e.charAt(9),f%11===0)return!!e}else if("13"===c){if(!p.test(e))return!1;var g=[1,3];for(d=0;12>d;d++)f+=g[d%2]*e.charAt(d);if(e.charAt(12)-(10-f%10)%10===0)return!!e}return!1},a.isMobilePhone=function(a,b){return b in K?K[b].test(a):!1};var Q={symbol:"$",require_symbol:!1,allow_space_after_symbol:!1,symbol_after_digits:!1,allow_negatives:!0,parens_for_negatives:!1,negative_sign_before_digits:!1,negative_sign_after_digits:!1,allow_negative_sign_placeholder:!1,thousands_separator:",",decimal_separator:".",allow_space_after_digits:!1};a.isCurrency=function(a,b){return b=e(b,Q),f(b).test(a)},a.isJSON=function(a){try{var b=JSON.parse(a);return!!b&&"object"==typeof b}catch(c){}return!1},a.isMultibyte=function(a){return F.test(a)},a.isAscii=function(a){return E.test(a)},a.isFullWidth=function(a){return G.test(a)},a.isHalfWidth=function(a){return H.test(a)},a.isVariableWidth=function(a){return G.test(a)&&H.test(a)},a.isSurrogatePair=function(a){return I.test(a)},a.isBase64=function(a){return J.test(a)},a.isMongoId=function(b){return a.isHexadecimal(b)&&24===b.length},a.isISO8601=function(a){return L.test(a)},a.ltrim=function(a,b){var c=b?new RegExp("^["+b+"]+","g"):/^\s+/g;return a.replace(c,"")},a.rtrim=function(a,b){var c=b?new RegExp("["+b+"]+$","g"):/\s+$/g;return a.replace(c,"")},a.trim=function(a,b){var c=b?new RegExp("^["+b+"]+|["+b+"]+$","g"):/^\s+|\s+$/g;return a.replace(c,"")},a.escape=function(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\//g,"&#x2F;").replace(/\`/g,"&#96;")},a.stripLow=function(b,c){var d=c?"\\x00-\\x09\\x0B\\x0C\\x0E-\\x1F\\x7F":"\\x00-\\x1F\\x7F";return a.blacklist(b,d)},a.whitelist=function(a,b){return a.replace(new RegExp("[^"+b+"]+","g"),"")},a.blacklist=function(a,b){return a.replace(new RegExp("["+b+"]+","g"),"")};var R={lowercase:!0,remove_dots:!0,remove_extension:!0};return a.normalizeEmail=function(b,c){if(c=e(c,R),!a.isEmail(b))return!1;var d=b.split("@",2);if(d[1]=d[1].toLowerCase(),"gmail.com"===d[1]||"googlemail.com"===d[1]){if(c.remove_extension&&(d[0]=d[0].split("+")[0]),c.remove_dots&&(d[0]=d[0].replace(/\./g,"")),!d[0].length)return!1;d[0]=d[0].toLowerCase(),d[1]="gmail.com"}else c.lowercase&&(d[0]=d[0].toLowerCase());return d.join("@")},a.init(),a})},{depd:64}]},{},[31])(31)});